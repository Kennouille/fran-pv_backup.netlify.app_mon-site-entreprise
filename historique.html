<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="page_title1">Historique des Modifications</title>
  <link rel="stylesheet" href="historique.css">
  <script src="guard.js"></script>
</head>
<body>
  <div class="container">
    <!-- üîπ En-t√™te -->
    <h1 data-i18n="header_title">Historique des Modifications</h1>
    <p id="totalEvents" class="total-events"></p>

    <!-- üîç Barre de recherche simplifi√©e -->
    <div class="filters">
      <input
        type="text"
        id="searchGlobal"
        placeholder="Rechercher par Nom, T√©l√©phone ou Lieu"
        data-i18n-placeholder="placeholder_search_global">

      <input
        type="date"
        id="searchDate"
        data-i18n-placeholder="placeholder_search_date">

      <button id="applySearch" data-i18n="button_apply">Appliquer</button>
    </div>

    <!-- üìä R√©sultats de recherche -->
    <div id="resultsSection" style="margin-top:20px;">
      <p id="resultsCount" class="results-count"></p>
      <table id="resultsTable">
        <thead>
          <tr>
            <th data-i18n="col_phone">T√©l√©phone</th>
            <th data-i18n="col_name">Nom</th>
            <th data-i18n="col_event_date">Date de l'√©v√©nement</th>
            <th data-i18n="col_userid">Identifiant</th>
            <th data-i18n="col_location">Lieu</th>
            <th data-i18n="col_details">D√©tails</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="noResultsMessage" data-i18n="no_results" style="display:none;">Aucun r√©sultat trouv√©</p>
    </div>

    <!-- üìä Historique r√©cent -->
    <div id="recentSection" style="margin-top:40px;">
      <h2 data-i18n="recent_changes">10 derni√®res modifications</h2>
      <table id="recentTable">
        <thead>
          <tr>
            <th data-i18n="col_phone">T√©l√©phone</th>
            <th data-i18n="col_name">Nom</th>
            <th data-i18n="col_event_date">Date de l'√©v√©nement</th>
            <th data-i18n="col_userid">Identifiant</th>
            <th data-i18n="col_location">Lieu</th>
            <th data-i18n="col_details">D√©tails</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <!-- üìå Modal pour les d√©tails -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 data-i18n="details_header">D√©tails des changements</h2>
      <table class="detail-table">
        <thead>
          <tr>
            <th data-i18n="col_change_date">Date du changement</th>
            <th data-i18n="col_modified_by">Modifi√© par</th>
            <th data-i18n="col_action">Action</th>
            <th data-i18n="col_field">Champ</th>
            <th data-i18n="col_old_value">Valeur ancienne</th>
            <th data-i18n="col_new_value">Valeur nouvelle</th>
          </tr>
        </thead>
        <tbody id="detailTableBody"></tbody>
      </table>
    </div>
  </div>


  <script type="module">
  import { supabase } from './supabaseClientAgendaJour.js';

  const resultsBody = document.querySelector("#resultsTable tbody");
  const recentBody = document.querySelector("#recentTable tbody");
  const resultsCount = document.getElementById("resultsCount");
  const noResultsMessage = document.getElementById("noResultsMessage");

  const modal = document.getElementById("detailModal");
  const closeBtn = modal.querySelector(".close");
  const detailTableBody = document.getElementById("detailTableBody");

  // üîπ Traduction
  let translations = {};
  let currentLang = localStorage.getItem("lang") || "fr";

  async function loadTranslations(lang) {
    const response = await fetch(`./lang/${lang}.json`);
    translations = await response.json();
    applyTranslations();
  }

  function applyTranslations() {
    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      if (translations[key]) el.textContent = translations[key];
    });
    document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
      const key = el.getAttribute("data-i18n-placeholder");
      if (translations[key]) el.placeholder = translations[key];
    });
  }

  // üîπ Compteur global (Ajout = total √©v√©nements)
  async function loadTotalEvents() {
    const { count, error } = await supabase
      .from("historique_modif_fran")
      .select("*", { count: "exact", head: true })
      .eq("action", "Ajout");

    if (error) {
      console.error("Erreur r√©cup√©ration du nombre d'√©v√©nements :", error);
      return;
    }

    document.getElementById("totalEvents").textContent = translations["total_events"]
      ? translations["total_events"].replace("{count}", count || 0)
      : `Nombre total d'√©v√©nements : ${count || 0}`;
  }


  // üîπ Formatage
  function formatValue(value) {
    if (value === null || value === undefined || value === "") return "-";

    // ‚úÖ Si c‚Äôest du JSON ‚Üí on n‚Äôaffiche pas le blob complet
    if (typeof value === "string") {
      try {
        const parsed = JSON.parse(value);
        if (typeof parsed === "object") {
          return "[donn√©es multiples]"; // ou Object.keys(parsed).join(", ")
        }
      } catch (e) {}
    }

    if (typeof value === "string" && value.startsWith("http")) {
      return `<img src="${value}" style="max-height:40px;">`;
    }
    if (value === true || value === "true" || value === "TRUE") return "‚úÖ";
    if (value === false || value === "false" || value === "FALSE") return "";
    return value;
  }


  // üîπ Rendu tableau (r√©utilisable avec traductions)
  async function renderTable(rows, targetBody) {
      targetBody.innerHTML = "";

      for (const [userId, group] of Object.entries(rows)) {
        const { data: eventData, error: eventError } = await supabase
          .from("event_quot1_fran")
          .select("Nom,Date,Heure,Min,Lieu,T√©l√©phone")
          .eq("user_id", userId);

        if (eventError) {
          console.error("Erreur r√©cup√©ration donn√©es √©v√©nement:", eventError);
          continue;
        }

        const event = eventData?.[0] || null;

        // ‚úÖ On traduit la derni√®re action et champ de l'historique (si dispo)
        let lastAction = "-";
        let lastField = "-";
        if (group.length > 0) {
          const last = group[0]; // la plus r√©cente (car d√©j√† tri√© DESC)
          lastAction = translateAction(last.action);
          lastField = translateField(last.champ_modifi√©);
        }

        // üîπ CORRECTION : Utiliser le vrai compte stock√© ou group.length
        const modificationCount = group[0]?._modificationCount || group.length;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${event?.T√©l√©phone || "-"}</td>
          <td>${event?.Nom || "-"}</td>
          <td>${event ? `${event.Date || ""} ${event.Heure || ""}:${event.Min || ""}` : "-"}</td>
          <td>${userId}</td>
          <td>${event?.Lieu || "-"}</td>
          <td>
            <button class="detailBtn">
              ${translations["button_view"] || "Voir"} (${modificationCount})
            </button>
          </td>
        `;

        tr.querySelector(".detailBtn").addEventListener("click", () => {
          // üîπ CORRECTION : Charger TOUTES les modifications pour cet user_id
          loadAllModificationsForUser(userId, group);
        });

        targetBody.appendChild(tr);
      }
  }

  // üîπ NOUVELLE FONCTION : Charger toutes les modifications d'un user_id
  async function loadAllModificationsForUser(userId, currentGroup) {
      const { data: allModifications, error } = await supabase
        .from("historique_modif_fran")
        .select("*")
        .eq("user_id", userId)
        .order("date_modification", { ascending: false });

      if (error) {
          console.error("Erreur chargement modifications compl√®tes:", error);
          // Fallback : utiliser les donn√©es actuelles
          showDetails(currentGroup);
          return;
      }

      showDetails(allModifications);
  }


  // üîπ Recherche
  async function searchHistorique() {
    const searchText = document.getElementById("searchGlobal").value.trim();
    const searchDate = document.getElementById("searchDate").value;

    let query = supabase
      .from("historique_modif_fran")
      .select("*")
      .order("date_modification", { ascending: false });

    // Filtre par date (√©v√©nement)
    if (searchDate) {
      const { data: eventIds, error: eventError } = await supabase
        .from("event_quot1_fran")
        .select("user_id")
        .eq("Date", searchDate);

      if (eventError) {
        console.error("Erreur recherche par date:", eventError);
        return;
      }
      const ids = eventIds.map(e => e.user_id);
      if (ids.length > 0) {
        query = query.in("user_id", ids);
      } else {
        resultsBody.innerHTML = "";
        resultsCount.textContent = translations["results_count"]
          ? translations["results_count"].replace("{count}", 0)
          : "Nombre de r√©sultats trouv√©s : 0";
        noResultsMessage.textContent = translations["no_results"] || "Aucun r√©sultat trouv√©";
        noResultsMessage.style.display = "block";
        return;
      }
    }

    // Filtre global (Nom / T√©l√©phone / Lieu)
    if (searchText) {
      const { data: eventIds, error: eventError } = await supabase
        .from("event_quot1_fran")
        .select("user_id")
        .or(`Nom.ilike.%${searchText}%,T√©l√©phone.ilike.%${searchText}%,Lieu.ilike.%${searchText}%`);

      if (eventError) {
        console.error("Erreur recherche globale:", eventError);
        return;
      }
      const ids = eventIds.map(e => e.user_id);
      if (ids.length > 0) {
        query = query.in("user_id", ids);
      } else {
        resultsBody.innerHTML = "";
        resultsCount.textContent = translations["results_count"]
          ? translations["results_count"].replace("{count}", 0)
          : "Nombre de r√©sultats trouv√©s : 0";
        noResultsMessage.textContent = translations["no_results"] || "Aucun r√©sultat trouv√©";
        noResultsMessage.style.display = "block";
        return;
      }
    }

    const { data: histoData, error } = await query;
    if (error) {
      console.error("Erreur chargement historique:", error);
      return;
    }

    if (!histoData || histoData.length === 0) {
      resultsBody.innerHTML = "";
      resultsCount.textContent = translations["results_count"]
        ? translations["results_count"].replace("{count}", 0)
        : "Nombre de r√©sultats trouv√©s : 0";
      noResultsMessage.textContent = translations["no_results"] || "Aucun r√©sultat trouv√©";
      noResultsMessage.style.display = "block";
      return;
    }

    noResultsMessage.style.display = "none";

    // Grouper par user_id
    const grouped = {};
    histoData.forEach(r => {
      if (!grouped[r.user_id]) grouped[r.user_id] = [];
      grouped[r.user_id].push(r);
    });

    resultsCount.textContent = translations["results_count"]
      ? translations["results_count"].replace("{count}", Object.keys(grouped).length)
      : `Nombre de r√©sultats trouv√©s : ${Object.keys(grouped).length}`;
    renderTable(grouped, resultsBody);
  }


  // üîπ Historique r√©cent (10 derniers user_id modifi√©s)
async function loadRecent() {
    // On r√©cup√®re les 100 derniers changements (pour avoir assez de mati√®re)
    const { data: histoData, error } = await supabase
      .from("historique_modif_fran")
      .select("*")
      .order("date_modification", { ascending: false })
      .limit(100);

    if (error) {
      console.error("Erreur chargement des 10 derniers √©v√©nements:", error);
      return;
    }

    if (!histoData || histoData.length === 0) {
      recentBody.innerHTML = "";
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="6">${translations["no_recent"] || "Aucun √©v√©nement r√©cent"}</td>`;
      recentBody.appendChild(tr);
      return;
    }

    // Grouper par user_id et garder la date la plus r√©cente
    const userMap = new Map();
    histoData.forEach(r => {
      if (!userMap.has(r.user_id) || new Date(r.date_modification) > new Date(userMap.get(r.user_id).latestDate)) {
        userMap.set(r.user_id, {
          latestDate: r.date_modification,
          sampleRow: r // On garde une ligne pour les infos de base
        });
      }
    });

    // Prendre les 10 user_id les plus r√©cents
    const last10Users = Array.from(userMap.entries())
      .sort((a, b) => new Date(b[1].latestDate) - new Date(a[1].latestDate))
      .slice(0, 10);

    // üîπ CORRECTION : R√©cup√©rer le VRAI nombre de modifications pour chaque user_id
    const userDataWithCounts = await Promise.all(
      last10Users.map(async ([userId, data]) => {
        // Requ√™te s√©par√©e pour avoir le compte exact
        const { count, error: countError } = await supabase
          .from("historique_modif_fran")
          .select("*", { count: 'exact', head: true })
          .eq("user_id", userId);

        if (countError) {
          console.error("Erreur comptage pour", userId, countError);
          return { ...data, userId, modificationCount: 1 }; // Fallback
        }

        return {
          ...data,
          userId,
          modificationCount: count || 1
        };
      })
    );

    // Pr√©parer les donn√©es pour renderTable
    const recentData = {};
    userDataWithCounts.forEach(user => {
      // On cr√©e un tableau avec une seule ligne (pour l'affichage) mais avec le vrai compte
      recentData[user.userId] = [{
        ...user.sampleRow,
        _modificationCount: user.modificationCount // On stocke le vrai compte
      }];
    });

    renderTable(recentData, recentBody);
  }

  // --------------------------------------------------------------------------

  function translateValue(field, value) {
    if (!value || value === "EMPTY" || value === "-") return "-";

    // ‚úÖ Gestion des valeurs bool√©ennes
    if (value === true || value === "true") return "‚úÖ";
    if (value === false || value === "false") return "-";

    // ‚úÖ CORRECTION : Si c'est un objet JSON, retourner "-" ou une valeur simplifi√©e
    if (typeof value === "object" || (typeof value === "string" && value.includes("{"))) {
        return "-"; // ou return "Donn√©es Travail" si vous pr√©f√©rez
    }

    const f = field.toLowerCase();

    // Champ Heure ‚Üí garder le format tel quel
    if (["heure", "time", "hora"].includes(f)) {
      return value.toString();
    }

    // Champ Min
    if (["min"].includes(f)) {
      return value.toString();
    }

    // Par d√©faut, on renvoie la valeur brute
    return value;
  }

  // Helpers pour traduire actions et champs
  function translateAction(action) {
      if (!action) return "-";
      const a = action.toLowerCase();
      if (["cr√©ation", "ajout", "creation", "add"].includes(a)) {
        return translations["action_creation"] || "Cr√©ation";
      }
      if (["modification", "update"].includes(a)) {
        return translations["action_update"] || "Modification";
      }
      if (["suppression", "delete", "deletion"].includes(a)) {
        return translations["action_delete"] || "Suppression";
      }
      return action;
  }

  function translateField(field) {
    if (!field) return "-";
    const f = field.toLowerCase();

    if (["√©v√©nement", "evento", "event"].includes(f)) return translations["field_event"] || "√âv√©nement";
    if (["travail", "work", "trabajo"].includes(f)) return translations["field_work"] || "Travail";
    if (f.startsWith("travail.") || f.startsWith("work.") || f.startsWith("trabajo.")) {
      const sub = f.split(".")[1];

      // Utiliser les cl√©s de traduction existantes
      switch (sub) {
        case "se_aspire": return translations["field_work_se_aspire"] || "Aspir√©";
        case "se_cepillo": return translations["field_work_se_cepillo"] || "Bross√©";
        case "recogio_hojas": return translations["field_work_recogio_hojas"] || "Feuilles ramass√©es";
        case "cl_libre": return translations["field_work_cl_libre"] || "Chlore libre";
        case "cl_total": return translations["field_work_cl_total"] || "Chlore total";
        case "cloro": return translations["field_work_cloro"] || "Chlore";
        case "ph": return translations["field_work_ph"] || "pH";
        case "timer": return translations["field_work_timer"] || "Minuteur";
        case "cl_combinado": return translations["field_work_cl_combinado"] || "Chlore combin√©";
        case "ph_expert": return translations["field_work_ph_expert"] || "pH (expert)";
        case "alcalinidad_total": return translations["field_work_alcalinidad_total"] || "Alcalinit√© totale";
        case "dureza": return translations["field_work_dureza"] || "Duret√©";
        case "tds": return translations["field_work_tds"] || "TDS";
        case "temperatura": return translations["field_work_temp"] || "Temp√©rature";
        default: return (translations["field_work"] || "Travail") + ` - ${sub}`;
      }
    }

    if (["lieu", "location", "lugar"].includes(f)) return translations["field_location"] || "Lieu";
    if (["nom", "name", "nombre"].includes(f)) return translations["field_name"] || "Nom";
    if (["t√©l√©phone", "telefono", "phone"].includes(f)) return translations["field_phone"] || "T√©l√©phone";
    if (["date"].includes(f)) return translations["field_date"] || "Date";
    if (["heure", "time", "hora"].includes(f)) return translations["field_time"] || "Heure";
    if (["min"].includes(f)) return translations["field_min"] || "Min";
    if (["observations", "observaciones"].includes(f)) return translations["field_observations"] || "Observations";

    if (["pay√©", "paid", "pagado"].includes(f)) return translations["field_paid"] || "Pay√©";
    if (["env_donn√©es", "data_sent", "datos_enviados"].includes(f)) return translations["field_data_sent"] || "Donn√©es envoy√©es";
    if (["ajout√©_pour", "added_for", "a√±adido_para"].includes(f)) return translations["field_added_for"] || "Ajout√© pour";

    if (typeof field === "object" || field.includes("{")) {
        return translations["field_work"] || "Travail";
    }

    return field;
  }

  // üîπ Modal d√©tails (version corrig√©e)
  function showDetails(rows) {
      detailTableBody.innerHTML = "";
      rows.forEach(r => {
        let action = translateAction(r.action);
        let field = translateField(r.champ_modifi√©);

        let ancienne = translateValue(r.champ_modifi√©, r.valeur_ancienne);
        let nouvelle = translateValue(r.champ_modifi√©, r.valeur_nouvelle);

        // ‚úÖ CORRECTION : Gestion sp√©ciale pour Cr√©ation/Suppression
        if (r.action === "Cr√©ation" || r.action === "Ajout" || r.action === "Creation" || r.action === "Add") {
          action = translations["action_creation"] || "Cr√©ation";
          ancienne = "-";
          nouvelle = translations["field_event"] || "√âv√©nement";
        }
        if (r.action === "Suppression" || r.action === "Delete" || r.action === "Deletion") {
          action = translations["action_delete"] || "Suppression";
          ancienne = translations["field_event"] || "√âv√©nement";
          nouvelle = translations["action_delete"] || "Suppression";
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(r.date_modification).toLocaleString()}</td>
          <td>${r.modifi√©_par || "-"}</td>
          <td>${action}</td>
          <td>${field}</td>
          <td>${ancienne}</td>
          <td>${nouvelle}</td>
        `;
        detailTableBody.appendChild(tr);
      });
      modal.style.display = "flex";
  }



  closeBtn.onclick = () => modal.style.display = "none";
  window.onclick = (event) => { if (event.target === modal) modal.style.display = "none"; };

  // üîπ √âcouteurs
  document.getElementById("applySearch").addEventListener("click", searchHistorique);
  document.getElementById("searchGlobal").addEventListener("keypress", (e) => {
    if (e.key === "Enter") searchHistorique();
  });
  document.getElementById("searchDate").addEventListener("keypress", (e) => {
    if (e.key === "Enter") searchHistorique();
  });

  // ‚úÖ Chargement initial
  await loadTranslations(currentLang);
  await loadTotalEvents();
  await loadRecent();
  </script>

</body>
</html>
