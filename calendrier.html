<!DOCTYPE html>
<html lang="fr">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="page_title_daily_calendar_agenda">Calendrier et Agenda Quotidien</title>
    <style>
        #noteText {
            width: 100%; /* Largeur compl√®te */
            height: 100px; /* Hauteur maximale */
            overflow-y: auto; /* D√©filement vertical si n√©cessaire */
            resize: none; /* D√©sactive le redimensionnement manuel */
        }
    </style>
    <link rel="stylesheet" href="calendrier.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script type="text/javascript">
        // Place ta fonction `openEditModal` ici
        async function openEditModal(date, notes = "") {

            // 1. D'abord, assurez-vous que la modale est visible
            const editNoteModal = document.getElementById('editNoteModal');
            if (!editNoteModal) {
                console.error("Erreur: L'√©l√©ment '#editNoteModal' est introuvable. Impossible d'ouvrir la modale.");
                return;
            }

            // 2. Ensuite, manipulez les √©l√©ments internes
            const modalDateElement = document.getElementById('modalDate');
            if (modalDateElement) {
                modalDateElement.textContent = date;
            } else {
                console.error("Erreur: L'√©l√©ment '#modalDate' est introuvable √† l'int√©rieur de la modale. La date ne peut pas √™tre affich√©e.");
            }

            // 3. R√©cup√©ration asynchrone des notes de la base de donn√©es
            // On charge la note par d√©faut (type 1)
            const notesFromDB = await loadDailyNoteForDate(date, 1);

            const noteTextElement = document.getElementById('noteText');
            if (noteTextElement) {
                // Affiche la note de la base de donn√©es si elle existe, sinon utilise la valeur par d√©faut.
                noteTextElement.value = notesFromDB || notes;
            } else {
                console.error("Erreur: L'√©l√©ment '#noteText' est introuvable √† l'int√©rieur de la modale.");
            }

            // 4. Affiche la modale une fois que le contenu est charg√©
            editNoteModal.style.display = 'block';
        }

        async function loadDailyNoteForDate(date) {
            try {
                // R√©cup√©rer toutes les notes pour la date sp√©cifi√©e
                const { data: notes, error } = await supabase
                    .from('daily_notes1_fran')
                    .select('notes, type, todo_notes') // Assurez-vous d'inclure 'todo_notes'
                    .eq('date', date);

                if (error) {
                    console.error('error_fetching_notes', error);
                    return;
                }

                const noteTextElement = document.getElementById('noteText');
                const todoList = document.getElementById('todoList');
                let noteToDisplay = null;

                // Chercher la note normale (type 1) ou la to-do liste (type 3)
                if (notes && notes.length > 0) {
                    noteToDisplay = notes.find(note => note.type === 1) || notes.find(note => note.type === 3);
                }

                // Si une note est trouv√©e, afficher selon son type
                if (noteToDisplay) {
                    if (noteToDisplay.type === 1) { // Note normale
                        noteTextElement.value = noteToDisplay.notes;
                        setNoteType(1);
                    } else if (noteToDisplay.type === 3) { // To-do Liste
                        todoList.innerHTML = ''; // Vider la liste pr√©c√©dente
                        const todos = JSON.parse(noteToDisplay.todo_notes); // Parse le JSON de la to-do liste
                        todos.forEach(item => {
                            const li = document.createElement('li');
                            li.innerHTML = `<input type="checkbox" ${item.completed ? 'checked' : ''}> <span>${item.text}</span>`;
                            todoList.appendChild(li);
                        });
                        setNoteType(3);
                    }
                } else {
                    // Si aucune note n'est trouv√©e pour cette date
                    noteTextElement.value = "";
                    setNoteType(1); // Par d√©faut, afficher la note normale
                }

                document.getElementById('editNoteModal').style.display = 'block'; // Ouvre la modale

            } catch (error) {
                console.error('error_unexpected_colon', error);
                document.getElementById('noteText').value = "";
                document.getElementById('editNoteModal').style.display = 'block'; // Ouvre la modale m√™me en cas d'erreur
            }
        }


        // Fonction pour g√©rer le changement de date
        function handleDateChange(newDate) {
            document.getElementById('modalDate').textContent = newDate;
            loadDailyNoteForDate(newDate, 1);
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
      (function() {
        emailjs.init("6lA9Rhqjaqkd15zS7"); // ‚ö° ta Public Key
      })();
    </script>


    <script type="module">
        import { supabase } from './supabaseClientAgendaJour.js';

        // Variables globales (assurez-vous qu'elles sont d√©clar√©es une seule fois dans votre fichier)
        let translations = {};
        let currentLang = 'fr'; // Valeur par d√©faut, sera mise √† jour au chargement de la langue
        let monthNames = []; // Sera rempli par loadLanguage
        var currentMonth = new Date().getMonth();
        var currentYear = new Date().getFullYear();
        var event = {}; // Objet pour stocker les √©v√©nements par date
        let employeeNames = []; // variable globale
        let evenementsRecherche = null; // null = pas de recherche
        let currentSearchFilter = "";
        let isProgrammaticClick = false;
        const isConfigUser = localStorage.getItem('currentPersonIsConfigUser') === 'true';
        let isFetchingEvents = false;

        // =======================================================
        // UTILITAIRES DE SYNCHRONISATION ET HORS LIGNE
        // =======================================================

        // Constantes pour la file d'attente hors ligne
        const OFFLINE_QUEUE_KEY = 'offline_queue';

        /**
         * V√©rifie l'√©tat de la connexion Internet.
         * @returns {boolean} True si en ligne, False sinon.
         */
        function isOnline() {
            return navigator.onLine;
        }

        /**
         * Ajoute une op√©ration √† la file d'attente locale (simul√©e avec LocalStorage
         * pour la simplicit√©, mais id√©alement IndexedDB).
         * @param {Object} operation - L'objet de la requ√™te √† enregistrer.
         */
        async function addToQueue(operation) {
            console.log(`[IDB/Queue] Tentative d'ajout √† la file d'attente:`, operation);

            // --- D√©but de la SIMULATION (Remplacez par IndexedDB en production) ---
            try {
                const queue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');

                // Assure un ID unique et horodatage
                operation.id = Date.now() + Math.random().toString(36).substring(2, 9);
                operation.timestamp = Date.now();

                queue.push(operation);
                localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));

                console.log(`[IDB/Queue] Op√©ration ajout√©e avec succ√®s. Taille de la file: ${queue.length}`);
            } catch (e) {
                console.error("[IDB/Queue] Erreur lors de l'ajout √† la file d'attente:", e);
            }
            // --- Fin de la SIMULATION ---
        }

        // NOTE: Vous pouvez supprimer la d√©claration vide car syncData est d√©finie ci-dessous.

        // =======================================================
        // AJOUT DE SIMULATIONS POUR LIRE ET SUPPRIMER LA QUEUE LOCALE
        // =======================================================

        /**
         * R√©cup√®re toutes les op√©rations en attente (simul√©e).
         * @returns {Array<Object>} La liste des op√©rations ordonn√©es par timestamp.
         */
        async function getQueue() {
            try {
                const queue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
                // üí° Toujours trier par timestamp pour garantir l'ordre chronologique
                return queue.sort((a, b) => a.timestamp - b.timestamp);
            } catch (e) {
                console.error("[IDB/Queue] Erreur lors de la r√©cup√©ration de la file:", e);
                return [];
            }
        }

        /**
         * Supprime une op√©ration sp√©cifique de la file (simul√©e).
         * @param {string} id - L'ID de l'op√©ration √† supprimer.
         */
        async function deleteFromQueue(id) {
            try {
                let queue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
                const initialLength = queue.length;

                queue = queue.filter(op => op.id !== id);
                localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));

                console.log(`[IDB/Queue] Op√©ration ${id} supprim√©e. ${initialLength - queue.length} √©l√©ment(s) retir√©(s).`);
            } catch (e) {
                console.error("[IDB/Queue] Erreur lors de la suppression de l'op√©ration:", e);
            }
        }


        // =======================================================
        // FONCTION DE SYNCHRONISATION PRINCIPALE (syncData)
        // =======================================================

        // Variable pour s'assurer qu'une seule synchronisation est en cours d'ex√©cution √† la fois
        let isSyncing = false;

        /**
         * Tente de synchroniser toutes les modifications locales avec Supabase.
         */
        async function syncData() { // C'est la seule d√©claration de syncData maintenant.
            if (isSyncing || !isOnline()) {
                console.log(`[Sync] Synchronisation ignor√©e (D√©j√† en cours ou hors ligne).`);
                return;
            }

            isSyncing = true;
            console.log("üöÄ D√©but de la synchronisation des donn√©es locales.");

            const queue = await getQueue();
            if (queue.length === 0) {
                isSyncing = false;
                console.log("‚úÖ File d'attente locale vide. Synchronisation termin√©e.");
                return;
            }

            let successCount = 0;
            let failCount = 0;

            for (const operation of queue) {
                try {
                    if (operation.type === 'UPDATE') {

                        // Extraction des param√®tres de la requ√™te
                        const { targetTable, targetId, payload } = operation;
                        const targetKeys = Object.keys(targetId);

                        if (targetKeys.length === 0) {
                             throw new Error("ID de cible manquant pour la mise √† jour.");
                        }

                        // Construction de la clause WHERE
                        let query = supabase.from(targetTable).update(payload);

                        targetKeys.forEach(key => {
                            query = query.eq(key, targetId[key]);
                        });

                        // üö® Ex√©cution de la requ√™te Supabase
                        const { error } = await query;

                        if (error) {
                            console.error(`‚ùå √âchec API sur ${targetTable} (ID: ${operation.id}). Arr√™t de la file.`, error);
                            failCount++;
                            break;
                        }

                        // Succ√®s: suppression de l'op√©ration de la file locale
                        await deleteFromQueue(operation.id);
                        successCount++;

                    } else {
                        console.warn(`[Sync] Type d'op√©ration inconnu : ${operation.type}. Suppression.`);
                        await deleteFromQueue(operation.id);
                    }

                } catch (e) {
                    console.error(`‚ùå Erreur critique lors du traitement de l'op√©ration ${operation.id}. Arr√™t de la file.`, e);
                    failCount++;
                    break;
                }
            }

            isSyncing = false;
            console.log(`\nüéâ Synchronisation termin√©e : ${successCount} succ√®s, ${failCount} √©checs. Reste ${queue.length - successCount} √©l√©ment(s) en attente.`);
        }

        // ‚úÖ Fonction unique pour les dates locales (√† mettre au d√©but de votre code)
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function loadEmployees() {
          const { data, error } = await supabase
            .from("access_code1_fran")
            .select("Nom"); // On r√©cup√®re seulement la colonne Nom

          if (error) {
            console.error("Erreur r√©cup√©ration employ√©s:", error);
            return;
          }

          // On garde le tableau simple de noms
          employeeNames = data.map(emp => emp.Nom);
          console.log("Noms des employ√©s r√©cup√©r√©s :", employeeNames);
        }

        // Fonction pour peupler le select des employ√©s
        async function populateEmployeSelect() {
            try {
                // Utilisez votre fonction existante
                await loadEmployees();

                const select = document.getElementById('employeSelect');
                if (select && employeeNames && employeeNames.length > 0) {
                    // Vider les options existantes (sauf la premi√®re)
                    select.innerHTML = '<option value="">-- S√©lectionner un employ√© --</option>';

                    // Ajouter chaque employ√©
                    employeeNames.forEach(employeName => {
                        const option = document.createElement('option');
                        option.value = employeName; // Utilisez le nom comme valeur
                        option.textContent = employeName;
                        select.appendChild(option);
                    });

                    console.log('‚úÖ Select des employ√©s peupl√© avec succ√®s');
                } else {
                    console.log('‚ùå Aucun employ√© trouv√© ou select non disponible');
                }
            } catch (error) {
                console.error('Erreur dans populateEmployeSelect:', error);
            }
        }



        function formatDateLocal(date) {
            return date.getFullYear() + "-" +
                String(date.getMonth() + 1).padStart(2, '0') + "-" +
                String(date.getDate()).padStart(2, '0');
        }

        function generateUUID() {
          return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
          );
        }


        function normalizeToMidnight(date) {
            return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        }

        function parseLocalDate(dateStr) {
            const [year, month, day] = dateStr.split("-").map(Number);
            return new Date(year, month - 1, day); // ‚ö° construit en LOCAL
        }

        async function generateRecurrenceDatesWithLoading(startDate, rule) {
            const indicator = document.getElementById("loading-indicator");
            if (indicator) indicator.style.display = "block"; // montrer

            // Petite pause pour que le DOM rafra√Æchisse l‚Äôaffichage du message
            await new Promise(resolve => setTimeout(resolve, 50));

            let results;
            try {
                results = generateRecurrenceDates(startDate, rule);
            } finally {
                if (indicator) indicator.style.display = "none"; // cacher
            }
            return results;
        }

        // ==========================================
        // VARIABLES GLOBALES ET CONFIGURATION
        // ==========================================

        // Variables anti-rebond pour √©viter les appels multiples
        let isGeneratingCalendar = false;
        let isLoadingDailyNotes = false;


        // ==========================================
        // FONCTIONS AVEC PROTECTION ANTI-REBOND
        // ==========================================

        async function generateCalendar(month, year, evenementsTrouves = []) {
            if (isGeneratingCalendar) {
                console.log("‚è≥ generateCalendar d√©j√† en cours, ignor√©");
                return;
            }

            isGeneratingCalendar = true;
            try {
                console.log("üîÑ generateCalendar d√©marr√©");

                console.log('generateCalendar called');
                const today = new Date();
                const todayFormatted = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                const calendarTable = document.getElementById('calendarTable');
                const monthYearDisplay = document.getElementById('monthYear');
                calendarTable.innerHTML = `
                    <tr>
                        <th data-i18n="day_mon_short">Lu</th>
                        <th data-i18n="day_tue_short">Ma</th>
                        <th data-i18n="day_wed_short">Me</th>
                        <th data-i18n="day_thu_short">Je</th>
                        <th data-i18n="day_fri_short">Ve</th>
                        <th data-i18n="day_sat_short">Sa</th>
                        <th data-i18n="day_sun_short">Di</th>
                    </tr>
                `;

                // Traduire les en-t√™tes
                calendarTable.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (translations[key]) {
                        element.textContent = translations[key];
                    }
                });

                monthYearDisplay.textContent = `${monthNames[month]} ${year}`;

                const firstDay = (new Date(year, month).getDay() + 6) % 7;
                const daysInMonth = 32 - new Date(year, month, 32).getDate();
                let date = 1;

                for (let i = 0; i < 6; i++) {
                    let row = document.createElement('tr');

                    for (let j = 0; j < 7; j++) {
                        if (i === 0 && j < firstDay) {
                            let cell = document.createElement('td');
                            row.appendChild(cell);
                        } else if (date > daysInMonth) {
                            break;
                        } else {
                            let cell = document.createElement('td');
                            cell.classList.add('clickable');

                            // Date YYYY-MM-DD
                            const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                            cell.setAttribute('data-date', formattedDate);
                            cell.appendChild(document.createTextNode(date));
                            cell.addEventListener('click', handleDateClick);

                            // ‚úÖ Garde la couleur du jour actuel
                            if (formattedDate === todayFormatted) {
                                cell.classList.add('today');
                            }

                            // ‚úÖ Ajoute la couleur si cette date est dans les √©v√©nements trouv√©s
                            if (Array.isArray(evenementsTrouves) && evenementsTrouves.length > 0) {
                                console.log("Dates trouv√©es :", evenementsTrouves.map(evt => evt.Date));

                                if (evenementsTrouves.some(evt => evt.Date.trim() === formattedDate)) {
                                    console.log("‚û°Ô∏è Highlight appliqu√© sur", formattedDate);
                                    cell.classList.add('highlight');
                                }
                            }

                            row.appendChild(cell);
                            date++;
                        }
                    }
                    calendarTable.appendChild(row);
                }
            } finally {
                isGeneratingCalendar = false;
            }
        }

        async function loadDailyNotes() {
            if (isLoadingDailyNotes) {
                console.log("‚è≥ loadDailyNotes d√©j√† en cours, ignor√©");
                return;
            }

            isLoadingDailyNotes = true;
            try {
                console.log("üîÑ loadDailyNotes d√©marr√©");

                console.log('--- Appel de la fonction loadDailyNotes() ---');
                const { data, error } = await supabase
                    .from('daily_notes1_fran')
                    .select('date, notes, type'); // Ajout de 'type'

                if (error) {
                    console.error('Erreur lors de la r√©cup√©ration des notes journali√®res :', error);
                    return;
                }

                console.log('Donn√©es r√©cup√©r√©es pour le calendrier :', data);

                data.forEach(note => {
                    const date = note.date;
                    const notes = note.notes;
                    const noteType = note.type;

                    const dayElement = document.getElementById(`day_${date}`);
                    if (dayElement) {
                        if (noteType === 1) {
                            dayElement.textContent = notes || 'Cliquer pour ajouter une note';
                            dayElement.classList.add('calendar-day-note');
                            dayElement.onclick = () => openEditModal(date, notes);
                        } else if (noteType === 3) {
                            dayElement.textContent = 'To-do Liste'; // Afficher un texte diff√©rent pour les to-do
                            dayElement.classList.add('calendar-day-todo');
                            // La logique pour le clic peut rester la m√™me, ou √™tre ajust√©e pour la to-do
                            dayElement.onclick = () => openEditModal(date, notes);
                        }
                    }
                });
                console.log('--- Fin de la fonction loadDailyNotes() ---');

            } finally {
                isLoadingDailyNotes = false;
            }
        }



        function generateRecurrenceDates(startDate, rule) {
            const results = [];
            if (!rule || rule.frequency === "none") {
                return [startDate];
            }

            // ‚ö°Ô∏è Toujours convertir en objet Date en LOCAL
            if (typeof startDate === "string") {
                startDate = parseLocalDate(startDate);
            } else {
                startDate = new Date(startDate);
            }
            startDate = normalizeToMidnight(startDate);

            const endDate = rule.endDate
                ? (typeof rule.endDate === "string" ? parseLocalDate(rule.endDate) : new Date(rule.endDate))
                : new Date(startDate);

            let current = new Date(startDate);

            const weekDays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const ruleDayIndices = (rule.days || []).map(dayName =>
                weekDays.indexOf(dayName.toLowerCase())
            );

            console.log("=== D√©but generateRecurrenceDates ===");
            console.log("startDate :", formatDateLocal(startDate), "(", weekDays[startDate.getDay()], ")");
            console.log("endDate   :", formatDateLocal(endDate));
            console.log("rule.days :", rule.days, "=> indices", ruleDayIndices);

            if (rule.frequency === "daily") {
                while (current <= endDate) {
                    results.push(formatDateLocal(current));
                    current.setDate(current.getDate() + 1);
                }
            }

            else if (rule.frequency === "weekly") {
                console.log("--- MODE WEEKLY ---");

                while (current <= endDate) {
                    const dayIndex = current.getDay();
                    const dayName = weekDays[dayIndex];

                    console.log("‚Üí V√©rif date :", formatDateLocal(current), "| jour :", dayName, "(", dayIndex, ")");

                    if (ruleDayIndices.includes(dayIndex)) {
                        console.log("‚úÖ Jour valide trouv√© :", dayName, "‚Üí ajout");
                        results.push(formatDateLocal(current));
                    } else {
                        console.log("‚ùå Jour non valide :", dayName, "‚Üí ignor√©");
                    }

                    current.setDate(current.getDate() + 1);
                }
            }

            else if (rule.frequency === "monthly") {
                while (current <= endDate) {
                    const temp = new Date(current);
                    temp.setDate(rule.dayOfMonth || current.getDate());
                    if (temp <= endDate) {
                        results.push(formatDateLocal(temp));
                    }
                    current.setMonth(current.getMonth() + 1);
                }
            }

            else if (rule.frequency === "yearly") {
                while (current <= endDate) {
                    const temp = new Date(current);
                    temp.setMonth((rule.month || temp.getMonth()) - 1);
                    temp.setDate(rule.day || temp.getDate());
                    if (temp <= endDate) {
                        results.push(formatDateLocal(temp));
                    }
                    current.setFullYear(current.getFullYear() + 1);
                }
            }

            console.log("R√©sultats g√©n√©r√©s :", results);
            console.log("=== Fin generateRecurrenceDates ===");

            return [...new Set(results)].sort();
        }

        // üÜï Fonction centralis√©e pour ins√©rer dans historique_modif_fran
        async function logModification({
          userId,
          rendezvousActuel = null,
          modifiePar,
          dateModification,
          champ,
          ancienneValeur,
          nouvelleValeur,
          action,
          nombre,
          telephone,
          extra = null
        }) {
          try {
            const entry = {
              user_id: userId,
              event_id: rendezvousActuel?.id || rendezvousActuel?.recurrence_id || null,
              modifi√©_par: modifiePar,
              date_modification: dateModification,
              champ_modifi√©: champ,
              valeur_ancienne: ancienneValeur ?? null,
              valeur_nouvelle: nouvelleValeur ?? null,
              action,
              Nombre: nombre,
              Telefono: telephone,
              extra_data: extra ? JSON.stringify(extra) : null
            };

            const { error } = await supabase.from("historique_modif_fran").insert([entry]);
            if (error) {
              console.error("‚ùå Erreur insertion historique:", error);
            }
          } catch (err) {
            console.error("‚ùå Exception logModification:", err);
          }
        }




        // Fonction utilitaire pour obtenir une traduction
        function getTranslation(key) {
            return translations[key] || key; // Retourne la cl√© si la traduction n'est pas trouv√©e
        }

        // Fonction pour mettre √† jour la classe 'active-lang'
        function updateActiveLanguageFlag(selectedLang) {
            const languageSelector = document.querySelector('.language-selector');
            if (languageSelector) {
                languageSelector.querySelectorAll('img').forEach(img => {
                    if (img.dataset.lang === selectedLang) {
                        img.classList.add('active-lang');
                    } else {
                        img.classList.remove('active-lang');
                    }
                });
            }
        }

        // Fonction pour charger et appliquer les traductions
        async function loadLanguage(lang) {
            try {
                const response = await fetch(`lang/${lang}.json`);
                translations = await response.json();
                // >>> AJOUTEZ CES DEUX LIGNES POUR LE DIAGNOSTIC <<<
                console.log("Translations charg√©es :", translations);
                console.log("Cl√© 'welcome_message_prefix' :", translations.welcome_message_prefix);

                currentLang = lang;
                localStorage.setItem('lang', lang);

                monthNames = [
                    getTranslation('month_jan'), getTranslation('month_feb'), getTranslation('month_mar'),
                    getTranslation('month_apr'), getTranslation('month_may'), getTranslation('month_jun'),
                    getTranslation('month_jul'), getTranslation('month_aug'), getTranslation('month_sep'),
                    getTranslation('month_oct'), getTranslation('month_nov'), getTranslation('month_dec')
                ];

                applyTranslations();
                // Assurez-vous que showPermanentWelcomeMessage() est appel√©e APR√àS loadLanguage()
                // Si vous l'appelez via DOMContentLoaded, c'est bon.
                // Si vous aviez un appel √† updateWelcomeMessage() ici, remplacez-le par showPermanentWelcomeMessage()
                // updateWelcomeMessage(); // Supprimez ou remplacez par showPermanentWelcomeMessage() si c'est le cas

                generateCalendar(currentMonth, currentYear);
                loadTableData();

                updateActiveLanguageFlag(lang);


            } catch (error) {
                console.error(`Erreur lors du chargement des traductions pour ${lang}:`, error);
                translations = {};
                // Si une erreur survient, le message de bienvenue ne pourra pas √™tre traduit.
                // showPermanentWelcomeMessage() sera appel√©e mais affichera la cl√© brute.
            }
        }

        function applyTranslations() {
            // Traduit le titre de la page
            document.title = getTranslation('page_title_daily_calendar_agenda');

            // Traduit les √©l√©ments avec data-i18n
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[key]) {
                    element.textContent = translations[key];
                }
            });

            // Traduit les placeholders avec data-i18n-placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[key]) {
                    element.placeholder = translations[key];
                }
            });

            // Le code pour le message de bienvenue a √©t√© d√©plac√© dans updateWelcomeMessage()
        }


        // Assurez-vous d'appeler loadLanguage au chargement initial
        document.addEventListener('DOMContentLoaded', async function() {
            const savedLang = localStorage.getItem('lang') || 'fr';
            await loadLanguage(savedLang); // Charge les traductions
            showPermanentWelcomeMessage();
            // ... reste de votre logique DOMContentLoaded
            chargerPrefixe(); // Appeler cette fonction pour charger le pr√©fixe
            // generateCalendar(currentMonth, currentYear); // G√©n√®re le calendrier initial
            // Le reste de votre logique DOMContentLoaded ici
        });

        // Gestion du s√©lecteur de langue
        const languageSelector = document.querySelector('.language-selector');
        if (languageSelector) {
            languageSelector.querySelectorAll('img').forEach(img => {
                img.addEventListener('click', async () => {
                    await loadLanguage(img.dataset.lang);
                });
            });
        }

        let countryPrefix = '+33'; // Valeur par d√©faut

        // Charger le pr√©fixe depuis Supabase
        async function chargerPrefixe() {
            const { data, error } = await supabase
                .from('information1_fran')
                .select('content')
                .eq('id', 2)
                .single();

            if (error) {
                console.error("Erreur lors du chargement du pr√©fixe : ", error);
            } else if (data && data.content) {
                countryPrefix = data.content; // Mettre √† jour le pr√©fixe depuis la base de donn√©es
                console.log("Pr√©fixe charg√© depuis la base de donn√©es : ", countryPrefix);
            }
            return countryPrefix;
        }

        // Appeler cette fonction au chargement de la page (d√©j√† g√©r√© par DOMContentLoaded global)
        // window.addEventListener('load', chargerPrefixe); // Comment√© car d√©j√† dans DOMContentLoaded

        // --- Configuration et √âl√©ments DOM pour le Widget M√©t√©o ---
        const API_KEY = 'd8f9db65a75b4889b37165901251407'; // Votre cl√© API WeatherAPI.com
        let WEATHER_LOCATION = ''; // Initialis√©e vide, sera charg√©e depuis Supabase

        // ID de l'entr√©e Supabase pour la ville m√©t√©o (doit correspondre √† celui de configuration.js)
        const METEO_CITY_SUPABASE_ID = 8;

        const meteoDateElem = document.getElementById('meteo-date-short');
        const meteoLocationElem = document.getElementById('meteo-location');
        const meteoIconElem = document.getElementById('meteo-icon');
        const meteoConditionElem = document.getElementById('meteo-condition');
        const meteoMaxTempElem = document.getElementById('meteo-max-temp');
        // const meteoMinTempElem = document.getElementById('meteo-min-temp');
        const meteoChanceRainElem = document.getElementById('meteo-chance-rain');
        const meteoErrorElem = document.getElementById('meteo-error');

        // --- Nouvelle fonction pour charger la ville m√©t√©o depuis Supabase ---
        async function loadMeteoCityFromSupabaseForCalendar() {
            // ATTENTION: Cette fonction suppose que 'supabase' est d√©j√† d√©fini et accessible.
            // Si ce n'est pas le cas, vous obtiendrez une erreur "supabase is not defined".
            try {
                const { data, error } = await supabase
                    .from('information1_fran')
                    .select('content')
                    .eq('id', METEO_CITY_SUPABASE_ID) // Utilise l'ID 8
                    .single();

                if (error && error.code === 'PGRST116') {
                    console.warn('Aucune ville m√©t√©o trouv√©e dans Supabase pour l\'ID', METEO_CITY_SUPABASE_ID, '. Utilisation de la localisation par d√©faut ou vide.');
                    WEATHER_LOCATION = 'Jocotepec,Mexico'; // D√©finir une ville par d√©faut si rien n'est trouv√©
                } else if (error) {
                    console.error("Erreur Supabase lors du chargement de la ville m√©t√©o pour le calendrier:", error);
                    WEATHER_LOCATION = 'Jocotepec,Mexico'; // Fallback en cas d'erreur
                } else if (data && data.content) {
                    WEATHER_LOCATION = data.content; // Mettre √† jour la variable WEATHER_LOCATION
                    console.log("Ville m√©t√©o charg√©e depuis Supabase pour le calendrier:", WEATHER_LOCATION);
                }
            } catch (error) {
                console.error("Erreur inattendue lors du chargement de la ville m√©t√©o pour le calendrier:", error);
                WEATHER_LOCATION = 'Jocotepec,Mexico'; // Fallback en cas d'erreur inattendue
            }
        }


        // Fonction pour obtenir et afficher la m√©t√©o pour une date donn√©e
        async function getAndDisplayWeatherForDate(dateString) {
            // Assurez-vous que WEATHER_LOCATION est bien d√©fini avant d'appeler l'API
            if (!WEATHER_LOCATION) {
                // Si WEATHER_LOCATION n'a pas encore √©t√© charg√©, essayez de le charger
                // Ceci est une mesure de s√©curit√©, normalement loadMeteoCityFromSupabaseForCalendar()
                // devrait √™tre appel√©e avant getAndDisplayWeatherForDate.
                await loadMeteoCityFromSupabaseForCalendar();
                if (!WEATHER_LOCATION) { // Si toujours vide, alors il y a un probl√®me ou pas de config
                    meteoErrorElem.textContent = getTranslation('meteo_location_not_set'); // "Localisation m√©t√©o non configur√©e."
                    console.error("WEATHER_LOCATION n'est pas d√©fini. Impossible de r√©cup√©rer la m√©t√©o.");
                    return;
                }
            }

            meteoErrorElem.textContent = ''; // Effacer les erreurs pr√©c√©dentes

            // Afficher un √©tat de chargement dans le widget
            meteoDateElem.textContent = '...';
            meteoLocationElem.textContent = getTranslation('meteo_loading'); // Traduire "Cargando..."
            meteoIconElem.src = '';
            meteoIconElem.alt = '';
            meteoConditionElem.textContent = '';
            meteoMaxTempElem.textContent = '';
            meteoChanceRainElem.textContent = '';

            try {
                // Utilise la langue actuelle pour l'API m√©t√©o
                const url = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${WEATHER_LOCATION}&dt=${dateString}&lang=${currentLang}`;
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok) {
                    if (data.forecast && data.forecast.forecastday && data.forecast.forecastday.length > 0) {
                        const forecastDay = data.forecast.forecastday[0].day;
                        const locationName = data.location.name;
                        const conditionText = forecastDay.condition.text; // Sera dans la langue de `lang`
                        const conditionIcon = forecastDay.condition.icon;
                        const maxTemp = forecastDay.maxtemp_c;
                        const chanceOfRain = forecastDay.daily_chance_of_rain;

                        // Mettre √† jour les √©l√©ments HTML du widget avec les donn√©es
                        const displayDate = new Date(`${dateString}T00:00:00`);
                        meteoDateElem.textContent = displayDate.toLocaleDateString(currentLang === 'fr' ? 'fr-FR' : (currentLang === 'es' ? 'es-ES' : 'en-US'), { day: 'numeric', month: 'short' });

                        meteoLocationElem.textContent = locationName;
                        meteoIconElem.src = `https:${conditionIcon}`;
                        meteoIconElem.alt = conditionText;

                        meteoConditionElem.textContent = conditionText;
                        meteoMaxTempElem.textContent = maxTemp;
                        meteoChanceRainElem.textContent = chanceOfRain;
                    } else {
                        meteoErrorElem.textContent = getTranslation('meteo_forecast_not_found'); // Traduire
                        console.warn('API Response Missing Forecast:', data);
                    }

                } else {
                    // Gestion des erreurs de l'API (cl√© invalide, limite d√©pass√©e, date trop lointaine, etc.)
                    let errorMessage = getTranslation('meteo_error_prefix'); // Traduire "Error del tiempo: "
                    if (data && data.error && data.error.message) {
                        errorMessage += `${data.error.message}`; // L'API peut renvoyer des messages en anglais
                    } else if (response.status === 400) {
                         errorMessage += getTranslation('meteo_error_date_range'); // Traduire
                    } else if (response.status === 403) {
                        errorMessage += getTranslation('meteo_error_api_key'); // Traduire
                    }
                    meteoErrorElem.textContent = errorMessage;
                    console.error('API Error:', data);
                }

            } catch (error) {
                // Gestion des erreurs r√©seau ou autres exceptions inattendues
                meteoErrorElem.textContent = getTranslation('meteo_error_connection'); // Traduire
                console.error('Fetch Error:', error);
            }
        }

        // --- Appel de la fonction de chargement de la ville au d√©marrage ---
        // Assurez-vous que cette fonction est appel√©e AVANT le premier appel √† getAndDisplayWeatherForDate
        document.addEventListener('DOMContentLoaded', async () => {
            await loadMeteoCityFromSupabaseForCalendar();
            // Apr√®s le chargement de la ville, vous pouvez appeler getAndDisplayWeatherForDate
            // avec la date actuelle ou toute autre date pertinente pour votre calendrier.
            // Exemple : Charger la m√©t√©o pour la date actuelle au d√©marrage
            const today = new Date();
            const todayString = today.toISOString().split('T')[0]; // Format AAAA-MM-JJ
            getAndDisplayWeatherForDate(todayString);
        });



        async function fetchEmployeeNames() {
            const { data, error } = await supabase
                .from('access_code1_fran')
                .select('Nom'); // S√©lectionnez uniquement la colonne 'Nom'

            if (error) {
                console.error('Erreur lors de la r√©cup√©ration des noms des employ√©s :', error);
                return [];
            }
            // Extrait les noms dans un tableau simple
            employeeNames = data.map(row => row.Nom);
            console.log('Noms des employ√©s r√©cup√©r√©s :', employeeNames);
            return employeeNames;
        }

        // Appelez cette fonction au chargement de la page pour pr√©-charger les noms
        document.addEventListener('DOMContentLoaded', fetchEmployeeNames);

        function showPermanentWelcomeMessage() {
            const welcomeName = localStorage.getItem('currentPersonName'); // Assurez-vous que 'currentPersonName' est la cl√© correcte pour le nom

            // Cible l'√©l√©ment HTML existant avec l'ID "welcome-message"
            const welcomeMessageElement = document.getElementById('welcome-message');

            // V√©rifie si l'√©l√©ment existe avant de tenter de le manipuler
            if (!welcomeMessageElement) {
                console.error("Erreur: L'√©l√©ment div#welcome-message est introuvable dans le DOM. Le message de bienvenue ne peut pas √™tre affich√©.");
                return;
            }

            // Efface le contenu pr√©c√©dent et les styles par d√©faut au cas o√π
            welcomeMessageElement.innerText = '';
            // welcomeMessageElement.style = ''; // D√©commentez si vous voulez r√©initialiser tous les styles inline

            if (welcomeName) {
                // --- MODIFICATION ICI : Affiche SEULEMENT le nom de l'utilisateur, suivi d'un point d'exclamation ---
                welcomeMessageElement.textContent = `${getTranslation('welcome_message_prefix')} ${welcomeName}`;



                // S'assure que l'√©l√©ment est visible (si vous le cachiez par CSS par d√©faut)
                welcomeMessageElement.style.display = 'block';
            } else {
                // Si aucun nom n'est trouv√©, assurez-vous que l'√©l√©ment est vide et cach√©
                welcomeMessageElement.innerText = '';
                welcomeMessageElement.style.display = 'none';
            }
        }
        // document.addEventListener('DOMContentLoaded', showPermanentWelcomeMessage);


        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }

            // ‚úÖ CORRECTION : Passer evenementsRecherche pour conserver le filtre.
            generateCalendar(currentMonth, currentYear, evenementsRecherche);
        }

        // Fonction pour afficher un message temporaire
        function showTemporaryMessage(message) {
            const messageElement = document.getElementById('temporaryMessage');
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.style.display = 'block';

                // Masquer le message apr√®s 2 secondes
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 2000);
            } else {
                console.error("L'√©l√©ment temporaryMessage est introuvable dans le DOM.");
            }
        }



        function extractImagesFromObservations(text) {
          const regex = /https?:\/\/\S+\.(?:png|jpg|jpeg|gif|webp)/gi;
          return text.match(regex) || [];
        }



        // Fonction pour charger le contenu existant de "Informations permanentes" au chargement de la page
        async function loadPermanentInformation() {
            const { data, error } = await supabase
                .from('information1_fran')
                .select('content')
                .eq('id', 1) // S√©lectionner uniquement la ligne avec id: 1
                .single();

            if (error) {
                console.error('Erreur lors du chargement des informations :', error);
            } else if (data) {
                document.getElementById('permanentNotes').value = data.content || ''; // Remplir le champ avec le contenu existant
            }
        }

        async function applyChangesWithoutPrompt(row, isSeries) {
            const userId = row.dataset.userId;

            // 1Ô∏è‚É£ R√©cup√©rer l'√©v√©nement complet depuis Supabase
            const { data: rendezvousActuel, error } = await supabase
                .from('event_quot1_fran')
                .select('*')
                .eq('user_id', userId)
                .single();
            if (error) {
                console.error("‚ùå Erreur r√©cup√©ration √©v√©nement :", error);
                return;
            }
            const recurrenceId = rendezvousActuel.recurrence_id;

            // 2Ô∏è‚É£ Construire modificationsFromRow en filtrant SEULEMENT les champs qui ont vraiment chang√©
            const modificationsFromRow = {};
            Array.from(row.cells).forEach(cell => {
                const column = cell.dataset.column;

                // üö® IGNORER COMPL√àTEMENT LA COLONNE 'Travail'
                if (column && column !== "Travail") {
                    let cellValue;

                    if (column === "Observations") {
                        const textarea = row.querySelector('[data-field="observations"]');
                        cellValue = textarea ? textarea.value.trim() : "";
                    } else {
                        cellValue = cell.textContent.trim();
                    }

                    const nouvelleValeur = cellValue === "" ? null : cellValue;

                    const ancienneValeur = rendezvousActuel[column] === "" ? null : rendezvousActuel[column];

                    // On inclut uniquement si la valeur de l'UI est diff√©rente de la valeur initiale en base
                    if (String(nouvelleValeur) !== String(ancienneValeur)) {
                        modificationsFromRow[column] = nouvelleValeur;
                    }
                }
            });

            // 3Ô∏è‚É£ Envoyer SEULEMENT les champs qui doivent √™tre mis √† jour.
            await updateEventData(row, rendezvousActuel, isSeries, recurrenceId, modificationsFromRow);
        }


        // Obtenir la date et l'heure locales au format 'YYYY-MM-DD HH:mm:ss'
        function getLocalDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // Fonction pour sauvegarder le contenu de "Informations permanentes" lors du clic sur "Guardar"
        async function savePermanentInformation() {
            const content = document.getElementById('permanentNotes').value;
            const dateModified = getLocalDateTime(); // Utiliser la date et heure locales

            // Mise √† jour ou insertion du contenu dans la table "information1"
            const { data, error } = await supabase
                .from('information1_fran')
                .upsert(
                    { id: 1, content: content, date_modified: dateModified }, // id: 1 pour g√©rer une seule ligne unique
                    { onConflict: ['id'] } // Assurer la mise √† jour si l'ID existe d√©j√†
                );

            if (error) {
                console.error('Erreur lors de la sauvegarde des informations :', error);
            } else {
                console.log('Informations permanentes sauvegard√©es avec succ√®s.');
                showTemporaryMessage(getTranslation('message_saved')); // Traduire le message de succ√®s
            }
        }

        // Charger les informations au chargement de la page
        window.addEventListener('DOMContentLoaded', loadPermanentInformation); // D√©j√† g√©r√© par DOMContentLoaded global

        // Associer la fonction de sauvegarde au bouton "Guardar"
        document.getElementById('savePermanentNotesButton').addEventListener('click', savePermanentInformation);

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded d√©clench√©');

            window.successMessage = document.getElementById('successMessage');
            console.log('√âl√©ment successMessage:', window.successMessage);

            var today = new Date();
            var todayDate = today.getDate();
            var todayMonth = today.getMonth();
            var todayYear = today.getFullYear();
            var todayFormatted = `${todayYear}-${String(todayMonth + 1).padStart(2, '0')}-${String(todayDate).padStart(2, '0')}`;

            if (!window.isCalendarGenerated) {
                generateCalendar(currentMonth, currentYear);
                window.isCalendarGenerated = true;
            }

            if (!window.isTodaySelected) {
                selectToday();
                window.isTodaySelected = true;
            }

            await checkAndHighlightNotes(todayFormatted);

            // Fonction pour obtenir la date et l'heure locales au format 'YYYY-MM-DD HH:mm:ss'
            function getLocalDateTime() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = now.getHours();
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                return { formattedDate: `${year}-${month}-${day}`, hours, minutes, seconds };
            }

            // Fonction pour convertir une heure avec "am/pm" en format 24h (e.g., "9am" -> "09:00", "2pm" -> "14:00")
            function convertirHeureEn24h(heureTexte) {
                let match = heureTexte.match(/^(\d{1,2})(am|pm)$/i);
                if (!match) return "00:00"; // s√©curit√©

                let heure = parseInt(match[1], 10);
                let periode = match[2].toLowerCase();

                if (periode === "pm" && heure !== 12) {
                    heure += 12;
                } else if (periode === "am" && heure === 12) {
                    heure = 0;
                }

                return `${String(heure).padStart(2, '0')}:00`;
            }

            // Fonction pour v√©rifier et afficher la demande de rappel
            window.addEventListener('load', async () => {
                setTimeout(async () => {
                    const { formattedDate: dateDuJour, hours } = getLocalDateTime();

                    let rappelColumn = '';
                    if (hours >= 7 && hours < 12) {
                        rappelColumn = 'rappel_envoy√©_am';
                    } else if (hours >= 12 && hours < 21) {
                        rappelColumn = 'rappel_envoy√©_pm';
                    } else {
                        console.log(getTranslation('log_outside_reminder_hours')); // Traduire
                        return; // En dehors des plages de rappel, ne rien faire
                    }

                    // V√©rifier s'il reste des rendez-vous pour aujourd'hui sans rappel envoy√© pour la p√©riode (AM ou PM)
                    const { data: rendezVousNonEnvoyes, error } = await supabase
                        .from('event_quot1_fran')
                        .select(`user_id, Heure, ${rappelColumn}`)
                        .eq(rappelColumn, false)
                        .eq('Date', dateDuJour);

                    if (error) {
                        console.error('Erreur lors de la v√©rification des rappels :', error);
                        return;
                    }

                    const heureActuelle = new Date();
                    const heureActuelle24h = `${String(heureActuelle.getHours()).padStart(2, '0')}:${String(heureActuelle.getMinutes()).padStart(2, '0')}`;

                    // Filtrer les rendez-vous √† venir aujourd'hui pour la p√©riode
                    const rendezVousAFiltrer = rendezVousNonEnvoyes.filter(rendezvous => {
                        const heureRendezVous24h = convertirHeureEn24h(rendezvous.Heure);
                        return heureRendezVous24h > heureActuelle24h;
                    });

                    // Si des rendez-vous sans rappel et apr√®s l'heure actuelle existent, afficher la demande de confirmation
                    if (rendezVousAFiltrer.length > 0) {
                        const confirmation = confirm(getTranslation('confirm_send_reminders')); // Traduire
                        if (confirmation) {
                            envoyerRappelAutomatique();
                        } else {
                            // Si l'utilisateur refuse, mettre √† jour la colonne de rappel pour la p√©riode
                            const userIds = rendezVousAFiltrer.map(rdv => rdv.user_id);
                            const { error: updateError } = await supabase
                                .from('event_quot1_fran')
                                .update({ [rappelColumn]: true })
                                .in('user_id', userIds);

                            if (updateError) {
                                console.error(`Erreur lors de la mise √† jour de ${rappelColumn} :`, updateError);
                            } else {
                                console.log(getTranslation('log_reminders_updated_success', { period: rappelColumn })); // Traduire avec variable
                            }
                        }
                    } else {
                        console.log(getTranslation('log_all_reminders_sent_or_passed', { period: rappelColumn })); // Traduire avec variable
                    }
                }, 3000); // Attente de 3 secondes
            });

            // Ajout d'une v√©rification de pr√©sence d‚Äôun modal avant d'ouvrir un autre modal
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('paiement-link')) {
                    event.preventDefault();
                    const link = event.target;

                    // V√©rification si le paiement est d√©j√† affich√©
                    if (link.dataset.paiement && link.dataset.paiement !== 'null' && link.dataset.paiement !== '') {
                        console.log(getTranslation('log_payment_link_clicked_show_existing_image')); // Traduire
                        openImagePopup(link.dataset.paiement);
                    } else {
                        console.log(getTranslation('log_no_payment_found_show_choice_popup')); // Traduire
                        // Sinon, afficher le popup de choix (Bo√Æte de dialogue ou Document)
                        const choixPopup = document.createElement('div');
                        choixPopup.style.position = 'fixed';
                        choixPopup.style.top = '50%';
                        choixPopup.style.left = '50%';
                        choixPopup.style.transform = 'translate(-50%, -50%)';
                        choixPopup.style.padding = '20px';
                        choixPopup.style.backgroundColor = '#fff';
                        choixPopup.style.border = '1px solid #ccc';
                        choixPopup.style.boxShadow = '0px 0px 10px rgba(0,0,0,0.2)';
                        choixPopup.style.borderRadius = '8px';
                        choixPopup.style.zIndex = '1000';
                        choixPopup.style.textAlign = 'center';
                        choixPopup.style.fontFamily = 'Arial, sans-serif';
                        choixPopup.style.width = '300px';

                        const titre = document.createElement('h3');
                        titre.textContent = getTranslation('popup_choose_option'); // Traduire
                        titre.style.marginBottom = '15px';
                        choixPopup.appendChild(titre);

                        const boutonDialogue = document.createElement('button');
                        boutonDialogue.textContent = getTranslation('button_add_via_dialog'); // Traduire
                        boutonDialogue.style.marginRight = '10px';
                        boutonDialogue.addEventListener('click', function() {
                            openPaiement(link);  // Ouvrir la bo√Æte de dialogue
                            document.body.removeChild(choixPopup); // Fermer le popup
                        });

                        const boutonDocument = document.createElement('button');
                        boutonDocument.textContent = getTranslation('button_document_for_payment'); // Traduire
                        boutonDocument.style.margin = '5px';
                        boutonDocument.style.marginRight = '10px'; // Espace suppl√©mentaire √† droite
                        boutonDocument.addEventListener('click', function() {
                            openDocumentPopup(link);  // Ouvrir le popup de cr√©ation de document
                            document.body.removeChild(choixPopup); // Cerrar el popup
                        });

                        // Ajout du bouton "Note de vente"
                        const boutonNotaDeVenta = document.createElement('button');
                        boutonNotaDeVenta.textContent = getTranslation('button_create_sales_note'); // Traduire
                        boutonNotaDeVenta.style.margin = '5px';
                        boutonNotaDeVenta.addEventListener('click', function() {
                            openNotaDeVentaPopup(link);  // Appeler la fonction pour cr√©er ou ouvrir la nota de venta
                            document.body.removeChild(choixPopup); // Cerrar el popup
                        });

                        // Bouton pour fermer le popup
                        const boutonCerrar = document.createElement('button');
                        boutonCerrar.textContent = getTranslation('button_close'); // Traduire
                        boutonCerrar.style.margin = '5px';
                        boutonCerrar.style.backgroundColor = '#dc3545';
                        boutonCerrar.style.color = 'white';
                        boutonCerrar.style.border = 'none';
                        boutonCerrar.style.padding = '8px 12px';
                        boutonCerrar.style.borderRadius = '4px';
                        boutonCerrar.addEventListener('click', function() {
                            document.body.removeChild(choixPopup); // Fermer le popup
                        });

                        // Ajouter les boutons au popup
                        choixPopup.appendChild(boutonDialogue);
                        choixPopup.appendChild(boutonDocument);
                        choixPopup.appendChild(boutonNotaDeVenta);
                        choixPopup.appendChild(boutonCerrar);
                        document.body.appendChild(choixPopup);
                    }
                }
            });

            async function openImagePopup(imagePath) {
                // Supprimer le modal existant s'il y en a un
                const existingModal = document.getElementById('modalOverlay');
                if (existingModal) {
                    document.body.removeChild(existingModal);
                }

                console.log(getTranslation('log_open_image_popup_called')); // Traduire

                // D√©tecter si c'est un PDF
                const isPdf = imagePath.toLowerCase().endsWith('.pdf');

                try {
                    const { data, error } = await supabase
                        .storage
                        .from('facturas_fran')
                        .createSignedUrl(imagePath, 86400, {
                            download: false,
                            transform: {} // important pour ne pas forcer le t√©l√©chargement
                        });

                    if (error || !data || !data.signedUrl) {
                        console.error(getTranslation('error_fetching_signed_url'), error); // Traduire
                        return;
                    }

                    // R√©cup√©ration s√©curis√©e du contenu
                    const response = await fetch(data.signedUrl);
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);

                    // Cr√©ation du modal
                    const modalOverlay = document.createElement('div');
                    modalOverlay.id = 'modalOverlay';
                    modalOverlay.style.position = 'fixed';
                    modalOverlay.style.top = 0;
                    modalOverlay.style.left = 0;
                    modalOverlay.style.width = '100vw';
                    modalOverlay.style.height = '100vh';
                    modalOverlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
                    modalOverlay.style.display = 'flex';
                    modalOverlay.style.alignItems = 'center';
                    modalOverlay.style.justifyContent = 'center';
                    modalOverlay.style.zIndex = 9999;

                    const container = document.createElement('div');
                    container.style.backgroundColor = '#fff';
                    container.style.padding = '20px';
                    container.style.borderRadius = '8px';
                    container.style.maxWidth = '90vw';
                    container.style.maxHeight = '90vh';
                    container.style.overflow = 'auto'; // ‚úÖ scroll si n√©cessaire
                    container.style.display = 'flex';
                    container.style.flexDirection = 'column';
                    container.style.alignItems = 'center';
                    container.style.justifyContent = 'center';

                    // √âlement √† afficher (image ou PDF)
                    let viewerElement;

                    if (isPdf) {
                        viewerElement = document.createElement('iframe');
                        viewerElement.src = `/pdfjs/web/viewer.html?file=${encodeURIComponent(blobUrl)}`;
                        viewerElement.style.width = '80vw';
                        viewerElement.style.height = '80vh';
                        viewerElement.style.border = 'none';
                    } else {
                        viewerElement = document.createElement('img');
                        viewerElement.src = blobUrl;
                        viewerElement.style.maxWidth = '100%';
                        viewerElement.style.maxHeight = '80vh';
                        viewerElement.style.objectFit = 'contain';
                        viewerElement.alt = getTranslation('image_preview_alt'); // Traduire l'alt
                    }


                    // Bouton de fermeture
                    const closeButton = document.createElement('button');
                    closeButton.textContent = getTranslation('button_close'); // Traduire
                    closeButton.style.marginTop = '10px';
                    closeButton.addEventListener('click', () => {
                        document.body.removeChild(modalOverlay);
                    });

                    container.appendChild(viewerElement);
                    container.appendChild(closeButton);
                    modalOverlay.appendChild(container);
                    document.body.appendChild(modalOverlay);

                } catch (err) {
                    console.error(getTranslation('error_processing_document'), err); // Traduire
                }
            }



            const cells = document.querySelectorAll('.clickable');
            cells.forEach(cell => {
                if (parseInt(cell.textContent) === todayDate && currentMonth === todayMonth && currentYear === todayYear) {
                    const event = new Event('click');
                    cell.dispatchEvent(event);
                }
            });

            document.getElementById('prevButton').addEventListener('click', function() {
                changeMonth(-1);
            });

            document.getElementById('nextButton').addEventListener('click', function() {
                changeMonth(1);
            });

            document.querySelectorAll('.clickable').forEach(cell => {
                cell.addEventListener('click', handleDateClick);
            });
        });

        document.addEventListener('DOMContentLoaded', loadDailyNotes);



        function closeModal() {
            document.getElementById('editNoteModal').style.display = 'none';
        }

        // D√©clarer la variable `currentNoteType`
        let currentNoteType = 1; // Valeur par d√©faut : Note normale

        // Fonction pour changer le type de note s√©lectionn√©
        function setNoteType(type) {
            document.querySelectorAll('.note-type-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById('normalNoteBtn').classList.toggle('active', type === 1);
            document.getElementById('manualNoteBtn').classList.toggle('active', type === 2);
            document.getElementById('todoListBtn').classList.toggle('active', type === 3);

            document.getElementById('noteText').style.display = type === 1 ? 'block' : 'none';
            document.getElementById('noteCanvas').style.display = type === 2 ? 'block' : 'none';
            document.getElementById('todoListContainer').style.display = type === 3 ? 'block' : 'none';

            currentNoteType = type;
        }

        document.addEventListener("DOMContentLoaded", function() {
            // ‚ö° Charger la liste des employ√©s au d√©marrage
            loadEmployees();

            document.getElementById("normalNoteBtn").addEventListener("click", () => setNoteType(1));
            document.getElementById("manualNoteBtn").addEventListener("click", () => setNoteType(2));
            document.getElementById("todoListBtn").addEventListener("click", () => setNoteType(3));

            const saveNoteButton = document.getElementById("saveNoteButton");
            saveNoteButton.addEventListener("click", saveNote);

            const addTodoBtn = document.getElementById('addTodoBtn');
            if (addTodoBtn) {
                addTodoBtn.addEventListener('click', () => {
                    const newTodoItem = document.getElementById('newTodoItem');
                    const todoList = document.getElementById('todoList');
                    if (newTodoItem.value.trim() !== '') {
                        const li = document.createElement('li');
                        li.innerHTML = `<input type="checkbox"> <span>${newTodoItem.value}</span>`;
                        todoList.appendChild(li);
                        newTodoItem.value = '';
                    }
                });
            }
        });


        let isDrawing = false;
        let currentTool = 'pencil';
        let lastX = 0;
        let lastY = 0;
        let history = [];
        let currentHistoryIndex = -1;

        const canvas = document.getElementById('noteCanvas');
        const ctx = canvas.getContext('2d');

        // --- Configuration initiale du canevas et des outils ---
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000000';
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // --- Fonctions pour g√©rer les outils ---
        function selectTool(tool) {
            currentTool = tool;
            if (tool === 'pencil') {
                ctx.strokeStyle = document.querySelector('#colorPalette .color-btn.active').style.backgroundColor;
                ctx.lineWidth = document.getElementById('lineWidthSlider').value;
            } else if (tool === 'eraser') {
                ctx.strokeStyle = '#ffffff'; // Couleur du fond
                ctx.lineWidth = 20; // √âpaisseur par d√©faut pour la gomme
            }
        }

        function saveState() {
            if (currentHistoryIndex < history.length - 1) {
                history = history.slice(0, currentHistoryIndex + 1);
            }
            const dataURL = canvas.toDataURL();
            history.push(dataURL);
            currentHistoryIndex++;
        }

        function undo() {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                const image = new Image();
                image.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(image, 0, 0);
                };
                image.src = history[currentHistoryIndex];
            } else if (currentHistoryIndex === 0) {
                currentHistoryIndex--;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // Nouvelle fonction pour "refaire" l'action
        function redo() {
            if (currentHistoryIndex < history.length - 1) {
                currentHistoryIndex++;
                const image = new Image();
                image.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(image, 0, 0);
                };
                image.src = history[currentHistoryIndex];
            }
        }

        // Fonction pour r√©cup√©rer les coordonn√©es avec gestion de l'√©chelle
        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches) {
                return [
                    (e.touches[0].clientX - rect.left) * scaleX,
                    (e.touches[0].clientY - rect.top) * scaleY
                ];
            }
            return [
                (e.clientX - rect.left) * scaleX,
                (e.clientY - rect.top) * scaleY
            ];
        }

        // Fonction pour commencer le dessin
        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;

            // On ne sauvegarde l'√©tat que si l'historique est vide ou si un trait a d√©j√† √©t√© fait
            if (currentHistoryIndex === -1) {
                saveState();
            }

            // On r√©cup√®re les coordonn√©es de d√©part
            [lastX, lastY] = getCoordinates(e);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const [x, y] = getCoordinates(e);

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();

            [lastX, lastY] = [x, y];
        }

        // Fonction pour arr√™ter de dessiner
        function stopDrawing() {
            isDrawing = false;
            // On sauvegarde l'√©tat du canevas √† la fin du trait
            saveState();
        }

        // --- √âcouteurs d'√©v√©nements pour le canevas ---
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);

        // --- √âcouteurs d'√©v√©nements pour les boutons d'outils ---
        document.getElementById('undoBtn').addEventListener('click', undo);

        document.getElementById('redoBtn').addEventListener('click', redo);

        document.getElementById('pencilBtn').addEventListener('click', () => {
            selectTool('pencil');
            document.querySelector('.tool-btn.active')?.classList.remove('active');
            document.getElementById('pencilBtn').classList.add('active');
        });

        document.getElementById('eraserBtn').addEventListener('click', () => {
            selectTool('eraser');
            document.querySelector('.tool-btn.active')?.classList.remove('active');
            document.getElementById('eraserBtn').classList.add('active');
        });

        document.getElementById('lineWidthSlider').addEventListener('input', (e) => {
            ctx.lineWidth = e.target.value;
            if (currentTool === 'eraser') {
                selectTool('pencil');
            }
        });

        document.getElementById('colorPalette').addEventListener('click', (e) => {
            if (e.target.classList.contains('color-btn')) {
                ctx.strokeStyle = e.target.style.backgroundColor;
                document.querySelector('#colorPalette .color-btn.active')?.classList.remove('active');
                e.target.classList.add('active');
                selectTool('pencil');
            }
        });

        // --- Gestion des modaux ---
        document.getElementById('manualNoteBtn').addEventListener('click', () => {
            document.getElementById('editNoteModal').style.display = 'block';
            document.getElementById('manualNoteModal').style.display = 'flex';
        });

        document.getElementById('saveDrawingBtn').addEventListener('click', () => {
            saveNote(); // La fonction de sauvegarde existe d√©j√†
            document.getElementById('manualNoteModal').style.display = 'none';
            document.getElementById('editNoteModal').style.display = 'block';
        });

        document.getElementById('closeDrawingBtn').addEventListener('click', () => {
            document.getElementById('manualNoteModal').style.display = 'none';
            document.getElementById('editNoteModal').style.display = 'block';
        });


        // Fonction pour obtenir le type de note
        function getSelectedNoteType() {
            if (document.getElementById('manualNoteBtn').classList.contains('active')) {
                return 2;
            } else if (document.getElementById('todoListBtn').classList.contains('active')) {
                return 3;
            } else {
                return 1;
            }
        }


        async function saveNote() {
            console.log('log_save_note_function_loaded');
            const date = document.getElementById('modalDate').textContent.trim();
            const noteType = getSelectedNoteType();
            let dataToSave = {};

            if (noteType === 1) { // Note normale
                dataToSave.notes = document.getElementById('noteText').value.trim();
            } else if (noteType === 2) { // Note manuscrite
                const canvas = document.getElementById('noteCanvas');
                dataToSave.notes = canvas.toDataURL(); // Sauvegarde en base64 dans 'notes'
                console.log('Donn√©es du canevas sauvegard√©es :', dataToSave.notes);
            } else if (noteType === 3) { // To-do liste
                const todos = [];
                document.querySelectorAll('#todoList li').forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    const text = item.querySelector('span').textContent;
                    todos.push({ text: text, completed: checkbox.checked });
                });
                dataToSave.todo_notes = JSON.stringify(todos);
            }

            const { data, error } = await supabase
                .from('daily_notes1_fran')
                .select('*')
                .eq('date', date)
                .eq('type', noteType)
                .maybeSingle();

            if (error && error.code !== 'PGRST116') {
                console.error('error_fetching_note', error);
                return;
            }

            let saveSuccess = false;

            if (data) {
                const { error: updateError } = await supabase
                    .from('daily_notes1_fran')
                    .update({
                        notes: dataToSave.notes,
                        todo_notes: dataToSave.todo_notes,
                        type: noteType
                    })
                    .match({ id: data.id });

                if (updateError) {
                    console.error('error_updating_note', updateError);
                } else {
                    console.log('Note mise √† jour avec succ√®s');
                    saveSuccess = true;
                }
            } else {
                const { data: insertData, error: insertError } = await supabase
                    .from('daily_notes1_fran')
                    .insert([{
                        notes: dataToSave.notes,
                        todo_notes: dataToSave.todo_notes,
                        date: date,
                        type: noteType
                    }]);

                if (insertError) {
                    console.error('error_inserting_note', insertError);
                } else {
                    console.log('Nouvelle note ins√©r√©e avec succ√®s');
                    saveSuccess = true;
                }
            }

            // Apr√®s sauvegarde r√©ussie
            if (saveSuccess) {
                if (noteType === 2) {
                    console.log('üîÑ Rechargement du canvas apr√®s sauvegarde...');
                    setTimeout(() => {
                        showManualNote(date);
                    }, 300);
                } else {
                    loadDailyNotes();
                }
            } else {
                loadDailyNotes();
            }
        }


        async function handleFacturaUpload(link, userId) {
            console.log(getTranslation('log_handle_factura_upload_triggered')); // Traduire

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,application/pdf';

            input.addEventListener('change', async function() {
                const file = input.files[0];
                if (file) {
                    try {
                        console.log(getTranslation('log_uploading_file_for_user', { fileName: file.name, userId: userId })); // Traduire avec variables

                        // Upload du fichier √† Supabase Storage
                        const { data, error } = await supabase.storage
                            .from('facturas_fran')
                            .upload(`facturas_fran/${userId}/${file.name}`, file);

                        if (error) {
                            // V√©rifier le code d'erreur
                            if (error.statusCode === 409 && error.message === 'The resource already exists') {
                                alert(getTranslation('alert_file_already_used')); // Traduire
                            } else {
                                console.error(getTranslation('error_file_upload_generic'), error); // Traduire
                                alert(getTranslation('alert_file_already_used')); // Traduire
                            }
                            return;
                        }

                        console.log(getTranslation('log_file_uploaded_success'), data); // Traduire

                        // Mettre √† jour la colonne paiement dans event_quot1_fran avec le chemin du fichier
                        const { error: updateError } = await supabase
                            .from('event_quot1_fran')
                            .update({ paiement: data.path })  // Utilise le chemin g√©n√©r√© par l'upload
                            .eq('user_id', userId);

                        if (updateError) {
                            console.error(getTranslation('error_updating_event_quot1_fran'), updateError); // Traduire
                            return;
                        }

                        console.log(getTranslation('log_event_quot1_fran_updated_success_payment')); // Traduire

                        // Mettre √† jour l'interface pour indiquer que la facture a √©t√© ajout√©e
                        link.textContent = getTranslation('link_view_payment'); // Traduire
                        link.dataset.paiement = data.path;

                        const row = link.closest('tr');
                        const applyButton = row.querySelector('.apply-button');
                        if (applyButton) {
                            applyChangesWithoutPrompt(row, false);
                        }
                    } catch (error) {
                        console.error(getTranslation('error_upload_update_facture'), error); // Traduire
                        alert(getTranslation('alert_upload_facture_error_check_console')); // Traduire
                    }
                }
            });

            input.click(); // Ouvrir la bo√Æte de dialogue pour choisir un fichier
        }

        async function updateTables(paiement, userId, T√©l√©phone) {
            try {
                console.log(getTranslation('log_update_tables_start', { userId: userId, phone: T√©l√©phone })); // Traduire avec variables
                if (!T√©l√©phone) {
                    console.error(getTranslation('error_phone_undefined')); // Traduire
                    return;
                }

                if (userId) {
                    console.log(getTranslation('log_attempt_update_event_quot1_fran', { payment: paiement })); // Traduire avec variables
                    const { data: updatedEventQuot1_fran, error: updateErrorEventQuot1_fran } = await supabase
                        .from('event_quot1_fran')
                        .update({ paiement: paiement })
                        .eq('user_id', userId);

                    if (updateErrorEventQuot1_fran) {
                        console.error(getTranslation('error_updating_event_quot1_fran'), updateErrorEventQuot1_fran); // Traduire
                    } else {
                        console.log(getTranslation('log_event_quot1_fran_updated_success'), updatedEventQuot1_fran); // Traduire
                    }
                } else {
                    console.error(getTranslation('error_user_id_undefined')); // Traduire
                }

                if (T√©l√©phone) {
                    console.log(getTranslation('log_attempt_update_table_data1_fran', { payment: paiement })); // Traduire avec variables
                    const { data: updatedTableData1_fran, error: updateErrorTableData1_fran } = await supabase
                        .from('tableData1_fran')
                        .update({ paiement: paiement })
                        .eq('T√©l√©phone', T√©l√©phone);

                    if (updateErrorTableData1_fran) {
                        console.error(getTranslation('error_updating_table_data1_fran'), updateErrorTableData1_fran); // Traduire
                    } else {
                        console.log(getTranslation('log_table_data1_fran_updated_success'), updatedTableData1_fran); // Traduire
                    }
                } else {
                    console.error(getTranslation('error_phone_undefined')); // Traduire
                }
            } catch (error) {
                console.error(getTranslation('error_updating_tables'), error); // Traduire
            }
        }

        // Soit affichage facture soit boite de dialogue pour enregistrer lien
        function openPaiement(link) {
            const paiementPath = link.dataset.paiement;

            if (paiementPath && paiementPath !== 'null' && paiementPath !== '') {
                // Si le paiement existe, on tente de r√©cup√©rer et d'afficher la facture
                supabase
                    .storage
                    .from('facturas_fran')
                    .createSignedUrl(paiementPath, 86400)
                    .then(({ data, error }) => {
                        if (error) {
                            console.error(getTranslation('error_fetching_signed_url'), error); // Traduire
                        } else if (data) {
                            const fileUrl = data.signedUrl;

                            const modal = document.createElement('div');
                            modal.id = 'paiementModal';
                            modal.style.position = 'fixed';
                            modal.style.top = '50%';
                            modal.style.left = '50%';
                            modal.style.transform = 'translate(-50%, -50%)';
                            modal.style.padding = '15px';
                            modal.style.backgroundColor = '#f9f9f9';
                            modal.style.border = '1px solid #ccc';
                            modal.style.boxShadow = '0px 0px 5px rgba(0,0,0,0.2)';
                            modal.style.borderRadius = '8px';
                            modal.style.zIndex = '1000';
                            modal.style.fontFamily = 'Arial, sans-serif';
                            modal.style.minWidth = '350px'; // Largeur minimale
                            modal.style.whiteSpace = 'nowrap'; // √âvite les coupures de texte
                            modal.style.width = 'auto';
                            modal.style.maxWidth = '90%'; // Emp√™che l'√©largissement excessif


                            // Ajouter l'image au modal
                            modal.innerHTML = `
                                <h3 style="color: #333; text-align: center; margin-bottom: 10px;" data-i18n="payment_receipt_heading">Re√ßu du paiement</h3>
                                <img src="${fileUrl}" style="width: 100%; height: auto; border-radius: 8px; display: block;">
                                <br>
                                <button id="closeModal" style="padding: 8px 12px; border-radius: 4px; background-color: #dc3545; border: none; color: white; font-weight: bold; margin-top: 10px;" data-i18n="button_close">Fermer</button>
                            `;
                            // Appliquer la traduction apr√®s avoir d√©fini innerHTML
                            modal.querySelector('[data-i18n="payment_receipt_heading"]').textContent = getTranslation('payment_receipt_heading');
                            modal.querySelector('[data-i18n="button_close"]').textContent = getTranslation('button_close');


                            // Ajouter le modal au document
                            document.body.appendChild(modal);

                            // Fermer le modal lorsque l'utilisateur clique sur le bouton "Fermer"
                            document.getElementById('closeModal').onclick = function () {
                                document.body.removeChild(modal);
                            };
                        }
                    });
            } else {
                // Si aucune facture n'existe, proposer d'en ajouter une
                const input = document.createElement('input');
                // ouverture de la boite de dialogue
                input.type = 'file';
                input.accept = 'image/*,application/pdf';
                input.addEventListener('change', async function() {
                    const file = input.files[0];
                    if (file) {
                        try {
                            // R√©cup√©rer l'userId du lien pour structurer correctement le chemin du fichier
                            const userId = link.closest('tr').dataset.userId;

                            // Upload du fichier √† Supabase Storage
                            const { data, error } = await supabase.storage
                                .from('facturas_fran')
                                .upload(`facturas_fran/${userId}/${file.name}`, file);

                            if (error) {
                                alert(getTranslation('alert_upload_invoice_error')); // Traduire
                                return;
                            }

                            // Mise √† jour de l'√©l√©ment du lien pour afficher "Voir le paiement"
                            link.textContent = getTranslation('link_view_payment'); // Traduire
                            link.dataset.paiement = data.path;

                            // Mise √† jour de la base de donn√©es avec le chemin du fichier
                            const { error: updateError } = await supabase
                                .from('event_quot1_fran')
                                .update({ paiement: data.path })
                                .eq('user_id', userId);

                            if (updateError) {
                                console.error(getTranslation('error_updating_invoice_db'), updateError);
                            } else {
                                // Remplacer l'appel du clic simul√© par la fonction de sauvegarde directe
                                const row = link.closest('tr');
                                if (row) {
                                    applyChangesWithoutPrompt(row, false);
                                }
                            }
                        } catch (error) {
                            console.error(getTranslation('error_uploading_invoice'), error); // Traduire
                        }
                    }
                });

                // Ouvrir la bo√Æte de dialogue pour ajouter un fichier
                input.click();
            }
        }

        // Fonction pour charger les donn√©es bancaires depuis Supabase
        async function chargerDonneesBancaires() {
            try {
                // R√©cup√©rer chaque ligne sp√©cifique pour chaque information bancaire
                const { data: sucursalData } = await supabase.from('information1_fran').select('content').eq('id', 3).single();
                const { data: compteData } = await supabase.from('information1_fran').select('content').eq('id', 4).single();
                const { data: banqueData } = await supabase.from('information1_fran').select('content').eq('id', 5).single();
                const { data: ibanData } = await supabase.from('information1_fran').select('content').eq('id', 6).single();
                const { data: destinataireData } = await supabase.from('information1_fran').select('content').eq('id', 7).single();

                // Mettre √† jour les valeurs des champs du formulaire avec les donn√©es r√©cup√©r√©es
                document.getElementById('documentBanco1').value = sucursalData?.content || getTranslation('bank_branch_undefined'); // Traduire
                document.getElementById('documentBanco2').value = compteData?.content || getTranslation('bank_account_undefined'); // Traduire
                document.getElementById('documentBanco').value = banqueData?.content || getTranslation('bank_undefined'); // Traduire
                document.getElementById('documentBanco3').value = ibanData?.content || getTranslation('iban_undefined'); // Traduire
                document.getElementById('documentBanco4').value = destinataireData?.content || getTranslation('recipient_name_undefined'); // Traduire

            } catch (error) {
                console.error(getTranslation('error_loading_bank_data'), error); // Traduire
            }
        }
        // Fonction pour ouvrir le popup du document
        function openDocumentPopup(link) {
            // Cr√©e le popup pour le document
            const documentPopup = document.createElement('div');
            documentPopup.id = 'documentPopup';
            documentPopup.style.position = 'fixed';
            documentPopup.style.top = '50%';
            documentPopup.style.left = '50%';
            documentPopup.style.transform = 'translate(-50%, -50%)';
            documentPopup.style.padding = '20px';
            documentPopup.style.backgroundColor = '#ffffff';
            documentPopup.style.border = '2px solid #333';
            documentPopup.style.boxShadow = '0px 0px 15px rgba(0,0,0,0.3)';
            documentPopup.style.borderRadius = '10px';
            documentPopup.style.zIndex = '1000';
            documentPopup.style.fontFamily = 'Arial, sans-serif';
            documentPopup.style.width = '450px';
            documentPopup.style.maxHeight = '90vh';
            documentPopup.style.overflowY = 'auto';

            // Formulaire pour les d√©tails du document avec logo et meilleure mise en page
            documentPopup.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px;">
                    <img src="/images/cedunet.png" alt="Logo Cedunet" style="max-width: 150px; max-height: 80px; margin-bottom: 10px;">
                    <h3 style="color: #333; margin: 10px 0 5px 0; font-size: 18px;" data-i18n="payment_receipt_heading">RE√áU DE PAIEMENT</h3>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="font-weight: bold; font-size: 12px; display: block;" data-i18n="label_name">Nom:</label>
                        <input type="text" id="documentNom" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd; background-color: #f8f9fa;">
                    </div>
                    <div>
                        <label style="font-weight: bold; font-size: 12px; display: block;" data-i18n="label_date">Date:</label>
                        <input type="text" id="documentDate" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd; background-color: #f8f9fa;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="font-weight: bold; font-size: 12px; display: block;" data-i18n="label_price">Prix:</label>
                        <input type="text" id="documentPrix" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd; background-color: #f8f9fa;">
                    </div>
                    <div>
                        <label style="font-weight: bold; font-size: 12px; display: block;" data-i18n="label_location">Lieu:</label>
                        <input type="text" id="documentLieu" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd; background-color: #f8f9fa;">
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold; font-size: 12px; display: block;" data-i18n="label_work">Travail:</label>
                    <input type="text" id="documentTravail" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd; background-color: #f8f9fa;">
                </div>

                <div style="background-color: #f0f0f0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #333; margin: 0 0 10px 0; text-align: center; font-size: 14px;" data-i18n="label_bank_details">DONN√âES BANCAIRES</h4>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-weight: bold; font-size: 11px; display: block;" data-i18n="label_branch">Sucursale:</label>
                            <input type="text" id="documentBanco1" style="width: 100%; padding: 6px; margin: 3px 0; border-radius: 4px; border: 1px solid #ccc; background-color: white; font-size: 11px;">
                        </div>
                        <div>
                            <label style="font-weight: bold; font-size: 11px; display: block;" data-i18n="label_account_number">N¬∞ de compte:</label>
                            <input type="text" id="documentBanco2" style="width: 100%; padding: 6px; margin: 3px 0; border-radius: 4px; border: 1px solid #ccc; background-color: white; font-size: 11px;">
                        </div>
                    </div>

                    <div style="margin-top: 8px;">
                        <label style="font-weight: bold; font-size: 11px; display: block;" data-i18n="label_bank">Banque:</label>
                        <input type="text" id="documentBanco" style="width: 100%; padding: 6px; margin: 3px 0; border-radius: 4px; border: 1px solid #ccc; background-color: white; font-size: 11px;">
                    </div>

                    <div style="margin-top: 8px;">
                        <label style="font-weight: bold; font-size: 11px; display: block;" data-i18n="label_iban">IBAN:</label>
                        <input type="text" id="documentBanco3" style="width: 100%; padding: 6px; margin: 3px 0; border-radius: 4px; border: 1px solid #ccc; background-color: white; font-size: 11px;">
                    </div>

                    <div style="margin-top: 8px;">
                        <label style="font-weight: bold; font-size: 11px; display: block;" data-i18n="label_recipient">Destinataire:</label>
                        <input type="text" id="documentBanco4" style="width: 100%; padding: 6px; margin: 3px 0; border-radius: 4px; border: 1px solid #ccc; background-color: white; font-size: 11px;">
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                    <button id="enregistrerPaiement" style="padding: 10px 15px; border-radius: 5px; background-color: #28a745; border: none; color: white; font-weight: bold; flex: 1; cursor: pointer;" data-i18n="button_save_payment">Enregistrer paiement</button>
                    <button id="enregistrerEtAjouterPaiement" style="padding: 10px 15px; border-radius: 5px; background-color: #007bff; border: none; color: white; font-weight: bold; flex: 1; cursor: pointer;" data-i18n="button_save_and_add">Enregistrer et ajouter</button>
                    <button id="annuler" style="padding: 10px 15px; border-radius: 5px; background-color: #dc3545; border: none; color: white; font-weight: bold; flex: 1; cursor: pointer;" data-i18n="button_cancel">Annuler</button>
                </div>
            `;

            document.body.appendChild(documentPopup);

            // Remplir les valeurs depuis la ligne du tableau
            document.getElementById('documentNom').value = link.closest('tr').querySelector('[data-column="Nom"]').textContent;
            document.getElementById('documentDate').value = link.closest('tr').querySelector('[data-column="Date"]').textContent;
            document.getElementById('documentPrix').value = link.closest('tr').querySelector('[data-column="Prix"]').textContent;
            document.getElementById('documentTravail').value = link.closest('tr').querySelector('[data-column="Travail"]').textContent;
            document.getElementById('documentLieu').value = link.closest('tr').querySelector('[data-column="Lieu"]').textContent;

            // Appliquer les traductions
            documentPopup.querySelectorAll('[data-i18n]').forEach(element => {
                element.textContent = getTranslation(element.dataset.i18n);
            });

            // Charger les donn√©es bancaires
            chargerDonneesBancaires();

            // [Le reste du code pour dataURLtoBlob et les gestionnaires d'√©v√©nements reste identique...]
            function dataURLtoBlob(dataURL) {
                const arr = dataURL.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], { type: mime });
            }

            // G√©rer les boutons (le code reste identique)
            document.getElementById('enregistrerPaiement').addEventListener('click', function() {
                const documentData = {
                    nom: document.getElementById('documentNom').value,
                    date: document.getElementById('documentDate').value,
                    prix: document.getElementById('documentPrix').value,
                    travail: document.getElementById('documentTravail').value,
                    lieu: document.getElementById('documentLieu').value,
                    banque: document.getElementById('documentBanco').value
                };

                const file = new Blob([JSON.stringify(documentData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.href = url;
                const fileNamePrefix = getTranslation('file_name_payment_prefix');
                a.download = `${documentData.nom}_${fileNamePrefix}.json`;
                document.body.appendChild(a);
                a.click();

                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);

                alert(getTranslation('alert_payment_saved_locally'));
                document.body.removeChild(documentPopup);
            });

            document.getElementById('enregistrerEtAjouterPaiement').addEventListener('click', function() {
                html2canvas(documentPopup).then(canvas => {
                    const imageBase64 = canvas.toDataURL("image/png");
                    const blob = dataURLtoBlob(imageBase64);
                    const userId = link.closest('tr').dataset.userId;

                    supabase.storage
                        .from('facturas_fran')
                        .upload(`facturas_fran/${userId}/document_image.png`, blob)
                        .then(({ data, error }) => {
                            if (error) {
                                console.error(getTranslation('error_uploading_image'), error);
                                showTemporaryMessage(getTranslation('temp_msg_error_uploading_image'));
                            } else {
                                showTemporaryMessage(getTranslation('temp_msg_document_converted_uploaded'));

                                supabase
                                    .from('event_quot1_fran')
                                    .update({ paiement: data.path })
                                    .eq('user_id', userId)
                                    .then(({ error: updateError }) => {
                                        if (updateError) {
                                            console.error(getTranslation('error_updating_event_quot1_fran_colon'), updateError);
                                        } else {
                                            console.log(getTranslation('log_payment_updated_success_event_quot1_fran'));
                                        }
                                    });

                                link.textContent = getTranslation('link_view_payment');
                                link.dataset.paiement = data.path;
                                document.body.removeChild(documentPopup);

                                const row = link.closest('tr');
                                if (row) {
                                    applyChangesWithoutPrompt(row, false);
                                }
                            }
                        });
                });
            });

            document.getElementById('annuler').addEventListener('click', function() {
                document.body.removeChild(documentPopup);
            });
        }

        // ---------------------------------------------------------------------------------------------------------
        // ---------------------------------------------------------------------------------------------------------
        // ---------------------------------------------------------------------------------------------------------


        // --- NOUVELLE VERSION de openNotaDeVentaPopup(link) ---
        function openNotaDeVentaPopup(link) {
            // Si le popup existe d√©j√†, on le ferme avant d'en cr√©er un nouveau
            const existingPopup = document.getElementById('notaDeVentaPopup');
            if (existingPopup) {
                document.body.removeChild(existingPopup);
            }

            // Cr√©ation du popup de la "nota de venta" (styles am√©lior√©s)
            const notaDeVentaPopup = document.createElement('div');
            notaDeVentaPopup.id = 'notaDeVentaPopup';
            Object.assign(notaDeVentaPopup.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                padding: '25px', // Plus de padding
                backgroundColor: '#f9f9f9',
                border: '1px solid #ccc',
                boxShadow: '0px 0px 10px rgba(0,0,0,0.3)', // Ombre plus prononc√©e
                borderRadius: '10px', // Bords plus arrondis
                zIndex: '1000',
                fontFamily: 'Arial, sans-serif',
                width: 'auto', // Largeur auto pour s'adapter au contenu
                maxWidth: '500px', // Largeur maximale
                height: 'auto',
                display: 'flex',
                flexDirection: 'column',
                gap: '15px' // Espace entre les √©l√©ments
            });

            const title = document.createElement('h3');
            title.textContent = getTranslation('sales_note_creation_title'); // Traduire
            Object.assign(title.style, {
                textAlign: 'center',
                color: '#333',
                marginBottom: '15px'
            });
            notaDeVentaPopup.appendChild(title);

            // R√©cup√©rer les donn√©es de la ligne pour le service (client, date, prix, etc.)
            const row = link.closest('tr');
            const eventData = {
                date: row.querySelector('[data-column="Date"]').textContent.trim(),
                nom: row.querySelector('[data-column="Nom"]').textContent.trim(),
                lieu: row.querySelector('[data-column="Lieu"]').textContent.trim(),
                travail: row.querySelector('[data-column="Travail"]').textContent.trim(),
                prix: row.querySelector('[data-column="Prix"]').textContent.trim(),
                heure: row.querySelector('[data-column="Heure"]').textContent.trim(),
                eventId: row.dataset.id, // Assurez-vous que votre tr a data-id="<event_id>"
                userId: row.dataset.userId // Assurez-vous que votre tr a data-user-id="<user_id>"
            };

            // Champs de saisie pour les informations de l'entreprise (persistance avec localStorage)
            const entrepriseNomInput = createInputField(getTranslation('label_company_name'), 'text', getTranslation('placeholder_my_company'), 'entrepriseNom'); // Traduire
            const entrepriseAdresseInput = createInputField(getTranslation('label_company_address'), 'text', getTranslation('placeholder_company_address'), 'entrepriseAdresse'); // Traduire
            const entrepriseTelInput = createInputField(getTranslation('label_company_phone'), 'text', getTranslation('placeholder_company_phone'), 'entrepriseTel'); // Traduire
            const entrepriseEmailInput = createInputField(getTranslation('label_company_email'), 'email', getTranslation('placeholder_company_email'), 'entrepriseEmail'); // Traduire
            const entrepriseWebInput = createInputField(getTranslation('label_company_website'), 'text', getTranslation('placeholder_company_website'), 'entrepriseWeb'); // Traduire

            notaDeVentaPopup.appendChild(entrepriseNomInput);
            notaDeVentaPopup.appendChild(entrepriseAdresseInput);
            notaDeVentaPopup.appendChild(entrepriseTelInput);
            notaDeVentaPopup.appendChild(entrepriseEmailInput);
            notaDeVentaPopup.appendChild(entrepriseWebInput);


            // Conteneur pour les boutons d'action
            const buttonContainer = document.createElement('div');
            Object.assign(buttonContainer.style, {
                display: 'flex',
                justifyContent: 'space-around',
                marginTop: '20px',
                gap: '10px'
            });
            notaDeVentaPopup.appendChild(buttonContainer);

            // Bouton "G√©n√©rer & Enregistrer la Note de vente (PDF)"
            const generateAndSaveBtn = document.createElement('button');
            generateAndSaveBtn.textContent = getTranslation('button_generate_save_sales_note_pdf'); // Traduire
            Object.assign(generateAndSaveBtn.style, {
                padding: '10px 15px',
                backgroundColor: '#4CAF50',
                color: 'white',
                border: 'none',
                borderRadius: '5px',
                cursor: 'pointer',
                fontSize: '1em'
            });
            generateAndSaveBtn.addEventListener('click', async () => {
                // Collecter les donn√©es de l'entreprise au moment de la g√©n√©ration
                const entrepriseData = {
                    nom: entrepriseNomInput.querySelector('input').value,
                    adresse: entrepriseAdresseInput.querySelector('input').value,
                    tel: entrepriseTelInput.querySelector('input').value,
                    email: entrepriseEmailInput.querySelector('input').value,
                    web: entrepriseWebInput.querySelector('input').value
                };
                await generatePdfNotaDeVenta(eventData, link, notaDeVentaPopup, entrepriseData);
            });
            buttonContainer.appendChild(generateAndSaveBtn);

            // Bouton "Fermer"
            const closeBtn = document.createElement('button');
            closeBtn.textContent = getTranslation('button_close'); // Traduire
            Object.assign(closeBtn.style, {
                padding: '10px 15px',
                backgroundColor: '#f44336',
                color: 'white',
                border: 'none',
                borderRadius: '5px',
                cursor: 'pointer',
                fontSize: '1em'
            });
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(notaDeVentaPopup);
            });
            buttonContainer.appendChild(closeBtn);

            // Ajouter le popup au document body
            document.body.appendChild(notaDeVentaPopup);

            // Fonction utilitaire pour cr√©er un champ d'input avec label (pour les infos entreprise)
            function createInputField(labelText, type, placeholder, id) {
                const div = document.createElement('div');
                Object.assign(div.style, {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    marginBottom: '5px'
                });

                const label = document.createElement('label');
                label.textContent = labelText;
                label.htmlFor = id;
                Object.assign(label.style, {
                    minWidth: '170px',
                    fontWeight: 'bold',
                    color: '#555'
                });

                const input = document.createElement('input');
                input.type = type;
                input.id = id;
                input.placeholder = placeholder;
                Object.assign(input.style, {
                    flexGrow: '1',
                    padding: '8px',
                    border: '1px solid #ccc',
                    borderRadius: '4px'
                });

                // Charger la valeur depuis localStorage ou utiliser le placeholder
                input.value = localStorage.getItem(`notaVenta_${id}`) || placeholder;
                input.addEventListener('input', () => {
                    // Sauvegarder la valeur dans localStorage √† chaque modification
                    localStorage.setItem(`notaVenta_${id}`, input.value);
                });

                div.appendChild(label);
                div.appendChild(input);
                return div;
            }
        }

        // --- NOUVELLE FONCTION pour g√©n√©rer le PDF et l'enregistrer dans Supabase ---
        async function generatePdfNotaDeVenta(eventData, link, notaDeVentaPopup, entrepriseData) {
            showTemporaryMessage(getTranslation('temp_msg_generating_saving_sales_note'), 'info'); // Traduire

            // eslint-disable-next-line no-undef
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Coordonn√©es de base (en mm)
            const marginX = 20; // Marge gauche/droite
            let currentY = 20; // Position Y de d√©part

            // --- Chargement et ajout du logo de l'entreprise ---
            const logoImg = new Image();
            logoImg.src = './images/logo entreprise.png'; // VOTRE CHEMIN DE LOGO CONFIRM√â

            // Log pour v√©rifier le chemin du logo
            console.log(getTranslation('log_logo_path'), logoImg.src); // Traduire

            logoImg.onload = async () => {
                try {
                    // Log pour v√©rifier les donn√©es de l'image du logo une fois charg√©e
                    console.log(getTranslation('log_logo_loaded_dimensions'), logoImg.naturalWidth, logoImg.naturalHeight); // Traduire

                    // Dimensions du logo dans le PDF (ajustez si n√©cessaire)
                    const logoWidth = 60; // Largeur d√©sir√©e en mm
                    const logoHeight = (logoImg.naturalHeight / logoImg.naturalWidth) * logoWidth;
                    doc.addImage(logoImg, 'PNG', marginX, currentY, logoWidth, logoHeight);

                    // D√©placer le Y apr√®s le logo
                    currentY += logoHeight + 10;

                    // --- Informations de l'entreprise (en haut √† droite) ---
                    const rightAlignX = doc.internal.pageSize.width - marginX; // C√¥t√© droit du document avec marge

                    // Logs pour v√©rifier les donn√©es de l'entreprise
                    console.log(getTranslation('log_company_data'), entrepriseData); // Traduire

                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(entrepriseData.nom, rightAlignX, 20, { align: 'right' });
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text(entrepriseData.adresse, rightAlignX, 26, { align: 'right' });
                    doc.text(`${getTranslation('label_phone_short')}: ${entrepriseData.tel}`, rightAlignX, 32, { align: 'right' }); // Traduire
                    doc.text(`${getTranslation('label_email_short')}: ${entrepriseData.email}`, rightAlignX, 38, { align: 'right' }); // Traduire
                    doc.text(`${getTranslation('label_website_short')}: ${entrepriseData.web}`, rightAlignX, 44, { align: 'right' }); // Traduire


                    // --- Titre du document ---
                    doc.setFontSize(24);
                    doc.setFont("helvetica", "bold");
                    doc.text(getTranslation('pdf_title_sales_certificate'), doc.internal.pageSize.width / 2, 70, { align: 'center' }); // Traduire
                    currentY = 85; // Ajuster le Y apr√®s le titre

                    // --- Num√©ro de Note et Date ---
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");

                    // Logs pour v√©rifier eventData.eventId et eventData.date
                    console.log(getTranslation('log_event_id'), eventData.eventId); // Traduire
                    console.log(getTranslation('log_event_date'), eventData.date); // Traduire

                    doc.text(`${getTranslation('pdf_sales_certificate_number')} : ${eventData.eventId}`, rightAlignX, currentY, { align: 'right' }); // Traduire
                    doc.text(`${getTranslation('pdf_date')} : ${eventData.date}`, rightAlignX, currentY + 6, { align: 'right' }); // Traduire
                    currentY += 20;

                    // --- Informations du client ---
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${getTranslation('pdf_client_name')} :`, marginX, currentY); // Traduire
                    doc.setFont("helvetica", "normal");

                    // Logs pour v√©rifier eventData.nom et eventData.lieu
                    console.log(getTranslation('log_event_name'), eventData.nom); // Traduire
                    console.log(getTranslation('log_event_location'), eventData.lieu); // Traduire

                    doc.text(eventData.nom, marginX + 35, currentY); // Ajuster l'indentation
                    currentY += 6;
                    doc.setFont("helvetica", "bold");
                    doc.text(`${getTranslation('pdf_location')} :`, marginX, currentY); // Traduire
                    doc.setFont("helvetica", "normal");
                    doc.text(eventData.lieu, marginX + 35, currentY);
                    currentY += 15; // Espacement avant le tableau

                    // --- Tableau des articles avec jspdf-autotable ---
                    const headers = [
                        [getTranslation('pdf_table_header_num'), getTranslation('pdf_table_header_quantity'), getTranslation('pdf_table_header_description'), getTranslation('pdf_table_header_unit_price'), getTranslation('pdf_table_header_amount')] // Traduire
                    ];

                    // Log pour v√©rifier le prix avant conversion
                    console.log(getTranslation('log_price_before_conversion'), eventData.prix); // Traduire
                    const prixFloat = parseFloat(eventData.prix.replace(',', '.'));
                    console.log(getTranslation('log_price_after_conversion'), prixFloat); // Log pour le prix apr√®s conversion

                    const body = [
                        [1, 1, eventData.travail, `${prixFloat.toFixed(2)} ‚Ç¨`, `${prixFloat.toFixed(2)} ‚Ç¨`]
                    ];

                    // Log pour v√©rifier le corps du tableau
                    console.log(getTranslation('log_table_body'), body); // Traduire

                    doc.autoTable({
                        startY: currentY,
                        head: headers,
                        body: body,
                        theme: 'grid',
                        styles: { fontSize: 10, cellPadding: 3, overflow: 'linebreak' },
                        headStyles: { fillColor: [255, 102, 0], textColor: [255, 255, 255], fontStyle: 'bold' },
                        margin: { left: marginX, right: marginX },
                        columnStyles: {
                            0: { cellWidth: 15, halign: 'center' },
                            1: { cellWidth: 20, halign: 'center' },
                            2: { cellWidth: 'auto', minCellWidth: 60 },
                            3: { cellWidth: 30, halign: 'right' },
                            4: { cellWidth: 30, halign: 'right' }
                        }
                    });

                    currentY = doc.autoTable.previous.finalY + 10;

                    // --- Sous-total, Taxes, Total ---
                    const valueColX = rightAlignX - 40;

                    // Logs pour v√©rifier les totaux
                    console.log(getTranslation('log_subtotal'), prixFloat.toFixed(2)); // Traduire
                    const taxes = prixFloat * 0.15; // Exemple de calcul de taxes √† 15%
                    const totalWithTaxes = prixFloat + taxes;
                    console.log(getTranslation('log_taxes'), taxes.toFixed(2)); // Traduire
                    console.log(getTranslation('log_total_with_taxes'), totalWithTaxes.toFixed(2)); // Traduire

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text(`${getTranslation('pdf_subtotal')} :`, valueColX, currentY, { align: 'right' }); // Traduire
                    doc.text(`${prixFloat.toFixed(2)} ‚Ç¨`, rightAlignX, currentY, { align: 'right' });
                    currentY += 6;

                    doc.text(`${getTranslation('pdf_taxes')} (15%) :`, valueColX, currentY, { align: 'right' }); // Traduire
                    doc.text(`${taxes.toFixed(2)} ‚Ç¨`, rightAlignX, currentY, { align: 'right' });
                    currentY += 6;

                    doc.setFont("helvetica", "bold");
                    doc.text(`${getTranslation('pdf_total')} :`, valueColX, currentY, { align: 'right' }); // Traduire
                    doc.text(`${totalWithTaxes.toFixed(2)} ‚Ç¨`, rightAlignX, currentY, { align: 'right' });
                    currentY += 15;

                    // --- Pied de page g√©n√©ral (informations de l'entreprise en bas) ---
                    const footerY = doc.internal.pageSize.height - 15;
                    doc.setFontSize(8);
                    doc.setFont("helvetica", "normal");
                    doc.text(entrepriseData.nom, doc.internal.pageSize.width / 2, footerY - 5, { align: 'center' });
                    doc.text(entrepriseData.web, doc.internal.pageSize.width / 2, footerY, { align: 'center' });
                    doc.text(`${entrepriseData.email} / ${entrepriseData.tel}`, doc.internal.pageSize.width / 2, footerY + 5, { align: 'center' });


                    // --- Enregistrer le PDF dans Supabase ---
                    const pdfBlob = doc.output('blob'); // Obtenir le PDF en tant que Blob

                    const userId = eventData.userId;
                    const eventId = eventData.eventId;
                    const safeClientName = eventData.nom.replace(/[^a-zA-Z0-9]/g, '_');
                    const fileName = `${getTranslation('pdf_file_name_prefix')}_${safeClientName}_${eventId}.pdf`; // Traduire

                    // Logs pour l'upload Supabase
                    console.log(getTranslation('log_supabase_upload_preparation')); // Traduire
                    console.log(getTranslation('log_user_id_for_upload'), userId); // Traduire
                    console.log(getTranslation('log_event_id_for_upload'), eventId); // Traduire
                    console.log(getTranslation('log_file_name_for_upload'), fileName); // Traduire


                    if (!userId || !eventId) {
                        console.error(getTranslation("error_missing_user_event_id")); // Traduire
                        showTemporaryMessage(getTranslation("error_incomplete_event_data"), 'error'); // Traduire
                        return;
                    }

                    const { data, error } = await supabase.storage
                        .from('facturas_fran')
                        .upload(`facturas_fran/${userId}/${fileName}`, pdfBlob, { // C'√©tait 'facturas_fran' ici
                            cacheControl: '3600',
                            upsert: true
                        });

                    // Log de la r√©ponse d'upload
                    console.log(getTranslation('log_supabase_upload_response_data'), data); // Traduire
                    console.log(getTranslation('log_supabase_upload_response_error'), error); // Traduire


                    if (error) {
                        console.error(getTranslation('error_saving_pdf'), error); // Traduire
                        showTemporaryMessage(getTranslation('error_saving_pdf_message') + error.message, 'error'); // Traduire
                        return;
                    }

                    showTemporaryMessage(getTranslation('temp_msg_sales_note_generated_uploaded')); // Traduire

                    // Mettre √† jour le lien "paiement" dans la table Supabase `event_quot1_fran`
                    // Log pour le chemin de mise √† jour dans la DB
                    console.log(getTranslation('log_payment_path_to_update'), data.path); // Traduire
                    console.log(getTranslation('log_event_user_id_for_update'), eventId); // Note: Assurez-vous que eventId est bien l'ID de l'utilisateur pour cette ligne.

                    const { error: updateError } = await supabase
                        .from('event_quot1_fran')
                        .update({ paiement: data.path })
                        .eq('user_id', eventId);

                    if (updateError) {
                        console.error(getTranslation('error_updating_event_quot1_fran_colon'), updateError); // Traduire
                        showTemporaryMessage(getTranslation('error_updating_pdf_link_db'), 'error'); // Traduire
                    } else {
                        console.log(getTranslation('log_sales_note_updated_success_event_quot1_fran')); // Traduire
                        showTemporaryMessage(getTranslation('temp_msg_sales_note_link_updated_db')); // Traduire
                    }

                    // Mettre √† jour le lien "Voir la note de vente" dans l'interface utilisateur
                    link.textContent = getTranslation('link_view_sales_note'); // Traduire
                    link.dataset.paiement = data.path;

                    // Fermer le popup
                    document.body.removeChild(notaDeVentaPopup);

                    // Simuler le clic sur "Appliquer changem."
                    const row = link.closest('tr');
                    if (row) {
                        applyChangesWithoutPrompt(row, false);
                    }

                } catch (e) {
                    console.error(getTranslation("error_unexpected_pdf_generation_save"), e); // Traduire
                    showTemporaryMessage(getTranslation("error_unexpected_pdf_creation"), 'error'); // Traduire
                }
            };

            // G√©rer le cas o√π le logo ne peut pas √™tre charg√©
            logoImg.onerror = () => {
                console.error(getTranslation("error_loading_logo_path_check")); // Traduire
                showTemporaryMessage(getTranslation("error_logo_not_found_incorrect_path"), 'error'); // Traduire
                // Optionnel: vous pouvez appeler une version de generatePdfNotaDeVenta sans logo ici
                // si vous voulez que le PDF soit g√©n√©r√© m√™me sans l'image.
                // Pour l'instant, l'erreur est juste loggu√©e.
            };
        }

        // ---------------------------------------------------------------------------------------------------------
        // ---------------------------------------------------------------------------------------------------------
        // ---------------------------------------------------------------------------------------------------------

        // Assurer que handleDateClick est d√©fini une seule fois
        if (typeof handleDateClick === 'undefined') {
            async function handleDateClick(event) {
                const date = event.target.textContent;
                const formattedDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;

                console.log('fetchEventsByDate called for date:', formattedDate);
                // await fetchEventsByDate(formattedDate);
            }
        }

        // Fonction pour effacer les champs du formulaire
        function clearFormFields() {
            const fields = ['T√©l√©phone', 'Nom', 'Date', 'Min', 'Lieu', 'Prix', 'Travail', 'Ajout√©_pour'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = '';
                }
            });
            // Remettre les cases √† cocher √† false
            const envDonn√©esCheckbox = document.getElementById('env_donn√©es');
            if (envDonn√©esCheckbox) envDonn√©esCheckbox.checked = false;
            const pay√©Checkbox = document.getElementById('pay√©');
            if (pay√©Checkbox) pay√©Checkbox.checked = false;
        }

        // -------------------------------------------------------------------------
        // FORMULAIRE NOUVEL EVENEMENT
        // -------------------------------------------------------------------------

        document.getElementById('addEventButton').addEventListener('click', async function() {
            // R√©cup√®re les valeurs ou assigne null si l'√©l√©ment est absent ou vide
            const t√©l√©phone = document.getElementById('T√©l√©phone') ? document.getElementById('T√©l√©phone').value || null : null;
            const nom = document.getElementById('Nom') ? document.getElementById('Nom').value || null : null;
            const date = document.getElementById('Date') ? document.getElementById('Date').value || null : null;
            const heure = document.getElementById('Heure') ? document.getElementById('Heure').value || null : null;
            const min = document.getElementById('Min') ? document.getElementById('Min').value || null : null;
            const lieu = document.getElementById('Lieu') ? document.getElementById('Lieu').value || null : null;
            const prix = document.getElementById('Prix') ? document.getElementById('Prix').value || null : null;
            const observations = "";
            const employeSelect = document.getElementById('employeSelect');
            const ajout√©_pour = employeSelect ? employeSelect.value || null : null;

            const travail = document.getElementById('Travail') ? document.getElementById('Travail').value || null : null;

            // Nouvelles colonnes pour les photos
            const photo_avant_url = document.getElementById('PhotoAvant') ? document.getElementById('PhotoAvant').value || null : null;
            const photo_apres_url = document.getElementById('PhotoApres') ? document.getElementById('PhotoApres').value || null : null;


            // üîπ R√©cup√©ration des infos de r√©currence
            let recurrence_rule = null;
            const frequency = document.getElementById('recurrence-frequency')?.value || "none";
            if (frequency !== "none") {
                recurrence_rule = { frequency };

                if (frequency === "weekly") {
                    const selectedDays = Array.from(document.querySelectorAll("#weekly-options input[type=checkbox]:checked"))
                        .map(cb => cb.value);
                    if (selectedDays.length > 0) recurrence_rule.days = selectedDays;
                }

                if (frequency === "monthly") {
                    const dayOfMonth = document.getElementById("recurrence-dayOfMonth")?.value;
                    if (dayOfMonth) recurrence_rule.dayOfMonth = parseInt(dayOfMonth, 10);
                }

                if (frequency === "yearly") {
                    const month = document.getElementById("recurrence-month")?.value;
                    const day = document.getElementById("recurrence-day")?.value;
                    if (month && day) {
                        recurrence_rule.month = parseInt(month, 10);
                        recurrence_rule.day = parseInt(day, 10);
                    }
                }

                const endDate = document.getElementById("recurrence-endDate")?.value;
                if (endDate) recurrence_rule.endDate = endDate;
            }



            // V√©rification pour les cases √† cocher (checkboxes)
            const env_donn√©es_checkbox = document.getElementById('env_donn√©es');
            const env_donn√©es = env_donn√©es_checkbox ? env_donn√©es_checkbox.checked : false; // Si la case existe, utilise sa valeur, sinon, utilise false

            const pay√©_checkbox = document.getElementById('pay√©');
            const pay√© = pay√©_checkbox ? pay√©_checkbox.checked : false; // M√™me v√©rification pour 'pay√©'

            // Initialisation de la facture √† null, car elle n'est pas encore pr√©sente
            const paiement = null;

            // G√©n√©rer un UUID pour user_id
            const user_id = crypto.randomUUID();

            // Ajoutez des logs pour v√©rifier les valeurs
            console.log(getTranslation('log_phone'), t√©l√©phone); // Traduire
            console.log(getTranslation('log_name'), nom); // Traduire
            console.log(getTranslation('log_date'), date); // Traduire
            console.log(getTranslation('log_time'), heure); // Traduire
            console.log(getTranslation('log_min'), min); // Traduire
            console.log(getTranslation('log_location'), lieu); // Traduire
            console.log(getTranslation('log_price'), prix); // Traduire
            console.log(getTranslation('log_work'), travail); // Traduire
            console.log(getTranslation('log_user_id'), user_id); // Traduire

            // V√©rifier s'il existe une correspondance dans tableData1_fran
            const { data: existingData, error: fetchError } = await supabase
                .from('tableData1_fran')
                .select('*')
                .eq('T√©l√©phone', t√©l√©phone);

            if (fetchError) {
                console.error(getTranslation('error_checking_match'), fetchError); // Traduire
                return;
            }

            if (existingData && existingData.length > 0) {
                // Mettre √† jour les colonnes dans tableData1_fran
                const { error: updateError } = await supabase
                    .from('tableData1_fran')
                    .update({
                        Nom: nom || existingData[0].Nom,
                        Date: date || existingData[0].Date,
                        Heure: heure || existingData[0].Heure,
                        Min: min || existingData[0].Min,
                        Lieu: lieu || existingData[0].Lieu,
                        Prix: prix || existingData[0].Prix,
                        Travail: travail || existingData[0].Travail,
                        Ajout√©_pour: ajout√©_pour || existingData[0].Ajout√©_pour,
                        Observations: observations || existingData[0].Observations,
                        env_donn√©es: env_donn√©es || existingData[0].env_donn√©es,
                        paiement: paiement || existingData[0].paiement,
                        pay√©: pay√©,
                        photo_avant_url: photo_avant_url || existingData[0].photo_avant_url,
                        photo_apres_url: photo_apres_url || existingData[0].photo_apres_url,
                        recurrence_rule: recurrence_rule ? JSON.stringify(recurrence_rule) : existingData[0].recurrence_rule || null
                    })
                    .eq('T√©l√©phone', t√©l√©phone);


                if (updateError) {
                    console.error(getTranslation('error_updating_tableData1_fran'), updateError); // Traduire
                    return;
                } else {
                    console.log(getTranslation('log_tableData1_fran_updated_success')); // Traduire
                }
            } else {
                // Ins√©rer une nouvelle ligne dans tableData1_fran
                const { error: insertErrorTableData1_fran } = await supabase
                    .from('tableData1_fran')
                    .insert([{
                        T√©l√©phone: t√©l√©phone,
                        Nom: nom,
                        Date: date,
                        Heure: heure,
                        Min: min,
                        Lieu: lieu,
                        Prix: prix,
                        Travail: travail,
                        Observations: observations,
                        Ajout√©_pour: ajout√©_pour,
                        env_donn√©es: env_donn√©es,
                        paiement: paiement,
                        pay√©: pay√©,
                        photo_avant_url: photo_avant_url,
                        photo_apres_url: photo_apres_url,
                        recurrence_rule: recurrence_rule ? JSON.stringify(recurrence_rule) : null
                    }]);


                if (insertErrorTableData1_fran) {
                    console.error(getTranslation('error_adding_new_row_tableData1_fran'), insertErrorTableData1_fran); // Traduire
                    return;
                } else {
                    console.log(getTranslation('log_new_row_added_tableData1_fran_success')); // Traduire
                }
            }

            if (recurrence_rule && recurrence_rule.days) {
                console.log('Jours de r√©currence s√©lectionn√©s:', recurrence_rule.days);
            } else {
                console.log('Aucun jour de r√©currence s√©lectionn√©');
            }

            // üîπ G√©n√©rer toutes les dates de r√©currence avec indicateur
            const dates = await generateRecurrenceDatesWithLoading(date, recurrence_rule);
            console.log(getTranslation('log_generated_recurrence_dates'), dates);


            // üîπ G√©n√©rer un seul recurrenceId pour toute la s√©rie
            const recurrenceId = generateUUID();

            // üîπ Boucle sur chaque date et insert
            for (const d of dates) {
                const eventId = crypto.randomUUID(); // ‚úÖ On g√©n√®re l'ID une seule fois ici

                const { error: insertErrorEventQuot1_fran } = await supabase
                    .from('event_quot1_fran')
                    .insert([{
                        T√©l√©phone: t√©l√©phone,
                        Nom: nom,
                        Date: d, // ‚ö°Ô∏è chaque date g√©n√©r√©e
                        Heure: heure,
                        Min: min,
                        Lieu: lieu,
                        Prix: prix,
                        Travail: travail,
                        Observations: observations,
                        Ajout√©_pour: ajout√©_pour,
                        env_donn√©es: env_donn√©es,
                        paiement: paiement,
                        pay√©: pay√©,
                        user_id: eventId, // ‚ö°Ô∏è id unique par √©v√©nement
                        photo_avant_url: photo_avant_url,
                        photo_apres_url: photo_apres_url,
                        recurrence_rule: recurrence_rule ? JSON.stringify(recurrence_rule) : null,
                        recurrence_id: recurrenceId // ‚úÖ identique pour toute la s√©rie
                    }]);

                if (insertErrorEventQuot1_fran) {
                    console.error(getTranslation('error_adding_event'), insertErrorEventQuot1_fran); // Traduire
                } else {
                    console.log(getTranslation('log_event_added_success_for_date'), d); // Traduire

                    // ‚ö°Ô∏è Ajouter aussi dans historique_modif_fran
                    const modifiePar = localStorage.getItem("currentPersonName");
                    const dateModification = new Date().toISOString().slice(0, 19).replace("T", " ");

                    const { error: histoError } = await supabase
                        .from("historique_modif_fran")
                        .insert([{
                            user_id: eventId, // ‚úÖ On r√©utilise l'ID ici
                            modifi√©_par: modifiePar,
                            date_modification: dateModification,
                            champ_modifi√©: "√âv√©nement",
                            valeur_ancienne: null,
                            valeur_nouvelle: "Ajout de l'√©v√©nement",
                            action: "Ajout",
                            Nombre: nom || "-",
                            Telefono: t√©l√©phone || "-"
                        }]);

                    if (histoError) {
                        console.error("Erreur insertion historique_modif_fran:", histoError);
                    } else {
                        console.log("‚úÖ Historique ins√©r√© pour ajout d‚Äô√©v√©nement:", d);
                    }
                }
            } // ‚ö†Ô∏è L'accolade de fermeture de la boucle 'for' est bien ici.


            // ‚úÖ CODE DE RAFRA√éCHISSEMENT D√âPLAC√â EN DEHORS DE LA BOUCLE
            const selectedDate = document.getElementById('Date').value;

            if (selectedDate) {
                setTimeout(async () => { // <-- rendre la callback async
                    try {
                        await fetchEventsByDate(selectedDate);
                        console.log(getTranslation('log_events_fetched_for_date'));
                    } catch (error) {
                        console.error(getTranslation('error_refreshing_events'), error);
                    }
                }, 500);
            } else {
                console.error(getTranslation('error_no_date_selected_local_storage'));
            }
    });


            let isCalendarGenerated = false;
            let isTodaySelected = false;


            document.getElementById('T√©l√©phone').addEventListener('input', async function() {
                const t√©l√©phone = this.value;

                if (t√©l√©phone) {
                    // Requ√™te pour r√©cup√©rer les donn√©es de tableData1_fran o√π T√©l√©phone correspond
                    const { data, error } = await supabase
                        .from('tableData1_fran')
                        .select('Nom, Lieu')
                        .eq('T√©l√©phone', t√©l√©phone); // Comparer avec la colonne T√©l√©phone

                    if (error) {
                        console.error(getTranslation('error_fetching_data'), error); // Traduire
                    } else if (data.length > 0) {
                        const { Nom, Lieu } = data[0];
                        document.getElementById('Nom').value = Nom;
                        document.getElementById('Lieu').value = Lieu;
                    } else {
                        // Si aucun r√©sultat n'est trouv√©, vider les champs
                        document.getElementById('Nom').value = '';
                        document.getElementById('Lieu').value = '';
                    }
                } else {
                    // Si le champ de t√©l√©phone est vide, vider les champs
                    document.getElementById('Nom').value = '';
                    document.getElementById('Lieu').value = '';
                }
            });
        //--------------------------------------------------------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------------------------------------------------------



        async function saveTravailField(userId, fieldName, fieldValue, row) {
            try {
                console.log(`[saveTravailField] D√©but pour user_id=${userId}, field=${fieldName}, value=`, fieldValue);

                // --- 1. D√âTERMINER LE CHAMP √Ä METTRE √Ä JOUR ---
                let databaseFieldName;
                let localDataSetField;

                if (fieldName === "observations") {
                    databaseFieldName = "Observations";
                    localDataSetField = "observations"; // Si vous avez ce dataset
                } else if (fieldName === "Travail" || fieldName === "StatutTravail") {
                    databaseFieldName = "Travail";
                    localDataSetField = "travail";
                } else {
                    console.error(`‚ùå Champ inconnu: ${fieldName}`);
                    return;
                }

                // --- 2. R√âCUP√âRATION DE LA VALEUR ACTUELLE ---
                let currentValue = "";
                if (isOnline()) {
                    const { data: latestEvent, error: fetchError } = await supabase
                        .from("event_quot1_fran")
                        .select(databaseFieldName)
                        .eq("user_id", userId)
                        .single();

                    if (!fetchError && latestEvent) {
                        currentValue = latestEvent[databaseFieldName] || "";
                    }
                }

                if (!currentValue) {
                    currentValue = row.dataset[localDataSetField] || "";
                }

                // --- 3. PR√âPARATION DE LA MISE √Ä JOUR ---
                const ancienneValeur = currentValue;
                const telephone = row.querySelector('[data-column="T√©l√©phone"]').textContent.trim();

                // ‚úÖ CORRECTION : Utiliser le bon nom de champ
                const updatePayload = { [databaseFieldName]: fieldValue };

                // --- 4. ENREGISTREMENT DANS LA FILE D'ATTENTE ---
                await addToQueue({
                    type: 'UPDATE',
                    targetTable: 'event_quot1_fran',
                    targetId: { user_id: userId },
                    payload: updatePayload
                });

                await addToQueue({
                    type: 'UPDATE',
                    targetTable: 'tableData1_fran',
                    targetId: { T√©l√©phone: telephone },
                    payload: updatePayload
                });

                // --- 5. MISE √Ä JOUR LOCALE ---
                row.dataset[localDataSetField] = fieldValue;

                await logModification({
                    userId,
                    rendezvousActuel: null,
                    modifiePar: localStorage.getItem("currentPersonName"),
                    dateModification: getLocalDateTime(),
                    champ: fieldName,
                    ancienneValeur: ancienneValeur,
                    nouvelleValeur: fieldValue,
                    action: getTranslation("action_modification"),
                    nombre: row.querySelector('[data-column="Nom"]').textContent.trim(),
                    telephone: telephone,
                    extra: { travailField: fieldName }
                });

                // --- 6. SYNCHRONISATION ---
                if (isOnline()) {
                    console.log("üì° En ligne. Tentative de synchronisation imm√©diate.");
                    syncData();
                }

                console.log(`‚úÖ ${fieldName} mis √† jour localement.`);

            } catch (err) {
                console.error("[saveTravailField] Erreur:", err);
            }
        }

        // Mise √† jour de la fonction pour cibler les nouveaux champs
        function attachTravailListeners(row, event) {
            const userId = event.user_id;

            // 1. √âcouteur pour OBSERVATIONS (textarea)
            const observationTextarea = row.querySelector('[data-column="Observations"] textarea[data-field="observations"]');
            if (observationTextarea) {
                observationTextarea.addEventListener('blur', async () => {
                    const fieldValue = observationTextarea.value.trim();
                    console.log(`[blur] Observations =`, fieldValue);
                    await saveTravailField(userId, "observations", fieldValue, row);
                });
            }

            // 2. √âcouteur pour TRAVAIL (select)
            const travailFields = row.querySelectorAll('.travail-content [data-field]');
            travailFields.forEach(field => {
                if (field.tagName.toLowerCase() === "select") {
                    field.addEventListener("change", async function () {
                        console.log(`[change] Select ${field.dataset.field} =`, field.value);
                        await saveTravailField(userId, field.dataset.field, field.value, row);
                    });
                }
            });
        }



        document.getElementById("recurrence-frequency").addEventListener("change", (e) => {
            const frequency = e.target.value;

            // Tout cacher
            document.getElementById("weekly-options").style.display = "none";
            document.getElementById("monthly-options").style.display = "none";
            document.getElementById("yearly-options").style.display = "none";

            // Montrer seulement le bon
            if (frequency === "weekly") {
              document.getElementById("weekly-options").style.display = "block";
            } else if (frequency === "monthly") {
              document.getElementById("monthly-options").style.display = "block";
            } else if (frequency === "yearly") {
              document.getElementById("yearly-options").style.display = "block";
            }
        });

        // Fonction g√©n√©rique pour la g√©olocalisation et l'enregistrement
        async function handleCheckinCheckout(row, type) {
          try {
            const id_code = localStorage.getItem("currentPersonIdCode"); // employ√© connect√©
            const modifie_par = localStorage.getItem("currentPersonName"); // nom visible
            const user_id = row.dataset.userId; // identifiant de l'√©v√©nement
            const phone = row.querySelector('[data-column="T√©l√©phone"]').textContent.trim();
            const nom = row.querySelector('[data-column="Nom"]').textContent.trim();

            if (!id_code || !user_id) {
              console.error("‚ùå ID employ√© ou ID √©v√©nement manquant :", { id_code, user_id });
              alert("Impossible d'enregistrer le pointage : identifiant manquant.");
              return;
            }

            const button = row.querySelector(".btn-toggle-onss");
            button.disabled = true;

            // --- 1Ô∏è‚É£ Obtenir la g√©olocalisation ---
            const position = await new Promise((resolve, reject) => {
              if (!navigator.geolocation) return reject(new Error("G√©olocalisation non support√©e."));
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0,
              });
            });

            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const maps_url = `https://www.google.com/maps?q=${lat},${lon}`;
            const now = new Date().toISOString();
            let flag_anomalie = false;

            // --- üß≠ 2Ô∏è‚É£ V√©rification de la distance avec le dernier pointage d‚Äôentr√©e ---
            if (type === "out") {
              const { data: lastEntry, error: lastError } = await supabase
                .from("pointage_onss_history_fran")
                .select("latitude, longitude, type")
                .eq("id_code", id_code)
                .eq("user_id", user_id) // ‚¨ÖÔ∏è AJOUT CRITIQUE : filtrer par √©v√©nement sp√©cifique
                .order("timestamp", { ascending: false })
                .limit(1)
                .single();

              if (!lastError && lastEntry && lastEntry.type === "in") {
                const distance = haversineDistance(
                  lastEntry.latitude,
                  lastEntry.longitude,
                  lat,
                  lon
                );

                console.log(`üìè Distance entre entr√©e et sortie : ${distance.toFixed(2)} km`);

                if (distance > 1) {
                  const confirmExit = confirm(
                    "‚ö†Ô∏è Le point de sortie est √©loign√© de plus de 1 km du point d‚Äôentr√©e.\n√ätes-vous s√ªr d'√™tre au m√™me endroit ?"
                  );

                  if (!confirmExit) {
                    alert("Sortie non enregistr√©e. Veuillez vous rapprocher du point d'entr√©e.");
                    return;
                  }

                  // Si confirm√© ‚Üí on marque une anomalie
                  flag_anomalie = true;
                }
              }
            }

            // --- 3Ô∏è‚É£ Enregistrement dans la table pointage_onss_history_fran ---
            const insertData = {
              id_code,          // employ√© connect√©
              user_id,          // √©v√©nement
              type,             // 'in' ou 'out'
              timestamp: now,
              latitude: lat,
              longitude: lon,
              maps_url,
              source: "frontend",
              telephone: phone,
              nom,
              modifie_par,
              flag_anomalie // ‚úÖ nouvelle colonne
            };

            const { error } = await supabase.from("pointage_onss_history_fran").insert([insertData]);

            if (error) {
              console.error("‚ùå Erreur d'insertion dans Supabase :", error);
              alert("Erreur lors de l'enregistrement du pointage.");
              return;
            }

            console.log(`‚úÖ Pointage ${type === "in" ? "Entr√©e" : "Sortie"} enregistr√© :`, insertData);
            if (flag_anomalie) alert("‚ö†Ô∏è Sortie enregistr√©e avec alerte (distance > 1 km)");

            // --- 4Ô∏è‚É£ Envoi √† Geodynamics (si disponible) ---
            try {
              const backendUrl = "https://geodynamics-bridge-production.up.railway.app";
              const endpoint = `${backendUrl}/api/geodynamics/${type === "in" ? "checkin" : "checkout"}`;

              // R√âCUP√âRER LE GEODYNAMICS_ID DEPUIS LA TABLE ACCESS_CODE1_FRAN
              const { data: employeData, error: employeError } = await supabase
                .from("access_code1_fran")
                .select("geodynamics_id")
                .eq("id_code", id_code)
                .single();

              console.log("üîç Recherche geodynamics_id pour id_code:", id_code);
              console.log("üìã Donn√©es employ√© trouv√©es:", employeData);

              if (employeError || !employeData || !employeData.geodynamics_id) {
                console.warn("‚ö†Ô∏è Aucun geodynamics_id configur√© pour cet employ√©:", id_code);
                return;
              }

              const geodynamicsId = employeData.geodynamics_id;
              console.log("‚úÖ geodynamics_id trouv√© et utilis√©:", geodynamicsId);

              const response = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  employeeId: geodynamicsId, // Code utilisateur: 123
                  vehicleId: "456", // Code v√©hicule fourni par Geodynamics
                  timestamp: now,
                  // ‚ö†Ô∏è NE PAS envoyer lat/lon - l'API ne les accepte pas
                }),
              });

              const result = await response.json();

              if (!response.ok) {
                console.error("‚ö†Ô∏è Erreur Geodynamics :", result);
              } else {
                console.log("‚úÖ Envoi Geodynamics r√©ussi :", result);
              }
            } catch (err) {
              console.error("‚ùå Erreur de communication avec Geodynamics :", err);
            }


            // --- 5Ô∏è‚É£ Mise √† jour de l'affichage ---
            await loadPointageHistory(row);
            button.textContent = type === "in" ? "Sortie" : "Entr√©e";
            button.classList.toggle("btn-in", type === "in");
            button.classList.toggle("btn-out", type === "out");

          } catch (error) {
            console.error("‚ùå Erreur de g√©olocalisation ou d'enregistrement :", error);
            alert("Impossible d'obtenir la g√©olocalisation ou d'enregistrer le pointage.");
          } finally {
            const button = row.querySelector(".btn-toggle-onss");
            if (button) button.disabled = false;
          }
        }




        // ---------------------------------------------------------------------


        // üîπ Charger et afficher l'historique des pointages ONSS pour un employ√©
        async function loadPointageHistory(row) {
          const isConfigUser = localStorage.getItem("currentPersonIsConfigUser") === "true";
          const currentIdCode = localStorage.getItem("currentPersonIdCode");
          const historyContainer = row.querySelector(".pointage-history");
          const btnToggle = row.querySelector(".btn-toggle-onss");

          if (!historyContainer) return;
          historyContainer.innerHTML = "Chargement...";

          // üîπ R√©cup√©ration de l'id_code employ√© depuis la ligne
          const idCodeEmploye = row.dataset.idCode;
          // üîπ R√©cup√©ration du user_id (√©v√©nement) depuis la ligne
          const userId = row.dataset.userId; // ‚¨ÖÔ∏è IMPORTANT : r√©cup√©rer l'√©v√©nement

          // üîπ Si c'est un utilisateur normal ‚Üí on charge son propre id_code
          // üîπ Si c'est un configUser ‚Üí on charge celui li√© √† la ligne (employ√©)
          const idCodeToLoad = isConfigUser ? idCodeEmploye : currentIdCode;

          // üß© V√©rification avant d'appeler Supabase
          if (!idCodeToLoad || idCodeToLoad === "undefined") {
            console.warn("‚ö†Ô∏è Aucun id_code valide trouv√© pour cette ligne :", {
              isConfigUser,
              idCodeEmploye,
              currentIdCode,
            });
            historyContainer.textContent = "Aucun identifiant valide trouv√©.";
            if (btnToggle) {
              btnToggle.textContent = isConfigUser ? "Consultation" : "Entr√©e";
              btnToggle.disabled = isConfigUser;
              btnToggle.style.opacity = isConfigUser ? "0.5" : "1";
              btnToggle.style.cursor = isConfigUser ? "not-allowed" : "pointer";
            }
            return;
          }

          // üîπ Requ√™te Supabase - FILTRER PAR √âV√âNEMENT SP√âCIFIQUE
          const { data, error } = await supabase
            .from("pointage_onss_history_fran")
            .select("*")
            .eq("id_code", idCodeToLoad)
            .eq("user_id", userId) // ‚¨ÖÔ∏è AJOUT CRITIQUE : filtrer par √©v√©nement
            .order("timestamp", { ascending: false });

          if (error) {
            console.error("Erreur chargement historique :", error);
            historyContainer.textContent = "Erreur de chargement.";
            return;
          }

          if (!data || data.length === 0) {
            historyContainer.textContent = "Aucun pointage enregistr√©.";
            if (btnToggle) {
              if (isConfigUser) {
                btnToggle.textContent = "Consultation";
                btnToggle.disabled = true;
                btnToggle.style.opacity = "0.5";
                btnToggle.style.cursor = "not-allowed";
              } else {
                btnToggle.textContent = "Entr√©e";
                btnToggle.dataset.state = "in";
              }
            }
            return;
          }

          const LOCATIONIQ_TOKEN = "pk.6b42b2b6259674bc2018ddf950ae757a";

          historyContainer.innerHTML = data
            .map(
              (entry) => `
                <div class="pointage-entry">
                  ${entry.type === "in" ? "üü¢ <strong>Entr√©e</strong>" : "üî¥ <strong>Sortie</strong>"}${entry.flag_anomalie ? " ‚ö†Ô∏è" : ""}<br>
                  ${new Date(entry.timestamp).toLocaleDateString()}<br>
                  ${new Date(entry.timestamp).toLocaleTimeString()}<br>
                  <a href="${entry.maps_url}" target="_blank">
                    <img
                      src="https://maps.locationiq.com/v3/staticmap?key=${LOCATIONIQ_TOKEN}&center=${entry.latitude},${entry.longitude}&zoom=18&size=200x200&markers=icon:small-red-cutout|${entry.latitude},${entry.longitude}"
                      alt="Carte"
                      style="width:2cm; height:2cm; border-radius:4px; border:1px solid #ccc;"
                    >
                  </a>
                </div>
              `
            )
            .join("");

          const lastEntry = data[0];
          const isCheckedIn = lastEntry.type === "in";

          // üîπ Gestion du bouton selon le r√¥le
          if (isConfigUser) {
            btnToggle.textContent = "Consultation";
            btnToggle.disabled = true;
            btnToggle.style.opacity = "0.5";
            btnToggle.style.cursor = "not-allowed";
          } else {
            btnToggle.textContent = isCheckedIn ? "Sortie" : "Entr√©e";
            btnToggle.dataset.state = isCheckedIn ? "out" : "in";
            btnToggle.disabled = false;
            btnToggle.style.opacity = "1";
            btnToggle.style.cursor = "pointer";
          }
        }



        function haversineDistance(lat1, lon1, lat2, lon2) {
          const R = 6371; // Rayon de la Terre en km
          const dLat = (lat2 - lat1) * Math.PI / 180;
          const dLon = (lon2 - lon1) * Math.PI / 180;
          const a =
            Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1 * Math.PI / 180) *
            Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) ** 2;
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          return R * c;
        }

        // ______________________________________________________________________
        // Plus grande fonction
        // ______________________________________________________________________

        async function fetchEventsByDate(date, preFiltered = null) {
            // ‚úÖ AJOUTER LA PROTECTION ANTI-REBOND ICI
            if (isFetchingEvents) {
                console.log("‚è≥ fetchEventsByDate d√©j√† en cours, ignor√©");
                return [];
            }

            isFetchingEvents = true;

            // ‚úÖ V√©rifier d'abord le format de la date
            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                console.error(getTranslation('error_date_format_incorrect'));
                isFetchingEvents = false; // ‚¨ÖÔ∏è IMPORTANT : reset si erreur
                return [];
            }

            try {

                let data; // D√©clarez la variable ici pour qu'elle soit accessible partout.

                if (preFiltered && preFiltered.length > 0) {
                    // ‚úÖ Si on a des donn√©es pr√©-filtr√©es (recherche "KEN"), on les utilise directement.
                    data = preFiltered.filter(evt => evt.Date === date);
                    console.log("Utilisation des donn√©es pr√©-filtr√©es.");
                } else {
                    // ‚úÖ Sinon, on fait la requ√™te √† la base de donn√©es.
                    // C'est ce bloc qui contient tout le code de r√©cup√©ration depuis Supabase.
                    const connectedUserName = localStorage.getItem('currentPersonName');
                    const isConfigUser = localStorage.getItem('currentPersonIsConfigUser') === 'true';

                    // Masquer/afficher les en-t√™tes de colonnes
                    const headerTelephone = document.getElementById('header-telephone');
                    if (headerTelephone) {
                        headerTelephone.hidden = !isConfigUser;
                    }

                    const headerPrix = document.getElementById('header-prix');
                    if (headerPrix) {
                        headerPrix.hidden = !isConfigUser;
                    }

                    const headerUserId = document.getElementById('header-user-id');
                    if (headerUserId) {
                        headerUserId.hidden = !isConfigUser;
                    }

                    const headerPaiement = document.getElementById('header-paiement');
                    if (headerPaiement) {
                        headerPaiement.hidden = !isConfigUser;
                    }

                    const formContainer = document.querySelector('.form-container');
                    if (formContainer) {
                        formContainer.hidden = !isConfigUser;
                    }

                    const searchContainer = document.getElementById('searchContainer');
                    if (searchContainer) {
                        searchContainer.hidden = !isConfigUser;
                    }


                    console.log(`${getTranslation('log_connected_user')}: ${connectedUserName}, ${getTranslation('log_is_config_user')}: ${isConfigUser}`);

                    let currentQuery = supabase
                        .from('event_quot1_fran')
                        .select('*')
                        .eq('Date', date);

                    if (connectedUserName && !isConfigUser) {
                        currentQuery = currentQuery.eq('Ajout√©_pour', connectedUserName);
                        console.log(getTranslation('log_filter_applied_events_for') + `"${connectedUserName}"` + getTranslation('log_only'));
                    } else if (isConfigUser) {
                        console.log(getTranslation('log_config_user_all_events'));
                    } else {
                        console.warn(getTranslation('warn_username_not_found_or_config_status_unknown'));
                    }

                    const { data: events, error } = await currentQuery;

                    if (error) {
                        console.error(getTranslation('error_fetching_events'), error);
                        return [];
                    }

                    data = events; // Les donn√©es de la base sont assign√©es √† la variable 'data'
                }

                // Le reste du code (tri, affichage, etc.) continue ici,
                // en utilisant la variable 'data' qui est maintenant correctement remplie.
                const heureOrder = [
                    '7h', '8h', '9h', '10h', '11h', '12h', '13h', '14h', '15h',
                    '16h', '17h', '18h', '19h', '20h', '21h',
                    getTranslation('other_time')
                ];

                data.sort((a, b) => {
                    return heureOrder.indexOf(a.Heure) - heureOrder.indexOf(b.Heure);
                });






                // Fonction pour ouvrir une bo√Æte de dialogue avec les messages WhatsApp disponibles
                function ouvrirPopupWhatsApp() {
                    const popup = document.createElement('div');
                    popup.style.position = 'fixed';
                    popup.style.top = '50%';
                    popup.style.left = '50%';
                    popup.style.transform = 'translate(-50%, -50%)';
                    popup.style.padding = '10px';
                    popup.style.backgroundColor = '#fff';
                    popup.style.border = '1px solid #ccc';
                    popup.style.borderRadius = '8px';
                    popup.style.boxShadow = '0px 0px 10px rgba(0,0,0,0.2)';
                    popup.style.zIndex = '1000';
                    popup.style.width = '90%';
                    popup.style.maxWidth = '400px';

                    // Bouton de fermeture
                    const closeButton = document.createElement('button');
                    closeButton.textContent = getTranslation('button_close'); // Traduire
                    closeButton.style.marginTop = '10px';
                    closeButton.style.backgroundColor = '#f44336';
                    closeButton.style.color = '#fff';
                    closeButton.style.padding = '8px 16px';
                    closeButton.style.border = 'none';
                    closeButton.style.borderRadius = '5px';
                    closeButton.style.cursor = 'pointer';
                    closeButton.addEventListener('click', function () {
                        document.body.removeChild(popup);
                    });

                    // Liste de messages avec aper√ßu
                    const messages = [
                        { text: getTranslation('whatsapp_msg_payment_not_made_text'), id: 1, preview: getTranslation('whatsapp_msg_payment_not_made_preview') }, // Traduire
                        { text: getTranslation('whatsapp_msg_payment_info_text'), id: 2, preview: getTranslation('whatsapp_msg_payment_info_preview') }, // Traduire
                        { text: getTranslation('whatsapp_msg_sales_note_info_text'), id: 3, preview: getTranslation('whatsapp_msg_sales_note_info_preview') }, // Traduire
                        { text: getTranslation('whatsapp_msg_appointment_confirmation_text'), id: 4, preview: getTranslation('whatsapp_msg_appointment_confirmation_preview') }, // Traduire
                        { text: getTranslation('whatsapp_msg_talk_whatsapp_text'), id: 5, preview: getTranslation('whatsapp_msg_talk_whatsapp_preview') } // Traduire
                    ];

                    // Cr√©ation des aper√ßus et boutons de messages
                    messages.forEach(message => {
                        const messageContainer = document.createElement('div');
                        messageContainer.style.marginBottom = '10px';

                        // Aper√ßu du message
                        const preview = document.createElement('div');
                        preview.textContent = message.preview;
                        preview.style.fontSize = '1.0em';
                        preview.style.color = '#555';
                        preview.style.backgroundColor = '#f9f9f9';
                        preview.style.padding = '10px';
                        preview.style.borderLeft = '4px solid #1e73be';
                        preview.style.borderRadius = '4px';
                        preview.style.marginBottom = '5px';

                        // Bouton pour envoyer le message
                        const button = document.createElement('button');
                        button.textContent = message.text;
                        button.style.width = '100%';
                        button.style.padding = '10px';
                        button.style.marginTop = '5px';
                        button.style.backgroundColor = '#25D366';
                        button.style.color = '#fff';
                        button.style.border = 'none';
                        button.style.borderRadius = '5px';
                        button.style.cursor = 'pointer';
                        button.style.fontSize = '18px';
                        button.addEventListener('click', async function () {
                            // Charger le pr√©fixe pour s'assurer qu'il est disponible
                            await chargerPrefixe();

                            const t√©l√©phoneCell = row.querySelector('[data-column="T√©l√©phone"]');
                            let t√©l√©phone = t√©l√©phoneCell ? t√©l√©phoneCell.textContent.trim() : '';

                            // Ajouter le pr√©fixe uniquement si le num√©ro a 10 chiffres
                            if (t√©l√©phone.length === 10) {
                                t√©l√©phone = countryPrefix + t√©l√©phone;
                            }

                            // Nettoyage du num√©ro pour s'assurer qu'il est correct pour WhatsApp
                            t√©l√©phone = t√©l√©phone.replace(/[^+\d]/g, ''); // Retire tout sauf les chiffres et le symbole '+'

                            if (message.id === 5) {
                                // Ajout d'un texte par d√©faut pour √©viter les erreurs de lien
                                const defaultText = getTranslation('whatsapp_default_greeting'); // Traduire
                                const whatsappUrl = `https://api.whatsapp.com/send?phone=${t√©l√©phone}&text=${encodeURIComponent(defaultText)}`;
                                console.log(getTranslation('log_whatsapp_url_for_message_5'), whatsappUrl); // Traduire
                                window.open(whatsappUrl, '_blank');
                            } else {
                                // Appel de la fonction pour les autres messages
                                envoyerMessageWhatsApp(message.id, row);
                            }

                            document.body.removeChild(popup); // Ferme la bo√Æte apr√®s l'envoi
                        });
                        messageContainer.appendChild(preview);
                        messageContainer.appendChild(button);
                        popup.appendChild(messageContainer);
                    });

                    popup.appendChild(closeButton);
                    document.body.appendChild(popup);

                }

                const tbody = document.querySelector('#editable-table tbody');
                    tbody.innerHTML = ''; // Supprimer les anciennes lignes

                    // üîπ √âtape 1 : Charger tous les employ√©s depuis access_code1_fran
                    let employesMap = {};
                    try {
                      const { data: employes, error: empError } = await supabase
                        .from("access_code1_fran")
                        .select("id_code, Nom");

                      if (empError) {
                        console.error("Erreur chargement des employ√©s :", empError);
                      } else {
                        // üîπ √âtape 2 : Construire le dictionnaire Nom ‚Üí id_code
                        employes.forEach(emp => {
                          if (emp.Nom && emp.id_code) {
                            employesMap[emp.Nom.trim().toLowerCase()] = emp.id_code;
                          }
                        });
                        console.log("‚úÖ Dictionnaire employ√©s charg√© :", employesMap);
                      }
                    } catch (err) {
                      console.error("Erreur inattendue chargement employ√©s :", err);
                    }

                    // üîπ √âtape 3 : Boucle sur les √©v√©nements
                    data.forEach(event => {
                      console.log(getTranslation('log_location_for_event'), event.Lieu);

                      // Cr√©ation de la ligne
                      const row = tbody.insertRow();

                      // üîπ √âtape 4 : Trouver l‚Äôid_code √† partir de Ajout√©_pour
                      const nomEmploye = (event.Ajout√©_pour || "").trim().toLowerCase();
                      const idCode = employesMap[nomEmploye];

                      if (!idCode) {
                        console.warn(`‚ö†Ô∏è Aucun id_code trouv√© pour l'employ√© "${event.Ajout√©_pour}"`);
                      }

                      // üîπ √âtape 5 : Lier les infos au dataset
                      row.dataset.idCode = idCode || "";
                      row.dataset.userId = event.user_id;
                      row.dataset.id = event.user_id;

                      // Si le champ "Lieu" contient une URL, on la transforme en lien cliquable
                      const lieuContent = event.Lieu && event.Lieu.match(/https?:\/\/[^\s]+/g)
                        ? event.Lieu.replace(/https?:\/\/[^\s]+/g, url => `<a href="${url}" target="_blank">${url}</a>`)
                        : event.Lieu;

                      // D√©finir la valeur de contenteditable en fonction du statut de l'utilisateur
                      const editableAttr = isConfigUser ? 'true' : 'false';
                      const observationsEditableAttr = 'true';

                      console.log("üõ† event.Travail brut :", event.Travail, typeof event.Travail);
                      const Travail = event.Travail || '';

                      // üß© le reste de ton innerHTML ici...
                      row.innerHTML = `
                        <td contenteditable="false"
                            data-column="T√©l√©phone"
                            ${isConfigUser ? '' : 'hidden'}>
                            ${event.T√©l√©phone !== null ? event.T√©l√©phone : ''}

                        </td>
                        <td contenteditable="${editableAttr}" data-column="Nom">${event.Nom}</td>
                        <td contenteditable="${editableAttr}" data-column="Date">${event.Date}</td>
                        <td contenteditable="${editableAttr}" data-column="Heure">${event.Heure}</td>
                        <td contenteditable="${editableAttr}" data-column="Min">${event.Min !== null ? event.Min : ''}</td>
                        <td contenteditable="${editableAttr}" data-column="Lieu">${lieuContent}</td>
                        <td contenteditable="${editableAttr}" data-column="Prix" ${isConfigUser ? '' : 'hidden'}>${event.Prix !== null ? event.Prix : ''}</td>

                        <td class="travail-cell" data-column="Travail">
                            ${isConfigUser ? `
                                <div class="travail-content" style="display: flex; flex-direction: column; gap: 8px;">
                                    <select data-field="Travail"
                                            style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                                        <option value="">-- S√©lectionner le statut --</option>
                                        <option value="Lavage de vitres"
                                                ${Travail === 'Lavage de vitres' ? 'selected' : ''}>
                                            Lavage de vitres
                                        </option>
                                        <option value="Nettoyage de locaux"
                                                ${Travail === 'Nettoyage de locaux' ? 'selected' : ''}>
                                            Nettoyage de locaux
                                        </option>
                                        <option value="Nettoyage apr√®s chantier"
                                                ${Travail === 'Nettoyage apr√®s chantier' ? 'selected' : ''}>
                                            Nettoyage apr√®s chantier
                                        </option>
                                        <option value="Nettoyage de panneaux photovolta√Øques"
                                                ${Travail === 'Nettoyage de panneaux photovolta√Øques' ? 'selected' : ''}>
                                            Nettoyage de panneaux photovolta√Øques
                                        </option>
                                        <option value="Lutte contre les nuisibles"
                                                ${Travail === 'Lutte contre les nuisibles' ? 'selected' : ''}>
                                            Lutte contre les nuisibles
                                        </option>
                                        <option value="Autre : Voir Observations"
                                                ${Travail === 'Autre : Voir Observations' ? 'selected' : ''}>
                                            Autre : Voir Observations
                                        </option>
                                    </select>
                                </div>
                            ` : `
                                <div style="padding: 8px;">
                                    ${event.Travail || '--'}
                                </div>
                            `}
                        </td>
                        <td data-column="Observations">
                          <textarea class="observation-text"
                                    data-field="observations">${event.Observations || ''}</textarea>
                            <div class="photo-buttons">
                                <button type="button" class="btn-photo" data-type="avant" data-user-id="${event.user_id}">
                                    ${getTranslation('photo_before')}
                                </button>
                                <button type="button" class="btn-photo" data-type="apres" data-user-id="${event.user_id}">
                                    ${getTranslation('photo_after')}
                                </button>
                            </div>
                            <div class="photo-preview">
                                ${event.photo_avant_url ?
                                    `<div class="photo-wrapper">
                                      <img src="${event.photo_avant_url}"
                                           alt="${getTranslation('photo_before')}"
                                           class="photo-avant"
                                           style="max-height:50px;">
                                      <span class="delete-photo"
                                            data-type="avant"
                                            data-user-id="${event.user_id}">‚úñ</span>
                                    </div>` : ''}

                                ${event.photo_apres_url ?
                                    `<div class="photo-wrapper">
                                      <img src="${event.photo_apres_url}"
                                           alt="${getTranslation('photo_after')}"
                                           class="photo-apres"
                                           style="max-height:50px;">
                                      <span class="delete-photo"
                                            data-type="apres"
                                            data-user-id="${event.user_id}">‚úñ</span>
                                    </div>` : ''}
                            </div>
                        </td>
                        <td class="editable-select-cell" contenteditable="${editableAttr}" data-column="Ajout√©_pour" data-current-value="${event.Ajout√©_pour !== null ? event.Ajout√©_pour : ''}">${event.Ajout√©_pour !== null ? event.Ajout√©_pour : ''}</td>
                        <td contenteditable="false" data-column="user_id" ${isConfigUser ? '' : 'hidden'}>${event.user_id !== null ? event.user_id : ''}</td>
                        <td ${isConfigUser ? '' : 'hidden'}>
                            <div class="checkbox-container" style="font-size: smaller;">
                                <label>
                                    <input type="checkbox" data-column="env_donn√©es" ${event.env_donn√©es ? 'checked' : ''} ${isConfigUser ? '' : 'disabled'}> ${getTranslation('checkbox_sent_data')}
                                </label>
                                <br>
                                <span class="paiement-link" style="cursor: pointer; color: blue; text-decoration: underline;"
                                    data-paiement="${event.paiement ? event.paiement : ''}">
                                    ${event.paiement && event.paiement !== 'null' && event.paiement !== '' ? getTranslation('link_view_payment') : getTranslation('link_add_payment')}
                                </span>
                                <br>
                                <label>
                                    <input type="checkbox" data-column="pay√©" ${event.pay√© ? 'checked' : ''} ${isConfigUser ? '' : 'disabled'}> ${getTranslation('checkbox_paid')}
                                </label>
                            </div>
                        </td>
                        <td class="pointage-cell">
                          <div class="pointage-container">
                            <button
                              type="button"
                              class="btn-toggle-onss"
                              data-user-id="${event.user_id}"
                              data-id-code="${event.id_code || ''}"
                              ${isConfigUser ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}
                            >
                              ${isConfigUser ? getTranslation('consultation_label') : 'Entr√©e'}
                            </button>

                            <div class="pointage-history"></div>
                          </div>
                        </td>



                    `;

                    // ‚úÖ Charger l'historique de pointage ONSS pour cette ligne
                    loadPointageHistory(row);


                    // Correction de la mise en cache locale
                    row.dataset.idCode = event.id_code || '';

                    row.dataset.eventId = event.id;
                    row.dataset.userId = event.user_id;
                    // ‚úÖ CORRECTION : Stocke la cha√Æne de texte brute sans JSON.stringify
                    row.dataset.travail = Travail;


                    // Attache les √©couteurs pour la colonne Travail et les autres √©l√©ments (Observations, Photos, etc.)
                    attachTravailListeners(row, event);

                    // Renommage de la fonction attachTravailListeners pour refl√©ter qu'elle g√®re plus d'√©l√©ments maintenant
                    function attachTravailListeners(row, event) {

                      // 1. GESTION DU CHAMP TRAVAIL (SELECT)
                      // üõë CORRECTION : Cibler le data-field="Travail"
                      const travailSelect = row.querySelector('[data-column="Travail"] select[data-field="Travail"]');
                      if (travailSelect) {
                          travailSelect.addEventListener('change', async () => {
                              const userId = row.dataset.userId;
                              const fieldName = travailSelect.dataset.field; // ‚úÖ Maintenant "Travail"
                              const fieldValue = travailSelect.value.trim();

                              // Appelle la fonction saveTravailField pour la sauvegarde hors ligne/en ligne
                              // saveTravailField a d√©j√† √©t√© corrig√©e pour g√©rer le VARCHAR simple
                              await saveTravailField(userId, fieldName, fieldValue, row);
                          });
                      }

                      // 2. GESTION DU CHAMP OBSERVATIONS (TEXTAREA)
                      const observationTextarea = row.querySelector('[data-column="Observations"] textarea[data-field="observations"]');
                      if (observationTextarea) {
                          observationTextarea.addEventListener('blur', async () => {
                              const userId = row.dataset.userId;
                              const fieldName = observationTextarea.dataset.field; // "observations"
                              const fieldValue = observationTextarea.value.trim();

                              // Utilise la m√™me fonction de sauvegarde si elle g√®re les deux colonnes
                              await saveTravailField(userId, fieldName, fieldValue, row);
                          });
                      }
                    }
                        // Activer les boutons photo "Avant" et "Apr√®s"
                        row.querySelectorAll('.btn-photo').forEach(button => {
                            button.addEventListener('click', async () => {
                                const type = button.dataset.type; // "avant" ou "apres"
                                const userId = button.dataset.userId;

                                // Cr√©er un input file invisible pour ouvrir l'appareil photo
                                const input = document.createElement('input');
                                input.type = 'file';
                                input.accept = 'image/*';
                                input.capture = 'environment'; // ouvre directement la cam√©ra sur mobile

                                // üìå Nombre de mois de r√©tention (modifiable facilement)
                                const PHOTO_RETENTION_MONTHS = 3; // ‚á¶ change ici (1 = suppression apr√®s 1 mois)

                                async function compressImage(file, maxWidth = 800, quality = 0.6) {
                                    return new Promise((resolve, reject) => {
                                        const reader = new FileReader();
                                        reader.readAsDataURL(file);

                                        reader.onload = event => {
                                            const img = new Image();
                                            img.src = event.target.result;

                                            img.onload = () => {
                                                // Calculer les nouvelles dimensions
                                                let width = img.width;
                                                let height = img.height;

                                                if (width > maxWidth) {
                                                    height = (height * maxWidth) / width;
                                                    width = maxWidth;
                                                }

                                                const canvas = document.createElement("canvas");
                                                canvas.width = width;
                                                canvas.height = height;

                                                const ctx = canvas.getContext("2d");
                                                ctx.drawImage(img, 0, 0, width, height);

                                                canvas.toBlob(
                                                    blob => {
                                                        // ‚ö†Ô∏è CORRECTION : Changez le nom du fichier
                                                        const compressedFile = new File([blob], `compressed-${Date.now()}.jpg`, {
                                                            type: "image/jpeg",
                                                            lastModified: Date.now()
                                                        });
                                                        resolve(compressedFile);
                                                    },
                                                    "image/jpeg",
                                                    quality
                                                );
                                            };

                                            img.onerror = error => reject(error);
                                        };
                                        reader.onerror = error => reject(error);
                                    });
                                }

                                input.addEventListener('change', async () => {
                                    if (input.files.length > 0) {
                                        const originalFile = input.files[0];

                                        // ‚úÖ Compression plus agressive
                                        const compressedFile = await compressImage(originalFile, 800, 0.5);

                                        console.log(`üìä Taille originale: ${(originalFile.size / 1024 / 1024).toFixed(2)} MB`);
                                        console.log(`üìä Taille compress√©e: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);

                                        // ‚úÖ Chemin + date d'expiration
                                        const now = new Date();
                                        const expiryDate = new Date();
                                        expiryDate.setMonth(now.getMonth() + PHOTO_RETENTION_MONTHS);

                                        const filePath = `${userId}/${type}-${Date.now()}.jpg`;

                                        try {
                                            // ‚úÖ Upload vers Supabase Storage
                                            const { error: uploadError } = await supabase.storage
                                                .from('facturas_fran')
                                                .upload(filePath, compressedFile, {
                                                    upsert: true,
                                                    // ‚úÖ Option pour √©viter la d√©tection automatique du content-type
                                                    contentType: 'image/jpeg'
                                                });

                                            if (uploadError) {
                                                console.error("‚ùå Erreur upload photo :", uploadError);
                                                alert("Erreur lors de l'upload de la photo");
                                                return;
                                            }

                                            // ‚úÖ Obtenir l'URL publique
                                            const { data, error: urlError } = supabase
                                                .storage
                                                .from('facturas_fran')
                                                .getPublicUrl(filePath);

                                            if (urlError) {
                                                console.error("‚ùå Erreur r√©cup√©ration URL publique :", urlError);
                                                return;
                                            }

                                            const publicUrl = data.publicUrl;

                                            // ‚úÖ Mettre √† jour l'aper√ßu dans la cellule
                                            const preview = button.closest('td').querySelector('.photo-preview');
                                            const img = document.createElement('img');
                                            img.src = publicUrl;
                                            img.alt = type === "avant" ? getTranslation('photo_before') : getTranslation('photo_after');
                                            img.classList.add(type === "avant" ? 'photo-avant' : 'photo-apres');
                                            img.style.maxHeight = "50px";

                                            preview.querySelector(type === "avant" ? '.photo-avant' : '.photo-apres')?.remove();
                                            preview.appendChild(img);

                                            // ‚úÖ Mise √† jour de la ligne dans Supabase (on enregistre la date r√©elle d'upload)
                                            const updateData = type === "avant"
                                              ? { photo_avant_url: publicUrl, photo_uploaded_at: new Date() }
                                              : { photo_apres_url: publicUrl, photo_uploaded_at: new Date() };

                                            // üîç Log AVANT envoi
                                            console.log("üîç Donn√©es envoy√©es √† event_quot1_fran :", updateData, "user_id:", userId);

                                            const { data: updatedEvent1, error: updateError1 } = await supabase
                                                .from('event_quot1_fran')
                                                .update(updateData)
                                                .eq('user_id', userId)
                                                .select(); // üëà ajoute select() pour voir le retour

                                            if (updateError1) {
                                                console.error("‚ùå Erreur update event_quot1_fran :", updateError1);
                                            } else {
                                                // üîç Log APR√àS envoi
                                                console.log("‚úÖ Donn√©es enregistr√©es dans event_quot1_fran :", updatedEvent1);
                                            }

                                            console.log("üîç Donn√©es envoy√©es √† tableData1_fran :", updateData, "T√©l√©phone:", event.T√©l√©phone);

                                            const { data: updatedEvent2, error: updateError2 } = await supabase
                                                .from('tableData1_fran')
                                                .update(updateData)
                                                .eq('T√©l√©phone', event.T√©l√©phone)
                                                .select();

                                            if (updateError2) {
                                                console.error("‚ùå Erreur update tableData1_fran :", updateError2);
                                            } else {
                                                console.log("‚úÖ Donn√©es enregistr√©es dans tableData1_fran :", updatedEvent2);
                                            }

                                            console.log(`‚úÖ Photo ${type} sauvegard√©e : ${publicUrl} (expire le ${expiryDate.toISOString()})`);
                                            console.log(`üìä Taille finale: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);

                                        } catch (err) {
                                            console.error("‚ùå Exception pendant l'upload photo :", err);
                                        }
                                    }
                                });

                                input.click(); // Ouvre la cam√©ra / s√©lecteur fichier
                            });
                        });

                        // Ajout de l'√©v√©nement pour permettre l'√©dition avec un double-clic
                        const lieuCell = row.querySelector('[data-column="Lieu"]');
                        lieuCell.addEventListener('dblclick', () => {
                            // SEUL UN UTILISATEUR DE CONFIGURATION PEUT √âDITER LE LIEU
                            if (isConfigUser) {
                                lieuCell.contentEditable = true;
                                lieuCell.focus();
                            }
                        });

                        // Ajout de l'√©v√©nement pour rendre le lien cliquable sans passer en mode √©dition
                        lieuCell.addEventListener('click', (event) => {
                            if (event.target.tagName === 'A') {
                                event.stopPropagation(); // Emp√™che le double-clic de d√©clencher l'√©dition
                            } else {
                                // Optionnel : on pourrait enlever l'√©dition si la cellule perd le focus
                                lieuCell.contentEditable = false;
                            }
                        });


                        const observationsTextarea = row.querySelector('.observation-text');
                        if (observationsTextarea) {
                            observationsTextarea.addEventListener('blur', function() {
                                applyChangesWithoutPrompt(row, false);
                            });

                            observationsTextarea.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    this.blur();
                                }
                            });
                        }

                        // Activer la lightbox pour les miniatures de CETTE ligne
                        row.querySelectorAll('.photo-avant, .photo-apres').forEach(img => {
                          img.addEventListener('click', () => {
                            const lightbox = document.getElementById("lightbox");
                            const lightboxImg = document.getElementById("lightbox-img");
                            lightbox.style.display = "flex";
                            lightboxImg.src = img.src;
                            lightboxImg.alt = img.alt;
                          });
                        });


                        // üëâ d√©placer ici
                        row.querySelectorAll('.delete-photo').forEach(button => {
                            button.addEventListener('click', async () => {
                                const type = button.dataset.type; // "avant" ou "apres"
                                const userId = button.dataset.userId;

                                if (!confirm(getTranslation('confirm_delete_photo'))) {
                                    return;
                                }

                                // CORRECTION 1 : Ajout des guillemets
                                const img = row.querySelector(`.photo-${type}`);
                                if (!img) return;
                                const url = img.src;

                                const filePath = url.split('/facturas_fran/')[1];

                                const { error: removeError } = await supabase.storage
                                    .from('facturas_fran')
                                    .remove([filePath]);

                                if (removeError) {
                                    console.error("Erreur suppression photo", removeError);
                                    alert("Erreur lors de la suppression de la photo");
                                    return;
                                }

                                const updateData = type === "avant"
                                    ? { photo_avant_url: null }
                                    : { photo_apres_url: null };

                                await supabase.from('event_quot1_fran')
                                    .update(updateData)
                                    .eq('user_id', userId);

                                await supabase.from('tableData1_fran')
                                    .update(updateData)
                                    .eq('T√©l√©phone', row.querySelector('[data-column="T√©l√©phone"]').textContent);

                                button.closest('.photo-wrapper').remove();

                                // CORRECTION 2 : Ajout des backticks pour l'interpolation
                                console.log(`Photo ${type} supprim√©e avec succ√®s`);
                            });
                        });


                        // Ajouter la cellule pour les boutons
                        const applyCell = row.insertCell();

                        // üîπ G√©rer la mise √† jour directe des cases √† cocher
                        ["env_donn√©es", "pay√©"].forEach(column => {
                          const checkbox = row.querySelector(`input[data-column="${column}"]`);
                          if (checkbox) {
                            checkbox.addEventListener("change", async () => {
                              const userId = row.dataset.userId;
                              const modifiePar = localStorage.getItem("currentPersonName");
                              const dateModification = getLocalDateTime();
                              const nouvelleValeur = checkbox.checked;

                              try {
                                // 1Ô∏è‚É£ Mettre √† jour directement dans Supabase
                                const { error } = await supabase
                                  .from("event_quot1_fran")
                                  .update({ [column]: nouvelleValeur })
                                  .eq("user_id", userId);

                                if (error) {
                                  console.error("‚ùå Erreur mise √† jour case √† cocher:", error);
                                  return;
                                }

                                // 2Ô∏è‚É£ Sauvegarder dans l‚Äôhistorique
                                await logModification({
                                  userId,
                                  rendezvousActuel: null,
                                  modifiePar,
                                  dateModification,
                                  champ: column,
                                  ancienneValeur: !nouvelleValeur,
                                  nouvelleValeur: nouvelleValeur,
                                  action: getTranslation("action_modification"),
                                  nombre: row.querySelector('[data-column="Nom"]').textContent.trim(),
                                  telephone: row.querySelector('[data-column="T√©l√©phone"]').textContent.trim(),
                                  extra: (column === "Observations" || column === "Travail")
                                    ? { texte: nouvelleValeur, longueur: nouvelleValeur?.length || 0 }
                                    : null
                                });


                                console.log(`‚úÖ ${column} mis √† jour directement ‚Üí ${nouvelleValeur}`);

                              } catch (err) {
                                console.error("‚ö° Exception mise √† jour case √† cocher:", err);
                              }
                            });
                          }
                        });



                        // Bouton "Supprimer"
                        const cancelButton = document.createElement('button');
                        cancelButton.textContent = getTranslation('button_delete');
                        cancelButton.classList.add('cancel-button');

                        if (isConfigUser) {
                          applyCell.appendChild(cancelButton);

                          cancelButton.addEventListener('click', () => {
                            const userId = row.dataset.userId;
                            const telefono = row.dataset.telefono;

                            console.log("recurrence_id brut :", event.recurrence_id);

                            // ‚úÖ on passe bien recurrence_id converti en string
                            handleDeleteEvent(
                              userId,
                              telefono,
                              row,
                              event.recurrence_rule ? event.recurrence_rule : {},
                              event.recurrence_id?.toString()
                            );

                          });
                        }


                        // Bouton "WhatsApp"
                        const whatsappButton = document.createElement('button');
                        whatsappButton.textContent = getTranslation('button_whatsapp');
                        whatsappButton.classList.add('whatsapp-button', 'detail-only'); // ‚ö° ajout
                        if (isConfigUser) {
                          applyCell.appendChild(whatsappButton);
                        }


                        const duplicateButton = document.createElement("button");
                        duplicateButton.textContent = "üìÑ Dupliquer";
                        duplicateButton.classList.add("duplicate-button", "detail-only"); // ‚ö° ajout
                        duplicateButton.addEventListener("click", () => openDuplicateModal(event));
                        if (isConfigUser) {
                          applyCell.appendChild(duplicateButton);
                        }


                        const borrarPaiementButton = document.createElement('button');
                        borrarPaiementButton.textContent = getTranslation('button_clear_payment');
                        borrarPaiementButton.classList.add('borrar-paiement-button', 'detail-only'); // ‚ö° ajout
                        if (isConfigUser) {
                          applyCell.appendChild(borrarPaiementButton);
                        }

                        // Ajouter un √©couteur d'√©v√©nement au bouton "Effacer Paiement"
                        borrarPaiementButton.addEventListener('click', function(e) {
                            // üî• r√©cup√©rer la ligne parente directement ici
                            const row = e.target.closest("tr");

                            // Afficher la bo√Æte de dialogue de confirmation
                            const confirmationPopup = document.getElementById('confirmationPopup');
                            confirmationPopup.style.display = 'block';

                            // Nettoyer les anciens √©couteurs avant d'en rajouter
                            const confirmYes = document.getElementById('confirmYes');
                            const confirmNo = document.getElementById('confirmNo');
                            confirmYes.replaceWith(confirmYes.cloneNode(true));
                            confirmNo.replaceWith(confirmNo.cloneNode(true));

                            // Reprendre les refs apr√®s le clone
                            const newConfirmYes = document.getElementById('confirmYes');
                            const newConfirmNo = document.getElementById('confirmNo');

                            // Attacher l'√©v√©nement au bouton "S√≠"
                            newConfirmYes.addEventListener('click', async function() {
                                const userId = row.dataset.userId; // ‚úÖ row est bien d√©fini
                                const paiementLink = row.querySelector('.paiement-link');
                                const paiementPath = paiementLink ? paiementLink.dataset.paiement : null;

                                if (userId && paiementPath) {
                                    try {
                                        // Supprimer le fichier du bucket
                                        const { error: deleteError } = await supabase
                                            .storage
                                            .from('facturas_fran')
                                            .remove([paiementPath]);

                                        if (deleteError) {
                                            console.error(getTranslation('error_deleting_file'), deleteError);
                                            alert(getTranslation('alert_error_deleting_file'));
                                            return;
                                        }

                                        // Mettre la colonne 'paiement' √† NULL dans Supabase
                                        const { error } = await supabase
                                            .from('event_quot1_fran')
                                            .update({ paiement: null })
                                            .eq('user_id', userId);

                                        if (error) {
                                            console.error(getTranslation('error_updating_payment_column'), error);
                                        } else {
                                            showTemporaryMessage(getTranslation("temp_msg_payment_cleared_successfully"));

                                            if (paiementLink) {
                                                paiementLink.textContent = getTranslation('link_add_payment');
                                                paiementLink.removeAttribute('data-paiement');
                                            }

                                            // ‚ö° Appliquer les changements sans popup
                                            applyChangesWithoutPrompt(row, false);
                                        }
                                    } catch (error) {
                                        console.error(getTranslation('error_colon'), error);
                                        alert(getTranslation('alert_error_deleting_invoice'));
                                    }
                                }

                                confirmationPopup.style.display = 'none';
                            });

                            // G√©rer le clic sur "No"
                            newConfirmNo.addEventListener('click', function() {
                                confirmationPopup.style.display = 'none';
                            });
                        });


                        // Obtenir la date et l'heure locales au format 'YYYY-MM-DD HH:mm:ss'
                        function getLocalDateTime() {
                            const now = new Date();
                            const year = now.getFullYear();
                            const month = String(now.getMonth() + 1).padStart(2, '0');
                            const day = String(now.getDate()).padStart(2, '0');
                            const hours = String(now.getHours()).padStart(2, '0');
                            const minutes = String(now.getMinutes()).padStart(2, '0');
                            const seconds = String(now.getSeconds()).padStart(2, '0');
                            // CORRECTION : Ajout de backticks pour le litt√©ral de gabarit
                            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                        }

                        // Bouton "Appliquer changem."
                        const applyButton = document.createElement('button');
                        applyButton.textContent = getTranslation('button_apply_changes');
                        applyButton.classList.add('apply-button');
                        if (isConfigUser) {
                            applyCell.appendChild(applyButton);
                        }

                        // Bouton "Alerte"
                        const alertButton = document.createElement("button");
                        alertButton.textContent = "‚ö†Ô∏è " + getTranslation("button_alert");
                        alertButton.classList.add("alert-button", "detail-only");

                        if (event.alert_status === "active") {
                          alertButton.classList.add("alert-active");
                        } else if (event.alert_status === "resolved") {
                          alertButton.classList.add("alert-resolved");
                        } else {
                          alertButton.classList.add("alert-none");
                        }


                        // Ajout du bouton √† la cellule
                        applyCell.appendChild(alertButton);



                        alertButton.addEventListener("click", () => {
                          const confirmationPopup = document.getElementById('confirmationPopup');
                          confirmationPopup.style.display = 'block';

                          document.getElementById('confirmYes').onclick = async function() {
                            confirmationPopup.style.display = 'none';

                            if (event.alert_status !== "active") {
                              // 1Ô∏è‚É£ Si pas encore active ‚Üí activer l‚Äôalerte et envoyer le mail
                              try {
                                await supabase
                                  .from("event_quot1_fran")
                                  .update({ alert_status: "active" })
                                  .eq("user_id", event.user_id); // ‚ö° corrige ici

                                event.alert_status = "active";
                                alertButton.style.backgroundColor = "red";

                                emailjs.send("service_2vsnzpt", "template_v83qlcw", {
                                  employe: event.Ajout√©_pour,
                                  telephone: event.T√©l√©phone,
                                  date: event.Date,
                                  heure: event.Heure,
                                  lieu: event.Lieu
                                }).then(
                                  function(response) {
                                    showTemporaryMessage("üö® " + getTranslation("alert_sent_success"));
                                    console.log("EmailJS success:", response);
                                  },
                                  function(error) {
                                    showTemporaryMessage("‚ùå " + getTranslation("alert_sent_error"));
                                    console.error("EmailJS error:", error);
                                  }
                                );
                              } catch (err) {
                                console.error("‚ùå Erreur mise √† jour statut:", err);
                              }
                            } else {
                              // 2Ô∏è‚É£ Si d√©j√† active ‚Üí passer en r√©solue
                              try {
                                await supabase
                                  .from("event_quot1_fran")
                                  .update({ alert_status: "resolved" })
                                  .eq("user_id", event.user_id); // ‚ö° bien d√©fini

                                event.alert_status = "resolved";
                                alertButton.style.backgroundColor = "green";
                                showTemporaryMessage("‚úÖ " + getTranslation("alert_resolved"));
                              } catch (err) {
                                console.error("‚ùå Erreur mise √† jour statut:", err);
                              }
                            }
                          };

                          document.getElementById('confirmNo').onclick = function() {
                            confirmationPopup.style.display = 'none';
                          };
                        });


                        // ‚ö° Handler unique
                        applyButton.addEventListener('click', async () => {

                          const userId = row.dataset.userId;
                          const modifiePar = localStorage.getItem('currentPersonName');
                          const dateModification = getLocalDateTime();

                          const { data: rendezvousActuel, error } = await supabase
                            .from('event_quot1_fran')
                            .select('*')
                            .eq('user_id', userId)
                            .single();

                          if (error) {
                            console.error("Erreur r√©cup√©ration √©v√©nement :", error);
                            return;
                          }

                          const recurrenceId = rendezvousActuel.recurrence_id;
                          const nombre = rendezvousActuel['Nom'] || '';
                          const telephone = rendezvousActuel['T√©l√©phone'] || '';

                          const updatedEvent = {};
                          const modifications = [];

                          Array.from(row.cells).forEach(cell => {
                            const column = cell.dataset.column;
                            if (column) {
                              let cellValue;
                              let ancienneValeur = rendezvousActuel[column];

                              // --- R√âCUP√âRATION DE LA VALEUR CORRECTE ---
                              if (column === "Observations") {
                                const textarea = row.querySelector('[data-field="observations"]');
                                cellValue = textarea ? textarea.value.trim() : "";
                              } else if (column === "Travail") {
                                // ‚úÖ Cible le SELECT dans la cellule Travail
                                const select = cell.querySelector('[data-field="StatutTravail"]');
                                cellValue = select ? select.value.trim() : "";

                                // La colonne Travail stocke un objet JSON dans la BDD (m√™me si nous n'avons qu'une cl√©).
                                // Il faut donc s'assurer que `ancienneValeur` est bien l'objet Travail.
                                ancienneValeur = rendezvousActuel.Travail;
                              } else {
                                cellValue = cell.textContent.trim();
                              }
                              // ------------------------------------------

                              // GESTION DES VALEURS VIDES/NULL ET CONVERSION
                              if (column === 'Prix') {
                                cellValue = cellValue ? parseFloat(cellValue).toString() : "EMPTY";
                                ancienneValeur = ancienneValeur !== null ? parseFloat(ancienneValeur).toString() : "EMPTY";
                              } else {
                                cellValue = cellValue === "" ? "EMPTY" : cellValue;
                                // Pour les colonnes normales (texte), on normalise l'ancienne valeur.
                                if (column !== "Travail") {
                                    ancienneValeur = ancienneValeur === null || ancienneValeur === "" ? "EMPTY" : ancienneValeur.toString();
                                }
                              }

                              // MISE √Ä JOUR DE L'OBJET
                              // Cas sp√©cial pour Travail : nous devons reconstruire l'objet Travail si c'est cette colonne
                              if (column === "Travail") {
                                  const statutTravail = cellValue === "EMPTY" ? null : cellValue;
                                  updatedEvent.Travail = {
                                      ...ancienneValeur, // Garde les autres cl√©s si elles existent (pour la compatibilit√©)
                                      StatutTravail: statutTravail
                                  };
                                  // Pour la comparaison, nous voulons comparer la valeur r√©elle du StatutTravail
                                  const oldStatut = ancienneValeur?.StatutTravail ?? null;
                                  const newStatut = statutTravail;

                                  if (oldStatut !== newStatut) {
                                      modifications.push({
                                          user_id: userId,
                                          modifi√©_par: modifiePar,
                                          date_modification: dateModification,
                                          champ_modifi√©: "StatutTravail", // Log la cl√© sp√©cifique
                                          valeur_ancienne: oldStatut,
                                          valeur_nouvelle: newStatut,
                                          action: getTranslation('action_modification'),
                                          Nombre: nombre,
                                          Telefono: telephone
                                      });
                                  }
                              } else {
                                  // Pour toutes les autres colonnes simples (Nom, Date, Heure, etc.)
                                  updatedEvent[column] = cellValue === "EMPTY" ? null : cellValue;

                                  // Logique de modification pour les champs simples
                                  const normalizedOld = (ancienneValeur === "EMPTY" ? null : ancienneValeur);
                                  const normalizedNew = (cellValue === "EMPTY" ? null : cellValue);

                                  if (normalizedOld !== normalizedNew) {
                                    modifications.push({
                                      user_id: userId,
                                      modifi√©_par: modifiePar,
                                      date_modification: dateModification,
                                      champ_modifi√©: column,
                                      valeur_ancienne: normalizedOld,
                                      valeur_nouvelle: normalizedNew,
                                      action: getTranslation('action_modification'),
                                      Nombre: nombre,
                                      Telefono: telephone
                                    });
                                  }
                              }
                            }
                          });

                          // üëâ Nouvelle fonction pour g√©rer la confirmation et la sauvegarde
                            async function handleConfirmationAndSave(applySeries, requireConfirmation = false) {
                              let userConfirmed = true;

                              if (requireConfirmation) {
                                userConfirmed = await showConfirmation();
                              }

                              if (userConfirmed) {
                                // ‚ö° NE PAS logger ici - le logging est fait dans updateEventData
                                // SUPPRIMER toute cette partie :
                                // for (const mod of modifications) {
                                //   await logModification({ ... });
                                // }

                                // ‚ö° Appeler UNIQUEMENT updateEventData
                                await updateEventData(row, rendezvousActuel, applySeries, recurrenceId, updatedEvent);
                              }
                            }

                          if (recurrenceId) {
                            const popup = document.getElementById("popup6");
                            popup.style.display = "flex";
                            const popupContent = popup.querySelector(".popup-content");
                            popupContent.focus();

                            const options = Array.from(document.querySelectorAll("#popup6 .popup-option"));
                            let selectedIndex = 0;

                            options.forEach(opt => {
                                opt.onclick = async () => {
                                    const action = opt.dataset.action;
                                    popup.style.display = "none";

                                    // üëâ L‚Äôenregistrement est fait UNIQUEMENT apr√®s le choix
                                    if (action === "one") {
                                        await handleConfirmationAndSave(false, false);

                                    } else if (action === "series") {
                                        const userConfirmed = await showConfirmation();
                                        if (userConfirmed) {
                                            await handleConfirmationAndSave(true, false);
                                        }
                                    }
                                };
                            });



                              // Navigation clavier
                              popupContent.addEventListener("keydown", (e) => {
                                if (e.key === "ArrowDown") {
                                  e.preventDefault();
                                  selectedIndex = (selectedIndex + 1) % options.length;
                                } else if (e.key === "ArrowUp") {
                                  e.preventDefault();
                                  selectedIndex = (selectedIndex - 1 + options.length) % options.length;
                                } else if (e.key === "Enter") {
                                  e.preventDefault();
                                  options[selectedIndex].click();
                                  return;
                                }

                                options.forEach((opt, i) => {
                                  opt.classList.toggle("selected", i === selectedIndex);
                                });
                              });

                            } else {
                              await handleConfirmationAndSave(false, false);
                            }






                        });

                        // Ajouter un √©couteur d'√©v√©nement au bouton "WhatsApp"
                        whatsappButton.addEventListener('click', function() {
                        ouvrirPopupWhatsApp(row);
                    });

                    // 4. Attacher les √©couteurs pour TOUS les utilisateurs (Admin ou Employ√©)
                    // Initialisation du bouton dynamique
                    const btnToggle = row.querySelector('.btn-toggle-onss');

                    btnToggle.addEventListener('click', async () => {
                      const currentState = btnToggle.dataset.state || "in";
                      const type = currentState === "in" ? "in" : "out";

                      await handleCheckinCheckout(row, type);
                      await loadPointageHistory(row); // recharge l'historique et change couleur + texte
                    });


                }); // Fermeture du forEach(event => { ... });


                return data;

            } catch (error) {
                console.error(getTranslation('error_fetching_events_colon'), error);
                return [];
            } finally {
                // ‚úÖ TOUJOURS reset dans finally
                isFetchingEvents = false;
            }
        }


        const lightbox = document.getElementById("lightbox");
        const lightboxClose = document.querySelector(".lightbox-close");

        // Fermer avec la croix
        lightboxClose.addEventListener("click", () => {
          lightbox.style.display = "none";
        });

        // Fermer en cliquant √† c√¥t√© de l‚Äôimage
        lightbox.addEventListener("click", (e) => {
          if (e.target === lightbox) {
            lightbox.style.display = "none";
          }
        });

        async function deleteSeries(recurrenceId) {
            const { error, data } = await supabase
                .from('event_quot1_fran')
                .delete()
                .eq('recurrence_id', recurrenceId) // ‚úÖ beaucoup plus propre
                .select();

            if (error) {
                console.error("Erreur suppression s√©rie :", error);
            } else {
                console.log("S√©rie supprim√©e avec recurrence_id:", data);
            }
        }

        async function deleteOne(userId, telefono) {
            const { error } = await supabase
                .from('event_quot1_fran')
                .delete()
                .eq('user_id', userId);

            if (error) {
                console.error("Erreur suppression √©v√©nement :", error);
            } else {
                console.log("‚úÖ √âv√©nement supprim√© :", userId);
            }

            if (telefono) {
                await supabase.from('tableData1_fran')
                    .update({
                        Heure: null, Min: null, Prix: null, Travail: null,
                        Observations: null, Ajout√©_pour: null, env_donn√©es: null,
                        paiement: null, pay√©: null,
                        photo_avant_url: null, photo_apres_url: null
                    })
                    .eq('T√©l√©phone', telefono);
            }
        }

        async function finalizeDelete(row, telefono, userId, extra) {
            row.remove();

            window.successMessage.textContent = getTranslation('temp_msg_deleted');
            window.successMessage.style.display = 'block';
            setTimeout(() => {
                window.successMessage.style.display = 'none';
                window.successMessage.textContent = getTranslation('temp_msg_data_updated_success');
            }, 1000);

            await logModification({
              userId,
              rendezvousActuel: null,
              modifiePar: localStorage.getItem("currentPersonName"),
              dateModification: getLocalDateTime(),
              champ: "Suppression",
              ancienneValeur: telefono,
              nouvelleValeur: null,
              action: getTranslation("Suppression"),
              nombre: extra?.Nom || "",
              telephone: telefono,
              extra
            });
        }


        function showConfirmation() {
            return new Promise((resolve, reject) => {
                const confirmationPopup = document.getElementById("confirmationPopup");
                confirmationPopup.style.display = "block";

                const yesBtn = document.getElementById("confirmYes");
                const noBtn = document.getElementById("confirmNo");

                // Nettoyer les anciens √©couteurs pour √©viter les multiples activations
                const newYesBtn = yesBtn.cloneNode(true);
                yesBtn.replaceWith(newYesBtn);
                const newNoBtn = noBtn.cloneNode(true);
                noBtn.replaceWith(newNoBtn);

                const options = [newYesBtn, newNoBtn];
                let selectedIndex = 0;

                // Initialiser l'affichage
                options.forEach((btn, i) => btn.classList.toggle("selected", i === selectedIndex));
                newYesBtn.focus();

                function updateSelection(newIndex) {
                    options[selectedIndex].classList.remove("selected");
                    selectedIndex = (newIndex + options.length) % options.length;
                    options[selectedIndex].classList.add("selected");
                    options[selectedIndex].focus();
                }

                function handleKeyDown(e) {
                    if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
                        updateSelection(selectedIndex - 1);
                        e.preventDefault();
                    } else if (e.key === "ArrowRight" || e.key === "ArrowDown") {
                        updateSelection(selectedIndex + 1);
                        e.preventDefault();
                    } else if (e.key === "Enter") {
                        e.preventDefault();
                        document.removeEventListener("keydown", handleKeyDown);
                        confirmationPopup.style.display = "none";
                        resolve(selectedIndex === 0);
                    }
                }

                document.addEventListener("keydown", handleKeyDown);

                newYesBtn.addEventListener("click", () => {
                    document.removeEventListener("keydown", handleKeyDown);
                    confirmationPopup.style.display = "none";
                    // R√©sout la promesse avec `true` si l'utilisateur a confirm√©
                    resolve(true);
                });

                newNoBtn.addEventListener("click", () => {
                    document.removeEventListener("keydown", handleKeyDown);
                    confirmationPopup.style.display = "none";
                    // R√©sout la promesse avec `false` si l'utilisateur a annul√©
                    resolve(false);
                });
            });
        }



        async function handleDeleteEvent(userId, telefono, row, recurrenceRuleJson, recurrenceId, extra = {}) {
            if (recurrenceId) {
                // Ouvrir le popup personnalis√© (popup5 avec 3 boutons)
                const popup = document.getElementById("popup5");
                popup.style.display = "block";

                return new Promise((resolve) => {
                    // Supprimer toute la s√©rie
                    document.getElementById("deleteSeriesBtn").onclick = async () => { // Ajoutez 'async' ici
                        popup.style.display = "none";
                        const userConfirmed = await showConfirmation();
                        if (userConfirmed) {
                            const { error } = await supabase
                                .from('event_quot1_fran')
                                .delete()
                                .eq('recurrence_id', String(recurrenceId)); // Enlevez la parenth√®se et le point-virgule en trop

                            if (error) {
                                console.error("Erreur suppression s√©rie :", error);
                                return;
                            } else {
                                console.log("S√©rie supprim√©e avec recurrence_id:", recurrenceId);
                            }

                            finalizeDelete(row, telefono, userId, extra);
                            resolve();
                        }
                    };

                    // Supprimer un seul √©v√©nement
                    document.getElementById("deleteOneBtn").onclick = async () => { // Ajoutez 'async' ici
                        popup.style.display = "none";
                        const userConfirmed = await showConfirmation();
                        if (userConfirmed) {
                            const { error: deleteErrorEventQuot1 } = await supabase
                                .from('event_quot1_fran')
                                .delete()
                                .eq('user_id', userId); // Enlevez la parenth√®se et le point-virgule en trop

                            if (deleteErrorEventQuot1) {
                                console.error("Erreur suppression √©v√©nement :", deleteErrorEventQuot1);
                                return;
                            } else {
                                console.log("‚úÖ √âv√©nement supprim√© :", userId);
                            }

                            finalizeDelete(row, telefono, userId, extra);
                            resolve();
                        }
                    };

                    // Annuler
                    document.getElementById("cancelBtn").onclick = () => {
                        popup.style.display = "none";
                        resolve(); // rien ne se passe
                    };
                });
            } else {
                // Pas de r√®gle -> suppression normale
                const userConfirmed = await showConfirmation(); // Utilisez await ici aussi
                if (userConfirmed) {
                    const { error: deleteErrorEventQuot1 } = await supabase
                        .from('event_quot1_fran')
                        .delete()
                        .eq('user_id', userId);

                    if (deleteErrorEventQuot1) {
                        console.error("Erreur suppression √©v√©nement :", deleteErrorEventQuot1);
                        return;
                    } else {
                        console.log("‚úÖ √âv√©nement supprim√© :", userId);
                    }

                    finalizeDelete(row, telefono, userId, extra);
                }
            }
        }

        // NOTE: Assurez-vous d'avoir les fonctions isOnline, addToQueue et syncData d√©finies.

        async function updateEventData(row, rendezvousActuel, applySeries = false, recurrenceId = null, modificationsFromRow = {}) {
          const userId = row.dataset.userId;
          const modifiePar = localStorage.getItem('currentPersonName');
          const dateModification = getLocalDateTime();

          // ‚ö° D√©tecter uniquement les champs qui ont vraiment chang√©
          const champsModifies = {};
          for (const [col, newVal] of Object.entries(modificationsFromRow)) {
            const oldVal = rendezvousActuel[col];
            if (String(newVal) !== String(oldVal)) { // Utilisation de String() pour comparaison stricte des valeurs
              champsModifies[col] = newVal;
            }
          }

          // ‚ö° Ne jamais toucher √† ces colonnes
          delete champsModifies["Date"];
          delete champsModifies["user_id"];
          delete champsModifies["recurrence_id"];
          delete champsModifies["Travail"];
          delete champsModifies["Observations"];
          delete champsModifies["Pointage"];


          const colonnesAMettreAJour = Object.keys(champsModifies);

          if (colonnesAMettreAJour.length === 0) {
            console.log("‚ÑπÔ∏è Aucun changement d√©tect√©, rien √† mettre √† jour.");
            return;
          }

          // üöÄ Fonction pour enregistrer l'historique (MIS √Ä JOUR POUR LE HORS LIGNE)
          const logModifications = async (targetUserId, originalEventData, modifiedFields) => {
            const nombre = originalEventData['Nom'] || '-';
            const telephone = originalEventData['T√©l√©phone'] || '-';

            for (const [column, nouvelleValeur] of Object.entries(modifiedFields)) {
              const ancienneValeur = originalEventData[column];

              if (String(ancienneValeur) !== String(nouvelleValeur)) {
                // üö® IMPORTANT : On n'enregistre PAS l'historique directement en base.
                // On le loggue localement pour que l'utilisateur le voie, mais l'enregistrement
                // final en BDD est laiss√© √† la fonction de synchronisation si vous voulez
                // traiter l'historique comme une file d'attente.
                // Pour ce cas, on le laisse en appel direct pour l'instant, mais gardez cette
                // potentielle limite √† l'esprit en cas de d√©connexion.
                // Si vous voulez le mettre en file d'attente, il faudrait que logModification
                // utilise aussi addToQueue pour les op√©rations INSERT.

                // POUR LA SIMPLICIT√â, on garde l'enregistrement direct (il √©chouera hors ligne)
                // et on suppose que l'utilisateur verra son historique se mettre √† jour apr√®s reconnexion.
                await supabase
                  .from("historique_modif_fran")
                  .insert([{
                    user_id: targetUserId,
                    modifi√©_par: modifiePar,
                    date_modification: dateModification,
                    champ_modifi√©: column,
                    valeur_ancienne: ancienneValeur,
                    valeur_nouvelle: nouvelleValeur,
                    action: 'Modification',
                    Nombre: nombre,
                    Telefono: telephone
                  }]);
              }
            }
          };

          try {
            const eventsToUpdate = []; // Stocke les requ√™tes d'UPDATE (Payload + Cible)

            for (const column of colonnesAMettreAJour) {
                const valeurNouvelle = champsModifies[column];
                const updatePayload = { [column]: valeurNouvelle };
                const specificChange = { [column]: valeurNouvelle };

                if (applySeries && recurrenceId) {
                    // Logique s√©rie
                    const { data: allEvents, error } = isOnline() ? await supabase
                        .from('event_quot1_fran')
                        .select('*')
                        .eq('recurrence_id', recurrenceId) : { data: [], error: null }; // Lit la s√©rie en ligne ou rien hors ligne

                    if (error) {
                        console.error("Erreur r√©cup√©ration s√©rie en ligne. Arr√™t.", error);
                        return;
                    }

                    const currentDate = new Date(rendezvousActuel.Date);

                    for (const evt of allEvents) {
                        const evtDate = new Date(evt.Date);

                        if (evtDate >= currentDate) {
                            // Logger la modification
                            await logModifications(evt.user_id, evt, specificChange);

                            // Ajouter √† la liste des requ√™tes
                            eventsToUpdate.push({
                                targetTable: 'event_quot1_fran',
                                targetId: { user_id: evt.user_id },
                                payload: updatePayload
                            });
                        }
                    }

                } else {
                    // Cas simple : mise √† jour chirurgicale d'un seul √©v√©nement

                    // Logger la modification
                    await logModifications(userId, rendezvousActuel, specificChange);

                    // Ajouter √† la liste des requ√™tes
                    eventsToUpdate.push({
                        targetTable: 'event_quot1_fran',
                        targetId: { user_id: userId },
                        payload: updatePayload
                    });
                }
            }

            // --- NOUVEAU: TRAITEMENT DES REQU√äTES EN FILE D'ATTENTE ---
            if (eventsToUpdate.length > 0) {

                // 1. Enregistre toutes les requ√™tes dans la file d'attente locale
                for (const req of eventsToUpdate) {
                    await addToQueue({ type: 'UPDATE', ...req });
                }

                console.log(`‚úÖ ${eventsToUpdate.length} requ√™te(s) ajout√©e(s) √† la file d'attente locale.`);

                // 2. Lance la synchronisation si en ligne
                if (isOnline()) {
                    console.log("üì° En ligne. Tentative de synchronisation imm√©diate.");
                    syncData();
                }
            }

            // Message succ√®s visuel (indique que la modification est enregistr√©e)
            window.successMessage.textContent = getTranslation('temp_msg_data_updated_success');
            window.successMessage.style.display = 'block';
            setTimeout(() => {
              window.successMessage.style.display = 'none';
            }, 1000);

          } catch (e) {
            console.error("‚ùå Erreur updateEventData :", e);
          }
        }


        //--------------------------------------------------------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------------------------------------------------------

        // Appel√©e lors du clic sur une date dans le calendrier
        async function handleDateClick(event) {
            const selectedDate = event.currentTarget.dataset.date;

            // Mettre √† jour le champ de date et stocker la date s√©lectionn√©e dans localStorage
            document.getElementById('Date').value = selectedDate;
            localStorage.setItem('selectedDate', selectedDate);

            // Mettre en surbrillance la date s√©lectionn√©e
            document.querySelectorAll('.clickable').forEach(cell => cell.classList.remove('selected'));
            event.target.classList.add('selected');

            getAndDisplayWeatherForDate(selectedDate);

            // Charger la note pour la date s√©lectionn√©e
            // Assurez-vous que fetchNoteForDate est votre fonction loadDailyNoteForDate corrig√©e
            const note = await fetchNoteForDate(selectedDate); // Ou loadDailyNoteForDate

            // --- D'abord, ouvrir le modal ---
            const editNoteModal = document.getElementById('editNoteModal');
            if (editNoteModal) {
                editNoteModal.style.display = 'block'; // Rendre la modale visible en PREMIER
            } else {
                console.error("Erreur: L'√©l√©ment '#editNoteModal' est introuvable. Impossible d'ouvrir la modale.");
                return; // Arr√™ter si la modale principale n'est pas l√†
            }

            // --- Ensuite, manipuler les √©l√©ments internes APR√àS que la modale soit visible ---
            // Utiliser requestAnimationFrame pour s'assurer que le navigateur a eu le temps de rendre la modale
            requestAnimationFrame(() => {
                const modalDateElement = document.getElementById('modalDate');
                if (modalDateElement) {
                    modalDateElement.textContent = selectedDate; // Afficher la date dans le modal
                } else {
                    console.error("Erreur: L'√©l√©ment 'modalDate' est introuvable APR√àS l'affichage de la modale.");
                }

                const noteTextElement = document.getElementById('noteText');
                if (noteTextElement) {
                    noteTextElement.value = note || ''; // Si la note est nulle, on affiche un champ vide
                } else {
                    console.error("Erreur: L'√©l√©ment 'noteText' est introuvable APR√àS l'affichage de la modale.");
                }
            });

            // Appeler fetchEventsByDate pour charger les √©v√©nements de la date cliqu√©e
            if (evenementsRecherche && evenementsRecherche.length > 0) {
                // ‚ö° Filtrer seulement par date car Supabase a d√©j√† appliqu√© le filtre texte
                const filtres = evenementsRecherche.filter(evt => evt.Date === selectedDate);

                console.log("üîé Filtres appliqu√©s:", selectedDate, filtres);
                fetchEventsByDate(selectedDate, filtres);
            } else {
                // ‚úÖ Aucun filtre ‚Üí comportement normal
                fetchEventsByDate(selectedDate);
            }

        }

        //--------------------------------------------------------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------------------------------------------------------

        // Apr√®s la d√©finition de votre tableau (par exemple, apr√®s fetchEventsByDate ou handleDateClick)
        document.querySelector('#editable-table tbody').addEventListener('click', async function(event) {
            const targetCell = event.target.closest('.editable-select-cell');

            // R√©cup√©rez isConfigUser ici, car cette fonction n'est pas dans le m√™me scope que fetchEventsByDate
            // Assurez-vous que isConfigUser est bien disponible ou r√©cup√©rez-le depuis localStorage ici.
            // Par exemple:
            const isConfigUser = localStorage.getItem('currentPersonIsConfigUser') === 'true';

            if (targetCell && targetCell.dataset.column === 'Ajout√©_pour') {
                const currentValue = targetCell.dataset.currentValue;

                // Cr√©er le menu d√©roulant si ce n'est pas d√©j√† un select
                if (!targetCell.querySelector('select')) {
                    // AJOUTEZ CETTE CONDITION ICI
                    if (isConfigUser) { // <--- C'est la condition cl√©
                        const selectElement = document.createElement('select');
                        selectElement.className = 'employee-select';

                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = getTranslation('option_choose'); // Traduire
                        selectElement.appendChild(defaultOption);

                        // Remplir le select avec les noms des employ√©s
                        // NOTE : Assurez-vous que 'employeeNames' est accessible dans ce scope.
                        // Si 'employeeNames' est d√©fini dans 'fetchEventsByDate', vous devrez
                        // le rendre global ou le passer d'une autre mani√®re, ou le r√©cup√©rer ici.
                        employeeNames.forEach(name => {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            if (name === currentValue) {
                                option.selected = true;
                            }
                            selectElement.appendChild(option);
                        });

                        // Vider la cellule et ajouter le select
                        targetCell.innerHTML = '';
                        targetCell.appendChild(selectElement);
                        selectElement.focus();

                        // G√©rer le changement de valeur
                        selectElement.addEventListener('change', function() {
                            const newValue = this.value;
                            targetCell.dataset.currentValue = newValue;
                            targetCell.textContent = newValue;

                            const row = targetCell.closest('tr');
                            const userId = row.dataset.userId;

                            // Ici on NE FAIT PLUS de PATCH direct !
                            // On marque juste la ligne comme modifi√©e ‚Üí Apply s'en chargera
                            if (userId && newValue) {
                                row.classList.add("modified");
                                console.log("Ajout√©_pour modifi√© localement pour", userId, "‚Üí", newValue, "(en attente Apply)");
                            }
                        });

                        // G√©rer la perte de focus (clic en dehors)
                        selectElement.addEventListener('blur', function() {
                            if (!this.value) {
                                targetCell.textContent = targetCell.dataset.currentValue;
                            }
                        });

                        // G√©rer la perte de focus (clic en dehors)
                        selectElement.addEventListener('blur', function() {
                            if (!this.value) {
                                targetCell.textContent = targetCell.dataset.currentValue;
                            }
                        });
                    } // FIN DE LA CONDITION if (isConfigUser)
                }
            }
        });

        async function envoyerMessageWhatsApp(tipoMensaje, row) {
             // Attendre que le pr√©fixe soit charg√©
             await chargerPrefixe();
             console.log(getTranslation("log_whatsapp_prefix_used"), countryPrefix); // Traduire

             const t√©l√©phoneCell = row.querySelector('[data-column="T√©l√©phone"]');
             const nomCell = row.querySelector('[data-column="Nom"]');
             const paiementLink = row.querySelector('.paiement-link');

             if (!t√©l√©phoneCell || t√©l√©phoneCell.textContent.trim() === '') {
                 alert(getTranslation('alert_phone_number_missing')); // Traduire
                 return;
             }

             let t√©l√©phone = t√©l√©phoneCell.textContent.trim();

             // Ajoutez le pr√©fixe uniquement si le num√©ro a 10 chiffres
             if (t√©l√©phone.length === 10) {
                 t√©l√©phone = countryPrefix + t√©l√©phone;
             }

             let mensaje = '';

             // Construire le message selon le type
             switch (tipoMensaje) {
                 case 1:
                     mensaje = getTranslation('whatsapp_msg_type_1'); // Traduire
                     break;
                 case 2:
                     mensaje = getTranslation('whatsapp_msg_type_2'); // Traduire
                     break;
                 case 3:
                     mensaje = getTranslation('whatsapp_msg_type_3'); // Traduire
                     break;
                 case 4:
                     const dateCell = row.querySelector('[data-column="Date"]')?.textContent?.trim() || getTranslation('date_not_available'); // Traduire
                     const heureCell = row.querySelector('[data-column="Heure"]')?.textContent?.trim() || '';
                     const minCell = row.querySelector('[data-column="Min"]')?.textContent?.trim() || '';
                     const lieuCell = row.querySelector('[data-column="Lieu"]')?.textContent?.trim() || getTranslation('location_not_available'); // Traduire
                     const travailCell = row.querySelector('[data-column="Travail"]')?.textContent?.trim() || getTranslation('work_not_specified'); // Traduire

                     mensaje = getTranslation('whatsapp_msg_type_4_part1') + `\n\n*` + getTranslation('whatsapp_msg_type_4_confirmation_title') + `*\n\n- ` + getTranslation('whatsapp_msg_type_4_date') + `: ${dateCell}\n- ` + getTranslation('whatsapp_msg_type_4_time') + `: ${heureCell}:${minCell}\n- ` + getTranslation('whatsapp_msg_type_4_location') + `: ${lieuCell}\n- ` + getTranslation('whatsapp_msg_type_4_work') + `: ${travailCell}\n\n` + getTranslation('whatsapp_msg_type_4_part2'); // Traduire
                     break;
             }

             let whatsappUrl = `https://api.whatsapp.com/send?phone=${t√©l√©phone}&text=${encodeURIComponent(mensaje)}`;
             console.log(getTranslation("log_whatsapp_initial_url"), whatsappUrl); // Traduire

             // Ajouter le lien de la facture uniquement pour les messages 1, 2 et 3
             if (tipoMensaje !== 4 && paiementLink && paiementLink.getAttribute('data-paiement')) {
                 const paiement = paiementLink.getAttribute('data-paiement');

                 // Obtenir l'URL sign√©e du paiement
                 try {
                     const { data, error } = await supabase.storage.from('facturas_fran').createSignedUrl(paiement, 86400);
                     if (error || !data) {
                         console.error(getTranslation('error_getting_signed_invoice'), error); // Traduire
                         return;
                     }

                     const fileUrl = data.signedUrl;
                     console.log(getTranslation("log_signed_payment_url_obtained"), fileUrl); // Traduire

                     // Ajouter l'URL du paiement au message
                     whatsappUrl += `%0A%0A` + getTranslation('whatsapp_msg_payment_link_label') + `: ${encodeURIComponent(fileUrl)}`; // Traduire
                     console.log(getTranslation("log_whatsapp_final_url_with_payment"), whatsappUrl); // Traduire

                     // Ouvrir WhatsApp avec l'URL finale apr√®s un l√©ger d√©lai
                     setTimeout(() => {
                         window.open(whatsappUrl, '_blank');
                     }, 4000); // D√©lai de 4 secondes pour garantir la prise en compte du lien complet

                 } catch (error) {
                     console.error(getTranslation('error_creating_signed_invoice_url'), error); // Traduire
                 }
             } else {
                 // Si pas de paiement, ouvrir directement WhatsApp avec le message de base
                 window.open(whatsappUrl, '_blank');
             }
        }

        // Fonction pour charger les donn√©es de la table
        async function loadTableData() {
            console.log(getTranslation('log_loadTableData_called'));
            const today = getLocalDateString();
            console.log("üìÖ loadTableData a re√ßu la date :", today);
            // ‚úÖ MAINTENANT : AUCUN appel √† fetchEventsByDate
            // Les √©v√©nements sont charg√©s UNIQUEMENT par selectToday()
        }

         function getHourOrder(hour) {
            const hourOrder = {
                "7h": 1,
                "8h": 2,
                "9h": 3,
                "10h": 4,
                "11h": 5,
                "12h": 6,
                "13h": 7,
                "14h": 8,
                "15h": 9,
                "16h": 10,
                "17h": 11,
                "18h": 12,
                "19h": 13,
                "20h": 14,
                "21h": 15,
                "Autre": 16
            };
            return hourOrder[hour] || 17; // Retourne 15 pour les heures non d√©finies
        }

        function toggleNoteElements(noteType) {
            const textarea = document.getElementById('notesTextarea');
            const addTaskContainer = document.getElementById('addTaskContainer');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const canvasContainer = document.getElementById('canvasContainer');

            switch(noteType) {
                case 1: // Note normale
                    textarea.style.display = 'block';
                    addTaskContainer.style.display = 'block';
                    addTaskBtn.style.display = 'block';
                    canvasContainer.style.display = 'none';
                    break;
                case 2: // Note manuscrite
                    textarea.style.display = 'none';
                    addTaskContainer.style.display = 'none';
                    addTaskBtn.style.display = 'none';
                    canvasContainer.style.display = 'block';
                    break;
                case 3: // To-do
                    textarea.style.display = 'block';
                    addTaskContainer.style.display = 'block';
                    addTaskBtn.style.display = 'block';
                    canvasContainer.style.display = 'none';
                    break;
                default:
                    // Par d√©faut, afficher note normale
                    textarea.style.display = 'block';
                    addTaskContainer.style.display = 'block';
                    addTaskBtn.style.display = 'block';
                    canvasContainer.style.display = 'none';
            }
        }

        // Fonction pour v√©rifier s'il y a des notes et mettre √† jour l'apparence des boutons
        async function checkAndHighlightNotes(date) {
            try {
                console.log(`üîç V√©rification des notes pour la date: ${date}`);

                // ‚úÖ TOUJOURS R√âINITIALISER D'ABORD
                resetNoteButtons();

                // R√©cup√©rer TOUTES les notes pour cette date
                const { data: notes } = await supabase
                    .from('daily_notes1_fran')
                    .select('type, notes, todo_notes') // RETIRER canvas_data
                    .eq('date', date);

                console.log(`üìù Notes trouv√©es pour ${date}:`, notes);

                if (!notes || notes.length === 0) {
                    console.log(`‚ÑπÔ∏è Aucune note trouv√©e pour ${date}`);
                    return;
                }

                // V√©rifier chaque type de note
                notes.forEach(note => {
                    const hasContent = (note.type === 1 && note.notes && note.notes.trim() !== '') ||
                                      (note.type === 2 && note.notes && note.notes.trim() !== '') || // Utiliser notes pour type 2
                                      (note.type === 3 && note.todo_notes && note.todo_notes !== '[]');

                    console.log(`Type ${note.type} a du contenu:`, hasContent);

                    if (hasContent) {
                        highlightNoteButton(note.type);

                        // Si c'est une note manuscrite, NE PAS charger automatiquement le textarea
                        if (note.type === 2) {
                            console.log('üñäÔ∏è Note manuscrite d√©tect√©e - NE PAS charger automatiquement');
                            const textarea = document.getElementById('notesTextarea');
                            const addTaskContainer = document.getElementById('addTaskContainer');
                            const addTaskBtn = document.getElementById('addTaskBtn');

                            if (textarea) textarea.style.display = 'none';
                            if (addTaskContainer) addTaskContainer.style.display = 'none';
                            if (addTaskBtn) addTaskBtn.style.display = 'none';
                        }
                    }
                });

            } catch (error) {
                console.error('Erreur lors de la v√©rification des notes :', error);
            }
        }

        // Fonction pour r√©initialiser les boutons
        function resetNoteButtons() {
            console.log('üîÑ R√©initialisation des boutons de notes');

            const buttons = [
                document.getElementById('normalNoteBtn'),
                document.getElementById('manualNoteBtn'),
                document.getElementById('todoListBtn')
            ];

            buttons.forEach(button => {
                if (button) {
                    // ‚úÖ R√©initialiser TOUS les styles
                    button.style.backgroundColor = '';
                    button.style.borderColor = '';
                    button.style.color = '';
                    button.style.fontWeight = '';
                    button.classList.remove('has-note');


                }
            });
        }

        // Fonction pour mettre en √©vidence un bouton
        function highlightNoteButton(noteType) {
            let button;

            switch(noteType) {
                case 1:
                    button = document.getElementById('normalNoteBtn');
                    break;
                case 2:
                    button = document.getElementById('manualNoteBtn');
                    break;
                case 3:
                    button = document.getElementById('todoListBtn');
                    break;
            }

            if (button) {
                button.style.backgroundColor = '#ffebee'; // Rouge tr√®s clair
                button.style.borderColor = '#f44336';     // Rouge
                button.style.color = '#c62828';           // Rouge fonc√©
                button.classList.add('has-note');
            }
        }


        let isDateFetched = false; // Flag pour suivre si fetchEventsByDate a √©t√© appel√©

        // Affiche une note normale
        async function showNormalNote(date) {
            const { data } = await supabase
                .from('daily_notes1_fran')
                .select('notes')
                .eq('date', date)
                .eq('type', 1)
                .maybeSingle();

            document.getElementById('noteText').value = data ? data.notes : "";
            setNoteType(1);
        }

        // Affiche une note manuscrite CORRIG√âE
        async function showManualNote(date) {
            console.log('üé® showManualNote appel√©e pour:', date);

            try {
                const { data } = await supabase
                    .from('daily_notes1_fran')
                    .select('notes') // Utiliser uniquement 'notes'
                    .eq('date', date)
                    .eq('type', 2)
                    .maybeSingle();

                console.log('üìã Donn√©es r√©cup√©r√©es pour note manuscrite:', data);

                // Mettre √† jour le type de note
                setNoteType(2);

                // G√©rer l'affichage des √©l√©ments
                const notesTextarea = document.getElementById('notesTextarea');
                if (notesTextarea) notesTextarea.style.display = 'none';
                const addTaskContainer = document.getElementById('addTaskContainer');
                if (addTaskContainer) addTaskContainer.style.display = 'none';
                const addTaskBtn = document.getElementById('addTaskBtn');
                if (addTaskBtn) addTaskBtn.style.display = 'none';
                const canvasContainer = document.getElementById('canvasContainer');
                if (canvasContainer) canvasContainer.style.display = 'block';

                // Mettre en surbrillance le bouton
                const manualNoteBtn = document.getElementById('manualNoteBtn');
                const normalNoteBtn = document.getElementById('normalNoteBtn');
                const todoNoteBtn = document.getElementById('todoNoteBtn');

                if (manualNoteBtn) manualNoteBtn.classList.add('active');
                if (normalNoteBtn) normalNoteBtn.classList.remove('active');
                if (todoNoteBtn) todoNoteBtn.classList.remove('active');

                const canvas = document.getElementById('noteCanvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (data && data.notes) {
                    console.log('üñºÔ∏è Chargement des donn√©es canvas depuis notes...');
                    const image = new Image();
                    image.onload = () => {
                        canvas.width = image.width;
                        canvas.height = image.height;
                        ctx.drawImage(image, 0, 0);
                        console.log('‚úÖ Canvas recharg√© avec succ√®s');


                    };
                    image.onerror = () => {
                        console.error('‚ùå Erreur lors du chargement de l\'image');
                    };
                    image.src = data.notes;
                } else {
                    console.log('‚ÑπÔ∏è Aucune donn√©e canvas trouv√©e, canvas effac√©');
                }

            } catch (error) {
                console.error('‚ùå Erreur dans showManualNote:', error);
            }
        }

        // Affiche une to-do liste
        async function showTodoList(date) {
            const { data } = await supabase
                .from('daily_notes1_fran')
                .select('todo_notes')
                .eq('date', date)
                .eq('type', 3)
                .maybeSingle();

            const todoList = document.getElementById('todoList');
            todoList.innerHTML = '';

            if (data) {
                const todos = JSON.parse(data.todo_notes);
                todos.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<input type="checkbox" ${item.completed ? 'checked' : ''}> <span>${item.text}</span>`;
                    todoList.appendChild(li);
                });
            }
            setNoteType(3);
        }

        async function selectToday() {
            console.log('--- Appel de la fonction selectToday() ---');

            if (performance.navigation.type === performance.navigation.TYPE_RELOAD) {
                localStorage.removeItem('selectedDate');
            }

            const storedDate = localStorage.getItem('selectedDate');
            const today = getLocalDateString();
            const selectedDate = storedDate || today;

            document.getElementById('Date').value = selectedDate;
            console.log('üìÖ Date s√©lectionn√©e :', selectedDate);

            await fetchEventsByDate(selectedDate);

            document.querySelectorAll('.clickable').forEach(cell => {
                cell.classList.remove('selected');
                if (cell.dataset.date === selectedDate) {
                    cell.classList.add('selected');
                }
            });

            try {
                // ‚úÖ AJOUT : D√©tecter et charger le bon type de note automatiquement
                await loadAppropriateNoteType(selectedDate);

                document.getElementById('editNoteModal').style.display = 'block';

                document.getElementById('normalNoteBtn').onclick = () => showNormalNote(selectedDate);
                document.getElementById('manualNoteBtn').onclick = () => showManualNote(selectedDate);
                document.getElementById('todoListBtn').onclick = () => showTodoList(selectedDate);

            } catch (error) {
                console.error('Erreur inattendue :', error);
                document.getElementById('noteText').value = "";
                document.getElementById('editNoteModal').style.display = 'block';
            }
            console.log('--- Fin de la fonction selectToday() ---');
        }

        // ‚úÖ NOUVELLE FONCTION : Charger automatiquement le bon type de note
        async function loadAppropriateNoteType(date) {
            try {
                const { data: notes } = await supabase
                    .from('daily_notes1_fran')
                    .select('type, notes, todo_notes')
                    .eq('date', date);

                if (!notes || notes.length === 0) {
                    console.log('‚ÑπÔ∏è Aucune note trouv√©e, chargement to-do par d√©faut');
                    await showTodoList(date);
                    return;
                }

                // ‚úÖ PRIORIT√â : Note normale > To-do liste > Note manuscrite
                const normalNote = notes.find(note => note.type === 1 && note.notes && note.notes.trim() !== '');
                const todoNote = notes.find(note => note.type === 3 && note.todo_notes && note.todo_notes !== '[]');
                const manualNote = notes.find(note => note.type === 2 && note.notes && note.notes.trim() !== '');

                if (normalNote) {
                    console.log('üìù Chargement AUTOMATIQUE note normale');
                    await showNormalNote(date);
                } else if (todoNote) {
                    console.log('‚úÖ Chargement AUTOMATIQUE to-do liste');
                    await showTodoList(date);
                } else if (manualNote) {
                    console.log('üñäÔ∏è Chargement AUTOMATIQUE note manuscrite');
                    await showManualNote(date);
                } else {
                    console.log('üìù Aucun contenu valide, chargement to-do par d√©faut');
                    await showTodoList(date);
                }

            } catch (error) {
                console.error('Erreur lors du chargement automatique des notes:', error);
                await showTodoList(date);
            }
        }

        window.onload = function() {
            console.log('üöÄ window.onload ex√©cut√©');

            loadDailyNotes();

            populateEmployeSelect();

            const formattedToday = getLocalDateString();
            document.getElementById('modalDate').innerText = formattedToday;

            // ‚úÖ SUPPRIMEZ tout le bloc avec querySelectorAll et REMPLACEZ par ceci :
            document.addEventListener('click', function(event) {
                const cell = event.target.closest('.clickable');

                if (cell) {
                    const dateClicked = cell.dataset.date;
                    console.log('üóìÔ∏è Clic d√©tect√© sur la date:', dateClicked);

                    if (dateClicked && /^\d{4}-\d{2}-\d{2}$/.test(dateClicked)) {
                        localStorage.setItem('selectedDate', dateClicked);
                        console.log('üíæ Date enregistr√©e:', dateClicked);

                        document.getElementById('modalDate').innerText = dateClicked;

                        // AJOUTEZ CES 3 LIGNES ICI :
                        document.getElementById('normalNoteBtn').onclick = () => showNormalNote(dateClicked);
                        document.getElementById('manualNoteBtn').onclick = () => showManualNote(dateClicked);
                        document.getElementById('todoListBtn').onclick = () => showTodoList(dateClicked);

                        // Fonction async imm√©diate pour g√©rer les await
                        (async () => {
                            await fetchEventsByDate(dateClicked);
                            console.log('üé® Appel de checkAndHighlightNotes pour:', dateClicked);
                            await checkAndHighlightNotes(dateClicked);
                            await loadAppropriateNoteType(dateClicked);
                        })();
                    }
                }
            });
        };

         function saveDate() {
             const selectedDateDisplay = document.getElementById('selectedDateDisplay');
             const selectedDate = selectedDateDisplay.textContent.split(' : ')[1];
             const tableBody = document.querySelector('#editable-table tbody');
             const rows = tableBody.querySelectorAll('tr');

             event[selectedDate] = [];
             rows.forEach(row => {
                 const cells = row.querySelectorAll('td');
                 const rowData = {
                    t√©l√©phone: cells[0].textContent,
                    nom: cells[1].textContent,
                    date: cells[2].textContent,
                    heure: cells[3].textContent,
                    min: cells[4].textContent,
                    lieu: cells[5].textContent,
                    prix: cells[6].textContent,
                    travail: cells[7].textContent,
                    observations: row.querySelector('textarea.observation-text')?.value || '',
                    photo_avant_url: row.querySelector('.photo-avant')?.src || null,
                    photo_apres_url: row.querySelector('.photo-apres')?.src || null,
                    ajout√©_pour: cells[9].textContent,
                    user_id: cells[10].textContent,
                    env_donn√©es: cells[11].querySelector('[data-column="env_donn√©es"]').checked,
                    paiement: cells[11].querySelector('.paiement-link').dataset.paiement,
                    pay√©: cells[11].querySelector('[data-column="pay√©"]').checked
                };
                 event[selectedDate].push(rowData);

             });

             alert(getTranslation('alert_agenda_saved_for_date') + ' ' + selectedDate); // Traduire
         }

        async function fetchNoteForDate(date, noteType = 1) {
            try {
                const { data, error } = await supabase
                    .from('daily_notes1_fran')
                    .select('notes')
                    .eq('date', date)
                    .eq('type', noteType)
                    .maybeSingle();

                if (error) {
                    console.error('error_fetching_note_colon', error);
                    return null;
                }
                return data ? data.notes : '';
            } catch (err) {
                console.error('error_unexpected_colon', err);
                return null;
            }
        }

         async function updateCheckbox(event) {
             const row = event.target.closest('tr');
             const column = event.target.dataset.column;
             const value = event.target.checked;
             const userId = row.dataset.userId;

             const { error } = await supabase
                 .from('event_quot1_fran')
                 .update({ [column]: value })
                 .eq('user_id', userId);

             if (error) {
                 console.error(getTranslation('error_updating_column') + ` ${column} :`, error); // Traduire
             } else {
                 console.log(getTranslation('log_column_updated_success') + ` ${column}`); // Traduire
             }
         }

         async function envoyerMessageWhatsAppPourRendezVous(rendezvous) {
             const t√©l√©phone = rendezvous.T√©l√©phone;
             const nom = rendezvous.Nom;
             const date = rendezvous.Date || getTranslation('date_not_available'); // Traduire
             const heure = rendezvous.Heure || '';
             const min = rendezvous.Min || '00';
             const lieu = rendezvous.Lieu || getTranslation('location_not_available'); // Traduire

             // Construire le message pour le rappel
             const mensaje = getTranslation('whatsapp_reminder_message_part1') + `\n\n*` + getTranslation('whatsapp_reminder_message_confirmation_title') + `*\n\n- ` + getTranslation('whatsapp_reminder_message_date') + `: ${date}\n- ` + getTranslation('whatsapp_reminder_message_time') + `: ${heure}:${min}\n- ` + getTranslation('whatsapp_reminder_message_location') + `: ${lieu}\n\n` + getTranslation('whatsapp_reminder_message_part2'); // Traduire

             const whatsappUrl = `https://web.whatsapp.com/send?phone=${t√©l√©phone}&text=${encodeURIComponent(mensaje)}`;

             // D√©lai de 2 secondes avant d'ouvrir WhatsApp
             await new Promise(resolve => setTimeout(resolve, 2000));
             window.open(whatsappUrl, '_blank');
         }


         // Fonction pour envoyer les rappels avec un d√©lai de 10 secondes entre chaque envoi
         async function envoyerRappelAutomatique() {
             const heureActuelle = new Date();
             const dateDuJour = heureActuelle.toISOString().split('T')[0]; // Date au format 'YYYY-MM-DD' pour aujourd'hui

             // R√©cup√©rer tous les rendez-vous du jour qui n'ont pas encore re√ßu de rappel
             const { data: rendezVous, error } = await supabase
                 .from('event_quot1_fran')
                 .select('*')
                 .eq('rappel_envoy√©', false)
                 .eq('Date', dateDuJour);

             if (error) {
                 console.error(getTranslation('error_fetching_appointments_colon'), error); // Traduire
                 return;
             }

             // Boucle asynchrone avec d√©lai de 10 secondes entre chaque envoi
             for (const rendezvous of rendezVous) {
                 const heureActuelle = new Date();
                 const dateDuJour = rendezvous.Date;

                 // Conversion de l'heure en format 24h
                 let [heure, suffixe] = rendezvous.Heure.match(/(\d+)(am|pm)/i).slice(1);
                 heure = parseInt(heure, 10);
                 if (suffixe.toLowerCase() === 'pm' && heure !== 12) {
                     heure += 12;
                 } else if (suffixe.toLowerCase() === 'am' && heure === 12) {
                     heure = 0;
                 }

                 // Si 'Min' est null, on le remplace par ''
                 const minutes = rendezvous.Min ? String(rendezvous.Min).padStart(2, '0') : '00';

                 // Cr√©ation de l'objet Date pour le rendez-vous
                 const heureRendezvous = new Date(`${dateDuJour}T${heure.toString().padStart(2, '0')}:${minutes}:00`);

                 console.log(getTranslation("log_checking_appointment_colon"), rendezvous); // Traduire
                 console.log(getTranslation("log_current_time_colon"), heureActuelle); // Traduire
                 console.log(getTranslation("log_appointment_time_colon"), heureRendezvous); // Traduire

                 // Envoyer le rappel si le rendez-vous est aujourd'hui et plus tard que l'heure actuelle
                 if (heureRendezvous > heureActuelle) {
                     console.log(getTranslation("log_sending_reminder_for_appointment_colon"), rendezvous.user_id); // Traduire

                     await envoyerMessageWhatsAppPourRendezVous(rendezvous);

                     // Mettre √† jour rappel_envoy√© √† true pour √©viter les rappels r√©p√©t√©s
                     const { error: updateError } = await supabase
                         .from('event_quot1_fran')
                         .update({ rappel_envoy√©: true })
                         .eq('user_id', rendezvous.user_id);

                     if (updateError) {
                         console.error(getTranslation('error_updating_reminder_sent'), updateError); // Traduire
                     } else {
                         console.log(getTranslation('log_reminder_sent_updated_success_for_appointment'), rendezvous.user_id); // Traduire
                     }
                 }

                 // Attendre 10 secondes avant de passer au rendez-vous suivant
                 await new Promise(resolve => setTimeout(resolve, 10000));
             }
         }

         document.addEventListener('DOMContentLoaded', () => {
             const today = new Date();
             // Construisez la date du jour au format AAAA-MM-JJ manuellement pour √©viter le d√©calage
             const year = today.getFullYear();
             const month = String(today.getMonth() + 1).padStart(2, '0');
             const day = String(today.getDate()).padStart(2, '0');
             const initialDateString = `${year}-${month}-${day}`; // <-- MODIFI√â ICI
             getAndDisplayWeatherForDate(initialDateString);
         });

         // ‚ö°Ô∏è Placer √ßa UNE SEULE FOIS, apr√®s le DOMContentLoaded
        if (!window.toggleBtnListenerAttached) {
          document.addEventListener("click", (e) => {
            if (e.target.classList.contains("toggle-btn")) {
              const btn = e.target;
              const row = btn.closest("tr");
              const userId = row.dataset.userId;
              const isCurrentlyPlus = btn.classList.contains("plus");

              console.log("üëâ Clic d√©tect√© sur bouton vue. userId =", userId, " √©tat actuel =", btn.textContent);

              if (isCurrentlyPlus) {
                  // Passage simplifi√© (+) ‚Üí d√©taill√© (‚àí)
                  btn.textContent = "‚àí";
                  btn.classList.remove("plus");
                  btn.classList.add("minus");

                  // Masquer vue employ√©, montrer vue admin
                  row.querySelector(".normal-role").style.display = "none";
                  row.querySelector(".admin-role").style.display = "grid";

                  // Montrer lien Paiement
                  const paiementLink = row.querySelector(".paiement-link");
                  if (paiementLink) paiementLink.style.display = "inline-block";

                  // Montrer boutons detail-only
                  row.querySelectorAll(".detail-only").forEach(el => el.style.display = "inline-block");

                  if (userId) localStorage.setItem(`viewMode_${userId}`, "detailed");
                  console.log("üíæ Sauvegard√© localStorage viewMode =", "detailed");

                } else {
                  // Passage d√©taill√© (‚àí) ‚Üí simplifi√© (+)
                  btn.textContent = "+";
                  btn.classList.remove("minus");
                  btn.classList.add("plus");

                  // Montrer vue employ√©, masquer vue admin
                  row.querySelector(".normal-role").style.display = "grid";
                  row.querySelector(".admin-role").style.display = "none";

                  // Cacher lien Paiement
                  const paiementLink = row.querySelector(".paiement-link");
                  if (paiementLink) paiementLink.style.display = "none";

                  // Cacher boutons detail-only
                  row.querySelectorAll(".detail-only").forEach(el => el.style.display = "none");

                  if (userId) localStorage.setItem(`viewMode_${userId}`, "simple");
                  console.log("üíæ Sauvegard√© localStorage viewMode =", "simple");
                }



            }
          });
          window.toggleBtnListenerAttached = true; // ‚úÖ √©vite d‚Äôenregistrer plusieurs fois
        }


        let eventToDuplicate = null;

        // Ouvrir le modal avec les infos de l‚Äô√©v√©nement
        function openDuplicateModal(event) {
          eventToDuplicate = event;

          // Pr√©-remplir les champs avec les valeurs existantes
          document.getElementById("dupDate").value = event.Date || "";
          document.getElementById("dupTime").value = event.Heure || "";
          document.getElementById("dupMin").value = event.Min || "";

          // Remplir la liste des employ√©s
          const select = document.getElementById("dupAjoutePour");
            select.innerHTML = "";
            employeeNames.forEach(emp => {
              const opt = document.createElement("option");
              opt.value = emp;
              opt.textContent = emp;
              if (event.Ajout√©_pour === emp) opt.selected = true;
              select.appendChild(opt);
            });



          document.getElementById("duplicateModal").style.display = "flex";
        }

        // Fermer le modal
        document.getElementById("dupCancel").addEventListener("click", () => {
          document.getElementById("duplicateModal").style.display = "none";
        });

        // Confirmer duplication
        document.getElementById("dupConfirm").addEventListener("click", async () => {
          const newDate = document.getElementById("dupDate").value;
          const newHeure = document.getElementById("dupTime").value;
          const newMinInput = document.getElementById("dupMin").value;
          const newAjoutePour = document.getElementById("dupAjoutePour").value;

          if (!newDate || !newHeure) {
            alert("Veuillez remplir au minimum la date et l'heure.");
            return;
          }

          // ‚úÖ CORRECTION UNIQUE : Convertir la cha√Æne vide du champ en null.
          const newMin = newMinInput === "" ? null : newMinInput;

          // Nouvel UUID pour event_quot1_fran
          const newUserId = crypto.randomUUID();

          // Pr√©parer le nouvel √©v√©nement complet (event_quot1_fran)
          const newEvent = {
            T√©l√©phone: eventToDuplicate.T√©l√©phone,
            Nom: eventToDuplicate.Nom,
            Date: newDate,
            Heure: newHeure,
            Min: newMin,
            Lieu: eventToDuplicate.Lieu,
            Prix: eventToDuplicate.Prix,
            Travail: eventToDuplicate.Travail,
            Observations: eventToDuplicate.Observations,
            Ajout√©_pour: newAjoutePour,
            env_donn√©es: eventToDuplicate.env_donn√©es,
            paiement: eventToDuplicate.paiement,
            pay√©: eventToDuplicate.pay√©,
            user_id: newUserId,
            photo_avant_url: eventToDuplicate.photo_avant_url,
            photo_apres_url: eventToDuplicate.photo_apres_url
          };

          // Insert dans event_quot1_fran
          const { error: insertError1 } = await supabase
            .from("event_quot1_fran")
            .insert([newEvent]);

          if (insertError1) {
            console.error("Erreur duplication event_quot1_fran:", insertError1);
            alert("Erreur lors de la duplication !");
            return;
          }

          // V√©rifier si une ligne existe d√©j√† dans tableData1_fran pour ce t√©l√©phone
          const { data: existingRow, error: selectError } = await supabase
            .from("tableData1_fran")
            .select("T√©l√©phone")
            .eq("T√©l√©phone", eventToDuplicate.T√©l√©phone)
            .maybeSingle();

          if (selectError) {
            console.error("Erreur v√©rif tableData1_fran:", selectError);
          }

          if (existingRow) {
            // Si d√©j√† pr√©sent ‚Üí UPDATE
            const { error: updateError } = await supabase
              .from("tableData1_fran")
              .update({
                Nom: eventToDuplicate.Nom,
                Date: newDate,
                Heure: newHeure,
                Min: newMin,
                Lieu: eventToDuplicate.Lieu,
                Prix: eventToDuplicate.Prix,
                Travail: eventToDuplicate.Travail,
                Observations: eventToDuplicate.Observations,
                Ajout√©_pour: newAjoutePour,
                env_donn√©es: eventToDuplicate.env_donn√©es,
                paiement: eventToDuplicate.paiement,
                pay√©: eventToDuplicate.pay√©,
                photo_avant_url: eventToDuplicate.photo_avant_url,
                photo_apres_url: eventToDuplicate.photo_apres_url
              })
              .eq("T√©l√©phone", eventToDuplicate.T√©l√©phone);

            if (updateError) {
              console.error("Erreur update tableData1_fran:", updateError);
            }
          } else {
            // Sinon ‚Üí INSERT
            const { error: insertError2 } = await supabase
              .from("tableData1_fran")
              .insert([{
                T√©l√©phone: eventToDuplicate.T√©l√©phone,
                Nom: eventToDuplicate.Nom,
                Date: newDate,
                Heure: newHeure,
                Min: newMin,
                Lieu: eventToDuplicate.Lieu,
                Prix: eventToDuplicate.Prix,
                Travail: eventToDuplicate.Travail,
                Observations: eventToDuplicate.Observations,
                Ajout√©_pour: newAjoutePour,
                env_donn√©es: eventToDuplicate.env_donn√©es,
                paiement: eventToDuplicate.paiement,
                pay√©: eventToDuplicate.pay√©,
                photo_avant_url: eventToDuplicate.photo_avant_url,
                photo_apres_url: eventToDuplicate.photo_apres_url
              }]);

            if (insertError2) {
              console.error("Erreur insert tableData1_fran:", insertError2);
            }
          }

          if (!insertError1) {
              console.log("√âv√©nement dupliqu√©:", newEvent);

              // ‚úÖ Ins√©rer dans historique_modif_fran
              const { error: histError } = await supabase
                .from("historique_modif_fran")
                .insert([{
                  user_id: newUserId,
                  modifi√©_par: localStorage.getItem("currentPersonName") || "Syst√®me",
                  action: "Ajout",
                  champ_modifi√©: null,
                  valeur_ancienne: null,
                  valeur_nouvelle: "Ajout de l'√©v√©nement (duplication)",
                  date_modification: new Date().toISOString()
                }]);

              if (histError) {
                console.error("Erreur insertion historique (duplication):", histError);
              } else {
                console.log("Historique enregistr√© pour la duplication");
              }
            }


          document.getElementById("duplicateModal").style.display = "none";

          // Recharger la table
          fetchEventsByDate(newDate);
        });

// ----------------------------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------------------------

        function colorierDatesAvecEvenements(evenements) {
            // Nettoyer les anciennes couleurs
            document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('highlight'));

            // Pour chaque √©v√©nement trouv√© ‚Üí surligner sa date
            evenements.forEach(evt => {
                const cell = document.querySelector(`[data-date="${evt.Date}"]`);
                if (cell) {
                    cell.classList.add('highlight');
                }
            });
        }

        function attacherClickSurDates(evenements) {
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.addEventListener('click', () => {
                    const date = day.getAttribute('data-date');
                    const evtForDay = evenements.filter(evt => evt.Date === date);

                    // üî• On appelle maintenant directement fetchEventsByDate
                    if (evtForDay.length > 0) {
                        fetchEventsByDate(date, evtForDay); // passe les r√©sultats filtr√©s
                    } else {
                        fetchEventsByDate(date); // fallback si rien
                    }
                });
            });
        }


        // Recherche globale client/lieu
        document.getElementById('search-global').addEventListener('input', async function (e) {
            const searchText = e.target.value.trim();
            currentSearchFilter = searchText;

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            if (searchText.length < 2) {
                evenementsRecherche = null;
                generateCalendar(currentMonth, currentYear);
                return;
            }

            const { data: evenementsTrouves, error } = await supabase
                .from('event_quot1_fran')
                .select('*')
                .or(`Nom.ilike.%${searchText}%,Lieu.ilike.%${searchText}%`);

            evenementsRecherche = evenementsTrouves;

            // ‚úÖ GARDER UN SEUL APPEL (supprimer le doublon en bas)
            generateCalendar(currentMonth, currentYear, evenementsTrouves);

            console.log("üîé Recherche Supabase :", searchText, { evenementsTrouves, error });

            if (error) {
                console.error("Erreur lors de la recherche :", error);
                return;
            }

            // ‚ùå SUPPRIMER CETTE LIGNE DUPLIQU√âE :
            // generateCalendar(currentMonth, currentYear, evenementsTrouves);
        });

        // --------------------------------------------------------------------------------

        // === Tri colonne Ajout√©_pour ===
        let currentSort = { column: null, asc: true };

        function sortTableByColumn(column) {
            const table = document.querySelector("#editable-table tbody"); // ‚úÖ correction ici
            if (!table) return;

            const rows = Array.from(table.querySelectorAll("tr"));

            let asc = true;
            if (currentSort.column === column) {
                asc = !currentSort.asc; // inverse si on reclique
            }

            rows.sort((a, b) => {
                let valA = a.querySelector(`[data-column="${column}"]`)?.innerText.trim() || "";
                let valB = b.querySelector(`[data-column="${column}"]`)?.innerText.trim() || "";
                return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
            });

            rows.forEach(row => table.appendChild(row)); // r√©injecte tri√©
            currentSort = { column, asc };
        }

        // Brancher le clic sur l‚Äôen-t√™te Ajout√©_pour
        document.addEventListener("DOMContentLoaded", () => {
            const thAjoutePour = document.querySelector('th[data-column="Ajout√©_pour"]');
            if (thAjoutePour) {
                thAjoutePour.addEventListener("click", () => sortTableByColumn("Ajout√©_pour"));
            }
        });

        window.addEventListener('online', syncData);




    </script>
</head>

<body>
    <div class="background-image"></div>
    <div id="temporaryMessage" style="display: none; position: fixed; top: 10px; right: 10px; background: #66D19E; color: white; padding: 10px; border-radius: 5px; z-index: 1000;"></div>
    <div class="welcome-message" id="welcome-message"></div>
    <div class="main-container">
        <h1 data-i18n="calendar_agenda_heading">Calendrier et Agenda</h1>
        <div class="navigation-container">
            <button id="prevButton" class="button" data-i18n="button_previous">Pr√©c√©dent</button>
            <span id="monthYear"></span>
            <button id="nextButton" class="button" data-i18n="button_next">Suivant</button>
            <!-- üîç Champ de recherche globale (client / lieu) -->
            <div id="searchContainer">
              <label for="search-global" data-i18n="label_search">Recherche :</label>
              <input
                  type="text"
                  id="search-global"
                  placeholder="Nom client ou lieu..."
                  data-i18n-placeholder="placeholder_search">
            </div>
        </div>
        <div id="meteo-widget">
            <div class="meteo-top-section">
                <h2 data-i18n="meteo_conditions_heading">Conditions m√©t√©o (<span id="meteo-date-short"></span>)</h2>
                <p id="meteo-location"></p>
            </div>

            <div class="meteo-main-columns">
                <div class="meteo-text-column">
                    <p><strong data-i18n="meteo_conditions_label">Conditions</strong> : <span id="meteo-condition"></span></p>
                    <p><strong data-i18n="meteo_max_temp_label">Temp. Max</strong> : <span id="meteo-max-temp"></span>¬∞C</p>
                    <p><strong data-i18n="meteo_rain_chance_label">Probabilit√© de pluie</strong> : <span id="meteo-chance-rain"></span>%</p>
                </div>
                <div class="meteo-image-column">
                    <img id="meteo-icon" src="" alt="Ic√¥ne m√©t√©o">
                </div>
            </div>

            <p id="meteo-error" style="color: red;"></p>
        </div>
        <div class="calendar-container">
            <table id="calendarTable">
                <tr>
                    <th data-i18n="day_mon_short">Lu</th>
                    <th data-i18n="day_tue_short">Ma</th>
                    <th data-i18n="day_wed_short">Me</th>
                    <th data-i18n="day_thu_short">Je</th>
                    <th data-i18n="day_fri_short">Ve</th>
                    <th data-i18n="day_sat_short">Sa</th>
                    <th data-i18n="day_sun_short">Di</th>
                </tr>
                <tr>
                    <td id="day_2024-11-06" class="calendar-day-note" onclick="openEditModal('2024-11-06')" data-i18n="click_to_add_note">Cliquez pour ajouter une note</td>
                    </tr>
            </table>
        </div>
        <div id="editNoteModal" class="daily-note-modal">
            <div class="daily-note-modal-content">
                <h2><span data-i18n="prefix_notes_for">Notes pour le</span> <span id="modalDate"></span></h2>

                <div class="note-type-buttons">
                  <button id="normalNoteBtn" data-i18n="normalNoteBtn" class="note-type-btn active">
                    Note Normale
                  </button>
                  <button id="manualNoteBtn" data-i18n="manualNoteBtn" class="note-type-btn">
                    Note Manuscrite
                  </button>
                  <button id="todoListBtn" data-i18n="todoListBtn" class="note-type-btn">
                    To-do Liste
                  </button>
                </div>


                <div id="noteContentContainer">
                    <textarea id="noteText" placeholder="Ajouter les notes journali√®res ici..." data-i18n-placeholder="placeholder_add_daily_notes"></textarea>

                    <div id="manualNoteModal" class="drawing-modal-background" style="display:none;">
                        <div class="drawing-modal-content">
                            <div class="drawing-toolbar">
                                <button id="pencilBtn" class="tool-btn active">‚úèÔ∏è</button>
                                <button id="eraserBtn" class="tool-btn">üßΩ</button>
                                <span class="toolbar-separator"></span>
                                <input type="range" id="lineWidthSlider" min="1" max="20" value="2">
                                <span class="toolbar-separator"></span>
                                <div id="colorPalette">
                                    <button class="color-btn active" style="background-color: #000000;"></button>
                                    <button class="color-btn" style="background-color: #ff0000;"></button>
                                    <button class="color-btn" style="background-color: #0000ff;"></button>
                                    <button class="color-btn" style="background-color: #00ff00;"></button>
                                    <button class="color-btn" style="background-color: #ffff00;"></button>
                                    <button class="color-btn" style="background-color: #ffffff; border: 1px solid #ccc;"></button>
                                </div>
                                <span class="toolbar-separator"></span>
                                <button id="undoBtn" class="tool-btn">‚ü≤</button>
                                <button id="redoBtn" class="tool-btn">‚ü≥</button>
                            </div>
                            <canvas id="noteCanvas" width="800" height="600"></canvas>
                            <div class="modal-footer">
                              <button id="saveDrawingBtn" data-i18n="drawing_save_close"></button>
                              <button id="closeDrawingBtn" data-i18n="drawing_close_without_save"></button>
                            </div>
                        </div>
                    </div>

                    <div id="todoListContainer" style="display: none;">
                      <ul id="todoList"></ul>
                      <input
                        type="text"
                        id="newTodoItem"
                        placeholder=""
                        data-i18n-placeholder="todo_placeholder"
                      />
                      <button id="addTodoBtn" data-i18n="todo_add_btn"></button>
                    </div>
                </div>

                <button id="saveNoteButton" data-i18n="button_save">Enregistrer</button>
            </div>
        </div>
        <div class="editable-container">
            <table id="editable-table">
                <thead>
                    <tr>
                        <th id="header-telephone" data-i18n="table_header_phone">T√©l√©phone</th>
                        <th data-i18n="table_header_name">Nom</th>
                        <th data-i18n="table_header_date">Date</th>
                        <th data-i18n="table_header_time">Heure</th>
                        <th data-i18n="table_header_min">Min</th>
                        <th data-i18n="table_header_location">Lieu</th>
                        <th id="header-prix" data-i18n="table_header_price">Prix</th>
                        <th data-i18n="table_header_work">Travail</th>
                        <th data-i18n="table_header_observations">Observations</th>
                        <th data-i18n="table_header_added_for" data-column="Ajout√©_pour">
                          Ajout√©_pour
                        </th>
                        <th id="header-user-id" data-i18n="table_header_user_id">user_id</th>
                        <th id="header-paiement" data-i18n="table_header_billing">Facturation</th>
                        <th id="pointage">Pointage</th>
                        <th data-i18n="table_header_action">Action</th>

                    </tr>
                </thead>
                <tbody id="eventRows">
                    </tbody>
            </table>
        </div>
        <div id="paiementModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
            <div style="position:relative; width:80%; height:80%; margin:5% auto; background:white;">
                <iframe id="paiementIframe" src="" style="width:100%; height:100%;"></iframe>
                <button id="closeModal" style="position:absolute; top:10px; right:10px;" data-i18n="button_close">Fermer</button>
            </div>
        </div>
        <div class="form-wrapper">
            <div class="form-container">
                <h2 data-i18n="new_event_heading">Nouvel √©v√©nement</h2>
                <input type="text" id="T√©l√©phone" placeholder="T√©l√©phone" data-i18n-placeholder="placeholder_phone">
                <input type="text" id="Nom" placeholder="Nom" data-i18n-placeholder="placeholder_name">
                <input type="date" id="Date">
                <select id="Heure">
                    <option value="7h">7h</option>
                    <option value="8h">8h</option>
                    <option value="9h">9h</option>
                    <option value="10h">10h</option>
                    <option value="11h">11h</option>
                    <option value="12h">12h</option>
                    <option value="13h">13h</option>
                    <option value="14h">14h</option>
                    <option value="15h">15h</option>
                    <option value="16h">16h</option>
                    <option value="17h">17h</option>
                    <option value="18h">18h</option>
                    <option value="19h">19h</option>
                    <option value="20h">20h</option>
                    <option value="21h">21h</option>
                    <option value="Autre" data-i18n="option_other">Autre</option>
                </select>
                <input type="number" id="Min" placeholder="Min" data-i18n-placeholder="placeholder_min">
                <input type="text" id="Lieu" placeholder="Lieu" data-i18n-placeholder="placeholder_location">
                <input type="number" id="Prix" placeholder="Prix" data-i18n-placeholder="placeholder_price">


                <select id="Travail" name="Travail"
                        style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box;">
                    <option value="" selected data-i18n="select_job_status">-- S√©lectionner le travail --</option>
                    <option value="Lavage de vitres">
                        Lavage de vitres
                    </option>
                    <option value="Nettoyage de locaux">
                        Nettoyage de locaux
                    </option>
                    <option value="Nettoyage apr√®s chantier">
                        Nettoyage apr√®s chantier
                    </option>
                    <option value="Nettoyage de panneaux photovolta√Øques">
                        Nettoyage de panneaux photovolta√Øques
                    </option>
                    <option value="Lutte contre les nuisibles">
                        Lutte contre les nuisibles
                    </option>
                    <option value="Autre : Voir Observations">
                        Autre : Voir Observations
                    </option>
                </select>
                <!-- Ajoutez cette section apr√®s le select Travail -->
                <div class="form-group">
                    <select id="employeSelect" class="form-control">
                        <option value="">-- S√©lectionner un employ√© --</option>
                        <!-- Les options seront ajout√©es dynamiquement par JavaScript -->
                    </select>
                </div>



                <!-- Bloc pour r√©currence -->
                <div id="recurrence-section">
                  <h3 data-i18n="recurrence_title">R√©currence</h3>

                  <label for="recurrence-frequency" data-i18n="recurrence_frequency">Fr√©quence :</label>
                  <select id="recurrence-frequency">
                    <option value="none" selected data-i18n="recurrence_none">Aucune</option>
                    <option value="daily" data-i18n="recurrence_daily">Quotidienne</option>
                    <option value="weekly" data-i18n="recurrence_weekly">Hebdomadaire</option>
                    <option value="monthly" data-i18n="recurrence_monthly">Mensuelle</option>
                    <option value="yearly" data-i18n="recurrence_yearly">Annuelle</option>
                  </select>

                  <div id="weekly-options" style="display:none; margin-top:10px;">
                      <span data-i18n="recurrence_days">Jours :</span>
                      <div class="weekly-grid">
                        <div class="column">
                          <label><span data-i18n="day_monday">Lundi</span><input type="checkbox" value="monday"></label>
                          <label><span data-i18n="day_tuesday">Mardi</span><input type="checkbox" value="tuesday"></label>
                          <label><span data-i18n="day_wednesday">Mercredi</span><input type="checkbox" value="wednesday"></label>
                          <label><span data-i18n="day_thursday">Jeudi</span><input type="checkbox" value="thursday"></label>
                        </div>
                        <div class="column">
                          <label><span data-i18n="day_friday">Vendredi</span><input type="checkbox" value="friday"></label>
                          <label><span data-i18n="day_saturday">Samedi</span><input type="checkbox" value="saturday"></label>
                          <label><span data-i18n="day_sunday">Dimanche</span><input type="checkbox" value="sunday"></label>
                        </div>
                      </div>
                    </div>

                  <div id="monthly-options" style="display:none; margin-top:10px;">
                    <label data-i18n="recurrence_day_of_month">Jour du mois :</label>
                    <input type="number" id="recurrence-dayOfMonth" min="1" max="31">
                  </div>

                  <div id="yearly-options" style="display:none; margin-top:10px;">
                    <label data-i18n="recurrence_month">Mois :</label>
                    <input type="number" id="recurrence-month" min="1" max="12">
                    <label data-i18n="recurrence_day">Jour :</label>
                    <input type="number" id="recurrence-day" min="1" max="31">
                  </div>

                  <label for="recurrence-endDate" data-i18n="recurrence_end">Jusqu‚Äôau :</label>
                  <input type="date" id="recurrence-endDate">
                </div>


                <button id="addEventButton" class="button" data-i18n="button_add_event">Ajouter un √©v√©nement</button>

            </div>

            <div id="permanentNotesContainer">
                <h3 data-i18n="permanent_info_heading">Informations permanentes</h3>
                <textarea id="permanentNotes" placeholder="Ecrit les informations ici..." data-i18n-placeholder="placeholder_write_info_here"></textarea>
                <button id="savePermanentNotesButton" data-i18n="button_save">Enregistrer</button>
            </div>
        </div>
        <div id="successMessage" class="hidden" data-i18n="message_saved">Sauvegard√©</div>
        <div id="confirmationPopup" class="popup">
            <div class="popup-content">
                <p data-i18n="popup_are_you_sure">Es-tu s√ªr?</p>
                <button id="confirmYes" class="button" data-i18n="button_yes">Oui</button>
                <button id="confirmNo" class="button" data-i18n="button_no">Non</button>
            </div>
        </div>

    </div>
    <div id="popup5" class="popup">
      <div class="popup-content">
        <p data-i18n="popup_recurrence_question">
          ‚ö†Ô∏è Cet √©v√©nement fait partie d'une s√©rie r√©currente.<br>
          Que voulez-vous faire ?
        </p>
        <button id="deleteSeriesBtn" data-i18n="button_delete_series">üóëÔ∏è Supprimer toute la s√©rie</button>
        <button id="deleteOneBtn" data-i18n="button_delete_one">‚ùå Supprimer seulement cet √©v√©nement</button>
        <button id="cancelBtn" data-i18n="button_cancel">Annuler</button>
      </div>
    </div>
    <div id="popup6">
      <div class="popup-content" tabindex="0">
        <h3 data-i18n="apply_change_question">Voulez-vous appliquer ce changement ?</h3>
        <div id="popup6-options">
          <div class="popup-option selected" data-action="one" data-i18n="apply_one_event">
            ‚úÖ Seulement √† cet √©v√©nement
          </div>
          <div class="popup-option" data-action="series" data-i18n="apply_series">
            üìÖ √Ä toute la s√©rie
          </div>

        </div>
      </div>
    </div>





    <div id="lightbox" class="lightbox">
      <span class="lightbox-close">&times;</span>
      <img class="lightbox-content" id="lightbox-img">
    </div>
    <!-- Modal Duplication -->
    <div id="duplicateModal" class="duplicate-modal hidden">
      <div class="duplicate-modal-content">
        <h3>üìÖ Dupliquer l‚Äô√©v√©nement</h3>

        <label for="dupDate">Nouvelle date</label>
        <input type="date" id="dupDate">

        <label for="dupTime">Nouvelle heure (HH)</label>
        <input type="number" id="dupTime" min="0" max="23" placeholder="HH">

        <label for="dupMin">Dur√©e (min)</label>
        <input type="number" id="dupMin" min="0" max="59" placeholder="MM">

        <label for="dupAjoutePour">Ajout√© pour</label>
        <select id="dupAjoutePour"></select>

        <div class="duplicate-modal-actions">
          <button id="dupConfirm" class="btn btn-primary">‚úÖ OK</button>
          <button id="dupCancel" class="btn btn-cancel">‚ùå Annuler</button>
        </div>
      </div>
    </div>
    <div id="loading-indicator" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2000; text-align:center;">
      <div class="spinner"></div>
      <div data-i18n="loading_recurrence">Calcul des dates r√©currentes...</div>
    </div>







</body>
</html>